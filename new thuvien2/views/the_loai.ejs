<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Thể Loại</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/theloai.css" />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
          <a class="navbar-brand" href="/admin">
            <i class="bi bi-tags me-2"></i>Quản lý Thể Loại
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navMain"
            aria-controls="navMain"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/admin">
                  <i class="bi bi-house-door me-1"></i>Trang chủ
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/thu_vien">
                  <i class="bi bi-building me-1"></i>Thư viện
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/admin/the_loai">
                  <i class="bi bi-tags me-1"></i>Thể loại
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/sach">
                  <i class="bi bi-book me-1"></i>Sách
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/muon_sach">
                  <i class="bi bi-journal-text me-1"></i>Mượn sách
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/don_hang">
                  <i class="bi bi-cart-check me-1"></i>Đơn hàng
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/shop">
                  <i class="bi bi-shop me-1"></i>Cửa hàng
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/">
                  <i class="bi bi-geo-alt-fill me-1"></i>Xem bản đồ
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container py-4">
      <!-- Error and Success Messages -->
      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= error %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %> <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <%= success %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %>

      <!-- Form thêm thể loại -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>Thêm Thể Loại Mới
          </h5>
        </div>
        <div class="card-body">
          <form
            method="POST"
            action="/admin/the_loai/add"
            onsubmit="return validateForm()"
          >
            <div class="row g-3">
              <div class="col-md-4">
                <label for="ID_theloai" class="form-label">ID Thể Loại</label>
                <input
                  type="number"
                  name="ID_theloai"
                  id="ID_theloai"
                  class="form-control"
                  placeholder="Nhập ID thể loại"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="Ten_theloai" class="form-label">Tên Thể Loại</label>
                <input
                  type="text"
                  name="Ten_theloai"
                  id="Ten_theloai"
                  class="form-control"
                  placeholder="Nhập tên thể loại"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="ID_thuvien" class="form-label">ID Thư Viện</label>
                <input
                  type="number"
                  name="ID_thuvien"
                  id="ID_thuvien"
                  class="form-control"
                  placeholder="Nhập ID thư viện"
                  required
                />
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-plus-circle me-2"></i>Thêm Thể Loại
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Danh sách thể loại -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>Danh Sách Thể Loại
          </h5>
        </div>
        <div class="card-body">
          <% if (!theLoai || theLoai.length === 0) { %>
          <div class="alert alert-info text-center">
            <h6 class="mb-2">Không có thể loại nào trong danh sách</h6>
            <p class="mb-3">Bảng có thể trống hoặc có lỗi kết nối database</p>
            <div class="d-flex gap-2 justify-content-center">
              <button onclick="testDatabase()" class="btn btn-outline-primary">
                <i class="bi bi-database me-2"></i>Kiểm tra Database
              </button>
              <button
                onclick="createDemoData()"
                class="btn btn-outline-success"
              >
                <i class="bi bi-plus-circle me-2"></i>Tạo Demo Data
              </button>
            </div>
          </div>
          <% } else { %>
          <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Tên Thể Loại</th>
                  <th>Thư Viện</th>
                  <th class="text-end">Hành Động</th>
                </tr>
              </thead>
              <tbody>
                <% theLoai.forEach(function(item) { %>
                <tr>
                  <td><strong><%= item.id_theloai %></strong></td>
                  <td><%= item.ten_theloai %></td>
                  <td><%= item.ten_thuvien %></td>
                  <td class="text-end">
                    <div class="d-flex gap-2 justify-content-end">
                      <a
                        href="/admin/the_loai/update/<%= item.id_theloai %>"
                        class="btn btn-sm btn-outline-primary"
                      >
                        <i class="bi bi-pencil me-1"></i>Sửa
                      </a>
                      <form
                        method="POST"
                        action="/admin/the_loai/delete/<%= item.id_theloai %>"
                        class="d-inline"
                        onsubmit="return confirm('Bạn có chắc chắn muốn xóa thể loại này?')"
                      >
                        <button type="submit" class="btn btn-sm btn-danger">
                          <i class="bi bi-trash me-1"></i>Xóa
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <% } %>
        </div>
      </div>
    </main>

    <script>
      // Function để test database
      async function testDatabase() {
        try {
          const response = await fetch("/admin/the_loai/test-data");
          const data = await response.json();

          if (data.the_loai) {
            alert(
              `Database OK!\nBảng The_loai: ${data.the_loai.count} bản ghi\nBảng thu_vien: ${data.thu_vien.count} bản ghi`
            );
            console.log("Database test result:", data);
          } else {
            alert(`Database Error: ${data.error}`);
            console.error("Database test failed:", data);
          }
        } catch (error) {
          alert(`Lỗi kết nối: ${error.message}`);
          console.error("Test failed:", error);
        }
      }

      // Function để tạo dữ liệu demo
      async function createDemoData() {
        try {
          const response = await fetch("/admin/the_loai/create-demo");
          const data = await response.json();

          if (data.success) {
            alert(
              `Tạo dữ liệu demo thành công!\nĐã tạo: ${data.created_categories} thể loại\nThư viện ID: ${data.thuvien_id}`
            );
            console.log("Demo data created:", data);
            // Reload page to show new data
            window.location.reload();
          } else {
            alert(`Tạo dữ liệu demo thất bại: ${data.message}`);
            console.error("Demo data creation failed:", data);
          }
        } catch (error) {
          alert(`Lỗi kết nối khi tạo dữ liệu demo: ${error.message}`);
          console.error("Demo data creation failed:", error);
        }
      }

      // Form validation
      function validateForm() {
        const idTheloai = document.getElementById("ID_theloai").value;
        const tenTheloai = document.getElementById("Ten_theloai").value;
        const idThuvien = document.getElementById("ID_thuvien").value;

        if (!idTheloai || !tenTheloai || !idThuvien) {
          alert("Vui lòng điền đầy đủ thông tin!");
          return false;
        }

        if (idTheloai <= 0) {
          alert("ID thể loại phải là số dương!");
          return false;
        }

        if (idThuvien <= 0) {
          alert("ID thư viện phải là số dương!");
          return false;
        }

        if (tenTheloai.trim().length < 2) {
          alert("Tên thể loại phải có ít nhất 2 ký tự!");
          return false;
        }

        return true;
      }

      // Log debug info khi page load
      console.log("Page loaded successfully");
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
