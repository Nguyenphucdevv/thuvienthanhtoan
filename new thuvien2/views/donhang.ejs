<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Đơn Hàng</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/donhang.css" />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
          <a class="navbar-brand" href="/admin">Quản lý Đơn Hàng</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navMain"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/admin">Trang chủ</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/sach">Sách</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/admin/don_hang">Đơn hàng</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/shop">Cửa hàng</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container py-4">
      <!-- Messages -->
      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle me-2"></i><%= error %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %> <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle me-2"></i><%= success %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %>

      <!-- Tabs Navigation -->
      <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
            <i class="bi bi-cart3 me-2"></i>Đơn Hàng
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="qr-config-tab" data-bs-toggle="tab" data-bs-target="#qr-config" type="button" role="tab">
            <i class="bi bi-qr-code me-2"></i>Cấu Hình QR Thanh Toán
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="mainTabContent">
        <!-- Tab Đơn Hàng -->
        <div class="tab-pane fade show active" id="orders" role="tabpanel">

        <!-- Thống kê -->
        <div class="row mb-4">
        <% let tongDonHang = 0; let choxacnhan = 0; let daxacnhan = 0; let
        dangchuanbi = 0; let danggiao = 0; let dagiao = 0; let dahuy = 0; let
        tongDoanhThu = 0; if (thongKe && thongKe.length > 0) {
        thongKe.forEach(tk => { const soLuong = parseInt(tk.so_luong) || 0;
        const doanhThu = parseFloat(tk.tong_doanh_thu) || 0; tongDonHang +=
        soLuong; tongDoanhThu += doanhThu; if (tk.trang_thai === 'Chờ xác nhận')
        choxacnhan = soLuong; if (tk.trang_thai === 'Đã xác nhận') daxacnhan =
        soLuong; if (tk.trang_thai === 'Đang chuẩn bị') dangchuanbi = soLuong;
        if (tk.trang_thai === 'Đang giao hàng') danggiao = soLuong; if
        (tk.trang_thai === 'Đã giao') dagiao = soLuong; if (tk.trang_thai ===
        'Đã hủy') dahuy = soLuong; }); } %>

          <div class="col-md-3">
            <div class="stats-card">
              <h3 class="text-primary"><%= tongDonHang %></h3>
              <p><i class="bi bi-cart3"></i> Tổng đơn hàng</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <h3 class="text-warning"><%= choxacnhan %></h3>
              <p><i class="bi bi-clock"></i> Chờ xác nhận</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <h3 class="text-info"><%= danggiao %></h3>
              <p><i class="bi bi-truck"></i> Đang giao</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <h3 class="text-success">
                <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency:
                'VND', maximumFractionDigits: 0 }).format(tongDoanhThu) %>
              </h3>
              <p><i class="bi bi-cash"></i> Tổng doanh thu</p>
            </div>
          </div>
        </div>

        <!-- Bộ lọc -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Lọc theo trạng thái</label>
                <select class="form-select" id="filter-status">
                  <option value="">Tất cả</option>
                  <option value="Chờ xác nhận">Chờ xác nhận</option>
                  <option value="Chờ thanh toán">Chờ thanh toán</option>
                  <option value="Đã xác nhận">Đã xác nhận</option>
                  <option value="Đang chuẩn bị">Đang chuẩn bị</option>
                  <option value="Đang giao hàng">Đang giao hàng</option>
                  <option value="Đã giao">Đã giao</option>
                  <option value="Đã hủy">Đã hủy</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tìm kiếm</label>
                <input
                  type="text"
                  class="form-control"
                  id="search-input"
                  placeholder="Tìm theo tên khách hàng, SĐT..."
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Sắp xếp</label>
                <select class="form-select" id="sort-select">
                  <option value="newest">Mới nhất</option>
                  <option value="oldest">Cũ nhất</option>
                  <option value="price-desc">Giá trị cao nhất</option>
                  <option value="price-asc">Giá trị thấp nhất</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Danh sách đơn hàng -->
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-list-ul me-2"></i>Danh Sách Đơn Hàng
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (!donHang || donHang.length === 0) { %>
            <div class="text-center py-5">
              <i class="bi bi-inbox display-1 text-muted"></i>
              <h5 class="mt-3">Chưa có đơn hàng nào</h5>
            </div>
            <% } else { %>
            <div class="table-responsive">
              <table
                class="table table-hover align-middle mb-0"
                id="orders-table"
              >
                <thead>
                  <tr>
                    <th>Mã ĐH</th>
                    <th>Khách hàng</th>
                    <th>Số điện thoại</th>
                    <th>Tổng tiền</th>
                    <th>Trạng thái</th>
                    <th>Ngày đặt</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  <% donHang.forEach(dh => { %>
                  <tr
                    class="order-row"
                    data-status="<%= dh.trang_thai %>"
                    data-customer="<%= dh.ten_khach_hang.toLowerCase() %>"
                    data-phone="<%= dh.so_dien_thoai %>"
                    data-price="<%= dh.tong_tien %>"
                    data-date="<%= new Date(dh.ngay_dat).getTime() %>"
                  >
                    <td><strong>#<%= dh.id_don_hang %></strong></td>
                    <td>
                      <div>
                        <strong><%= dh.ten_khach_hang %></strong>
                        <% if (dh.email) { %>
                        <br /><small class="text-muted"><%= dh.email %></small>
                        <% } %>
                      </div>
                    </td>
                    <td><%= dh.so_dien_thoai %></td>
                    <td>
                      <strong class="text-primary">
                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency',
                        currency: 'VND' }).format(dh.tong_tien) %>
                      </strong>
                      <br />
                      <small class="text-muted">
                        <%= dh.tong_so_luong_sach || 0 %> quyển
                      </small>
                    </td>
                    <td>
                      <span
                        class="badge badge-<%= dh.trang_thai.toLowerCase().replace(/ /g, '-') %>"
                      >
                        <%= dh.trang_thai %>
                      </span>
                    </td>
                    <td>
                      <%= new Date(dh.ngay_dat).toLocaleDateString('vi-VN') %>
                      <br />
                      <small class="text-muted">
                        <%= new Date(dh.ngay_dat).toLocaleTimeString('vi-VN') %>
                      </small>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <a
                          href="/admin/don_hang/<%= dh.id_don_hang %>"
                          class="btn btn-sm btn-info"
                          title="Xem chi tiết"
                        >
                          <i class="bi bi-eye"></i>
                        </a>
                        <button
                          class="btn btn-sm btn-warning btn-update-order"
                          data-order-id="<%= dh.id_don_hang %>"
                          data-order-status="<%= dh.trang_thai %>"
                          title="Cập nhật trạng thái"
                        >
                          <i class="bi bi-pencil"></i>
                        </button>
                        <% if (dh.trang_thai === 'Chờ xác nhận' || dh.trang_thai
                        === 'Đã hủy') { %>
                        <form
                          method="POST"
                          action="/admin/don_hang/delete/<%= dh.id_don_hang %>"
                          style="display: inline"
                          onsubmit="return confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')"
                        >
                          <button
                            class="btn btn-sm btn-danger"
                            title="Xóa đơn hàng"
                          >
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                        <% } %>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </div>
        </div>
        </div>
        <!-- End Tab Đơn Hàng -->

        <!-- Tab Cấu Hình QR Thanh Toán -->
        <div class="tab-pane fade" id="qr-config" role="tabpanel">
          <div class="row">
            <div class="col-md-8">
              <!-- Danh sách QR Code đã cấu hình -->
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                    <i class="bi bi-qr-code-scan me-2"></i>Danh Sách QR Code
                  </h5>
                  <button class="btn btn-primary btn-sm" onclick="showAddQRForm()">
                    <i class="bi bi-plus-circle me-1"></i>Thêm Mới
                  </button>
                </div>
                <div class="card-body" id="qr-list-container">
                  <% if (qrConfigs && qrConfigs.length > 0) { %>
                    <div class="row">
                      <% qrConfigs.forEach(config => { %>
                        <div class="col-md-6 mb-3">
                          <div class="card border">
                            <div class="card-body">
                              <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">
                                  <%= config.payment_method %>
                                  <% if (config.is_active) { %>
                                    <span class="badge bg-success ms-2">Đang sử dụng</span>
                                  <% } %>
                                </h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="editQRConfig('<%= config.payment_method %>')">
                                  <i class="bi bi-pencil"></i>
                                </button>
                              </div>
                              <% if (config.qr_image) { %>
                                <img src="<%= config.qr_image %>" class="img-fluid mb-2" style="max-height: 150px;" alt="QR Code">
                              <% } else { %>
                                <div class="text-center bg-light p-3 mb-2">
                                  <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                </div>
                              <% } %>
                              <% if (config.account_number) { %>
                                <p class="mb-1 small"><strong>STK:</strong> <%= config.account_number %></p>
                              <% } %>
                              <% if (config.account_name) { %>
                                <p class="mb-1 small"><strong>Chủ TK:</strong> <%= config.account_name %></p>
                              <% } %>
                              <% if (config.bank_name) { %>
                                <p class="mb-0 small"><strong>Ngân hàng:</strong> <%= config.bank_name %></p>
                              <% } %>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-5">
                      <i class="bi bi-qr-code display-1 text-muted"></i>
                      <h5 class="mt-3">Chưa có QR Code nào</h5>
                      <p class="text-muted">Nhấn "Thêm Mới" để tạo QR Code thanh toán</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <!-- Form cấu hình QR Code -->
              <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0" id="qr-form-title">
                    <i class="bi bi-plus-circle me-2"></i>Thêm QR Code Mới
                  </h5>
                </div>
                <div class="card-body">
                  <form id="qr-config-form" enctype="multipart/form-data">
                    <div class="mb-3">
                      <label class="form-label">Phương thức thanh toán <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" name="payment_method" id="payment_method" 
                             placeholder="VD: Chuyển khoản ngân hàng, Ví MoMo" required>
                      <small class="text-muted">Tên phương thức thanh toán</small>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Ảnh QR Code</label>
                      <input type="file" class="form-control" name="qr_image" id="qr_image" accept="image/*">
                      <small class="text-muted">Upload ảnh QR code thanh toán</small>
                      <div id="qr-preview" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Số tài khoản</label>
                      <input type="text" class="form-control" name="account_number" id="account_number" 
                             placeholder="VD: 0123456789">
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Chủ tài khoản</label>
                      <input type="text" class="form-control" name="account_name" id="account_name" 
                             placeholder="VD: NGUYEN VAN A">
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Ngân hàng</label>
                      <input type="text" class="form-control" name="bank_name" id="bank_name" 
                             placeholder="VD: Vietcombank, MoMo">
                    </div>

                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="is_active" value="true" checked>
                        <label class="form-check-label" for="is_active">
                          Đang sử dụng
                        </label>
                      </div>
                    </div>

                    <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Lưu Cấu Hình
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="resetQRForm()">
                        <i class="bi bi-x-circle me-1"></i>Hủy
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End Tab Cấu Hình QR -->
      </div>
    </main>

    <!-- Modal cập nhật trạng thái -->
    <div class="modal fade" id="updateModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="update-form" method="POST">
            <div class="modal-header">
              <h5 class="modal-title">Cập Nhật Trạng Thái Đơn Hàng</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <!-- Hiển thị ảnh minh chứng nếu có -->
              <div id="payment-proof-container" style="display: none;">
                <div class="alert alert-info">
                  <h6 class="alert-heading">
                    <i class="bi bi-image me-2"></i>Ảnh Minh Chứng Chuyển Khoản
                  </h6>
                  <div class="text-center mt-3">
                    <img id="payment-proof-image" src="" alt="Ảnh minh chứng" 
                         class="img-fluid border rounded" style="max-height: 300px; cursor: pointer;"
                         onclick="window.open(this.src, '_blank')">
                    <p class="mb-0 mt-2 small text-muted">
                      <i class="bi bi-info-circle me-1"></i>Nhấn vào ảnh để xem kích thước đầy đủ
                    </p>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Trạng thái mới</label>
                <select name="trang_thai" class="form-select" required>
                  <option value="Chờ xác nhận">Chờ xác nhận</option>
                  <option value="Chờ thanh toán">Chờ thanh toán</option>
                  <option value="Đã xác nhận">Đã xác nhận</option>
                  <option value="Đang chuẩn bị">Đang chuẩn bị</option>
                  <option value="Đang giao hàng">Đang giao hàng</option>
                  <option value="Đã giao">Đã giao</option>
                  <option value="Đã hủy">Đã hủy</option>
                </select>
              </div>
              <div class="mb-3" id="cancel-reason-group" style="display: none">
                <label class="form-label">Lý do hủy</label>
                <textarea
                  name="ly_do_huy"
                  class="form-control"
                  rows="2"
                  placeholder="Nhập lý do hủy đơn hàng..."
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Ghi chú</label>
                <textarea
                  name="ghi_chu"
                  class="form-control"
                  rows="2"
                  placeholder="Ghi chú thêm (không bắt buộc)..."
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Hủy
              </button>
              <button type="submit" class="btn btn-primary">Cập nhật</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Filter và search
      const filterStatus = document.getElementById("filter-status");
      const searchInput = document.getElementById("search-input");
      const sortSelect = document.getElementById("sort-select");
      const table = document.getElementById("orders-table");

      if (filterStatus && searchInput && sortSelect && table) {
        filterStatus.addEventListener("change", filterOrders);
        searchInput.addEventListener("input", filterOrders);
        sortSelect.addEventListener("change", sortOrders);
      }

      function filterOrders() {
        const status = filterStatus.value.toLowerCase();
        const search = searchInput.value.toLowerCase();
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach((row) => {
          const rowStatus = row.dataset.status.toLowerCase();
          const customer = row.dataset.customer;
          const phone = row.dataset.phone;

          const matchStatus = !status || rowStatus === status;
          const matchSearch =
            !search || customer.includes(search) || phone.includes(search);

          row.style.display = matchStatus && matchSearch ? "" : "none";
        });
      }

      function sortOrders() {
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const sortValue = sortSelect.value;

        rows.sort((a, b) => {
          switch (sortValue) {
            case "newest":
              return parseInt(b.dataset.date) - parseInt(a.dataset.date);
            case "oldest":
              return parseInt(a.dataset.date) - parseInt(b.dataset.date);
            case "price-desc":
              return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
            case "price-asc":
              return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
            default:
              return 0;
          }
        });

        rows.forEach((row) => tbody.appendChild(row));
      }

      // Modal cập nhật trạng thái
      async function showUpdateModal(orderId, currentStatus) {
        const modal = new bootstrap.Modal(
          document.getElementById("updateModal")
        );
        const form = document.getElementById("update-form");
        const statusSelect = form.querySelector('select[name="trang_thai"]');
        const cancelReasonGroup = document.getElementById(
          "cancel-reason-group"
        );
        const paymentProofContainer = document.getElementById("payment-proof-container");
        const paymentProofImage = document.getElementById("payment-proof-image");

        form.action = `/admin/don_hang/update-status/${orderId}`;
        statusSelect.value = currentStatus;

        // Ẩn ảnh minh chứng mặc định
        paymentProofContainer.style.display = "none";

        // Lấy thông tin đơn hàng để kiểm tra có ảnh minh chứng không
        try {
          const response = await fetch(`/admin/don_hang/api/${orderId}`);
          const data = await response.json();
          
          if (data.success && data.donHang && data.donHang.payment_proof_image) {
            // Hiển thị ảnh minh chứng
            paymentProofImage.src = data.donHang.payment_proof_image;
            paymentProofContainer.style.display = "block";
          }
        } catch (error) {
          console.log('Không thể lấy thông tin đơn hàng:', error);
        }

        // Hiển thị/ẩn lý do hủy
        statusSelect.addEventListener("change", function () {
          if (this.value === "Đã hủy") {
            cancelReasonGroup.style.display = "block";
          } else {
            cancelReasonGroup.style.display = "none";
          }
        });

        // Trigger ngay lần đầu
        if (currentStatus === "Đã hủy") {
          cancelReasonGroup.style.display = "block";
        }

        modal.show();
      }

      // Gắn sự kiện cho nút cập nhật
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".btn-update-order").forEach((btn) => {
          btn.addEventListener("click", function () {
            const orderId = this.dataset.orderId;
            const orderStatus = this.dataset.orderStatus;
            showUpdateModal(orderId, orderStatus);
          });
        });
      });

      // ========================================
      // QUẢN LÝ QR CODE
      // ========================================

      // Preview ảnh QR khi chọn file
      document.getElementById('qr_image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('qr-preview');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-fluid border" style="max-height: 200px;" alt="Preview">`;
          };
          reader.readAsDataURL(file);
        } else {
          preview.innerHTML = '';
        }
      });

      // Hiện form thêm mới
      function showAddQRForm() {
        resetQRForm();
        document.getElementById('qr-form-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Thêm QR Code Mới';
      }

      // Reset form
      function resetQRForm() {
        document.getElementById('qr-config-form').reset();
        document.getElementById('qr-preview').innerHTML = '';
        document.getElementById('payment_method').removeAttribute('readonly');
      }

      // Edit QR Config
      async function editQRConfig(paymentMethod) {
        try {
          // Lấy thông tin config từ server
          const response = await fetch(`/admin/don_hang/qr-config`);
          const data = await response.json();
          
          if (data.success) {
            const config = data.configs.find(c => c.payment_method === paymentMethod);
            if (config) {
              // Fill form
              document.getElementById('payment_method').value = config.payment_method;
              document.getElementById('payment_method').setAttribute('readonly', 'readonly');
              document.getElementById('account_number').value = config.account_number || '';
              document.getElementById('account_name').value = config.account_name || '';
              document.getElementById('bank_name').value = config.bank_name || '';
              document.getElementById('is_active').checked = config.is_active;
              
              // Show preview image if exists
              if (config.qr_image) {
                document.getElementById('qr-preview').innerHTML = 
                  `<img src="${config.qr_image}" class="img-fluid border" style="max-height: 200px;" alt="Current QR">
                   <small class="d-block text-muted mt-1">QR hiện tại (upload ảnh mới để thay đổi)</small>`;
              }
              
              // Change form title
              document.getElementById('qr-form-title').innerHTML = 
                '<i class="bi bi-pencil me-2"></i>Chỉnh Sửa QR Code';
              
              // Scroll to form
              document.getElementById('qr-config-form').scrollIntoView({ behavior: 'smooth' });
            }
          }
        } catch (error) {
          console.error('Lỗi khi lấy thông tin QR:', error);
          alert('Không thể lấy thông tin QR Code!');
        }
      }

      // Submit form QR Config
      document.getElementById('qr-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Disable button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang lưu...';
        
        try {
          const response = await fetch('/admin/don_hang/qr-config', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('✅ ' + data.message);
            // Reload page để cập nhật danh sách
            window.location.reload();
          } else {
            alert('❌ ' + data.message);
          }
        } catch (error) {
          console.error('Lỗi khi lưu QR config:', error);
          alert('❌ Lỗi khi lưu cấu hình!');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
    </script>
  </body>
</html>
