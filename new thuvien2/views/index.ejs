<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫£n ƒë·ªì Th∆∞ vi·ªán - H·ªá th·ªëng Qu·∫£n l√Ω</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Pannellum CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"
    />
    <!-- Custom CSS -->
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/map.css" />
    <style>
      /* CSS cho panel ch·ªâ ƒë∆∞·ªùng */
      .route-info {
        position: fixed !important;
        top: 120px !important;
        left: 20px !important;
        right: auto !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 20px !important;
        border-radius: 15px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        z-index: 1000 !important;
        max-width: 350px !important;
        min-width: 320px !important;
        font-family: 'Inter', sans-serif !important;
        border: none !important;
        backdrop-filter: blur(10px) !important;
        animation: slideInLeft 0.5s ease-out !important;
      }

      @keyframes slideInLeft {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutLeft {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(-100%);
          opacity: 0;
        }
      }

      .route-info h6 {
        color: white !important;
        margin-bottom: 15px !important;
        font-size: 18px !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        border-bottom: 2px solid rgba(255,255,255,0.3) !important;
        padding-bottom: 10px !important;
      }

      .route-info h6 i {
        margin-right: 8px !important;
        font-size: 20px !important;
      }

      .route-info .info-item {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 12px !important;
        padding: 8px 12px !important;
        background: rgba(255,255,255,0.1) !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
      }

      .route-info .info-item:hover {
        background: rgba(255,255,255,0.2) !important;
        transform: translateX(5px) !important;
      }

      .route-info .info-item .label {
        font-weight: 500 !important;
        font-size: 14px !important;
        display: flex !important;
        align-items: center !important;
      }

      .route-info .info-item .label i {
        margin-right: 6px !important;
        font-size: 16px !important;
      }

      .route-info .info-item .value {
        font-weight: 600 !important;
        font-size: 14px !important;
        color: #ffd700 !important;
      }

      .route-info .time-estimates {
        background: rgba(255,255,255,0.15) !important;
        border-radius: 10px !important;
        padding: 12px !important;
        margin: 10px 0 !important;
      }

      .route-info .time-estimates h7 {
        color: #ffd700 !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        display: block !important;
        margin-bottom: 8px !important;
      }

      .route-info .time-item {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 6px !important;
        padding: 4px 0 !important;
      }

      .route-info .time-item:last-child {
        margin-bottom: 0 !important;
      }

      .route-info .time-item .transport-icon {
        width: 20px !important;
        height: 20px !important;
        margin-right: 8px !important;
        display: inline-block !important;
      }

      .route-info .time-item .transport-text {
        flex: 1 !important;
        font-size: 13px !important;
      }

      .route-info .time-item .time-value {
        font-weight: 600 !important;
        color: #ffd700 !important;
        font-size: 13px !important;
      }

      .route-info .action-buttons {
        display: flex !important;
        gap: 8px !important;
        margin-top: 15px !important;
      }

      .route-info .btn {
        flex: 1 !important;
        font-size: 12px !important;
        padding: 8px 12px !important;
        border-radius: 8px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
        border: none !important;
      }

      .route-info .btn-outline-danger {
        background: rgba(220, 53, 69, 0.2) !important;
        color: #ff6b6b !important;
        border: 1px solid #ff6b6b !important;
      }

      .route-info .btn-outline-danger:hover {
        background: #ff6b6b !important;
        color: white !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4) !important;
      }

      .route-info .btn-outline-primary {
        background: rgba(0, 123, 255, 0.2) !important;
        color: #74c0fc !important;
        border: 1px solid #74c0fc !important;
      }

      .route-info .btn-outline-primary:hover {
        background: #74c0fc !important;
        color: white !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(116, 192, 252, 0.4) !important;
      }

      /* Responsive cho mobile */
      @media (max-width: 768px) {
        .route-info {
          left: 10px !important;
          right: 10px !important;
          max-width: none !important;
          min-width: auto !important;
          top: 100px !important;
        }
      }

      /* Hi·ªáu ·ª©ng hover cho to√†n b·ªô panel */
      .route-info:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 15px 40px rgba(0,0,0,0.4) !important;
      }
    </style>
    
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">
          <i class="bi bi-geo-alt-fill me-2"></i>
          B·∫£n ƒë·ªì Th∆∞ vi·ªán <% if (user) { %>
          <small class="d-none d-md-inline ms-2">
            (<%= user.id_vaitro == 1 ? 'Admin' : (user.tai_khoan || 'Ng∆∞·ªùi d√πng') %>)
          </small>
          <% } %>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link fw-bold text-warning" href="/shop">
                <i class="bi bi-cart3 me-1"></i>C·ª≠a H√†ng S√°ch
              </a>
            </li>
            <% if (user && user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/admin/thu_vien">
                <i class="bi bi-building me-1"></i>Qu·∫£n l√Ω Th∆∞ vi·ªán
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin">
                <i class="bi bi-gear me-1"></i>Admin Panel
              </a>
            </li>
            <% } %>
            <li class="nav-item">
              <span class="nav-link">
                <i class="bi bi-person me-1"></i>Xin ch√†o, <%= user ?
                user.username : 'Kh√°ch' %>
              </span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout">
                <i class="bi bi-box-arrow-right me-1"></i>ƒêƒÉng xu·∫•t
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Welcome Message for Users -->
    <% if (user) { %>
    <div class="container-fluid mt-3">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 col-12">
          <div class="alert alert-info text-center border-0 shadow-sm">
            <i class="bi bi-person-circle me-2"></i>
            <strong>Xin ch√†o, <%= user.username %>!</strong>
            <% if (user.role === 'admin') { %> B·∫°n c√≥ quy·ªÅn truy c·∫≠p ƒë·∫ßy ƒë·ªß v√†o
            h·ªá th·ªëng qu·∫£n l√Ω. <% } else { %> B·∫°n c√≥ th·ªÉ xem b·∫£n ƒë·ªì th∆∞ vi·ªán v√†
            m∆∞·ª£n s√°ch.
            <strong>L∆∞u √Ω:</strong> Ch·ªâ admin m·ªõi c√≥ th·ªÉ truy c·∫≠p trang qu·∫£n l√Ω.
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <!-- Search Bar Bootstrap -->
    <div class="search-container">
      <div class="container-fluid">
        <div class="row justify-content-center">
          <div class="col-lg-8 col-md-10 col-12">
            <div class="search-card shadow-lg">
              <div class="row g-3 align-items-center">
                <div class="col-md-4">
                  <div class="input-group">
                    <span class="input-group-text bg-light border-0">
                      <i class="bi bi-search text-muted"></i>
                    </span>
                    <input
                      type="text"
                      id="main-search"
                      class="form-control border-0 shadow-none"
                      placeholder="Nh·∫≠p t√™n th∆∞ vi·ªán..."
                    />
                  </div>
                </div>
                <div class="col-md-8">
                  <div class="d-flex gap-2 flex-wrap">
                    <button id="filter-button" class="btn btn-outline-primary">
                      <i class="bi bi-funnel me-1"></i>B·ªô l·ªçc
                    </button>
                    <button
                      id="nearest-library-button"
                      class="btn btn-outline-success"
                    >
                      <i class="bi bi-geo-alt me-1"></i>Th∆∞ vi·ªán g·∫ßn nh·∫•t
                    </button>
                    <button
                      id="list-libraries-button"
                      class="btn btn-outline-info"
                    >
                      <i class="bi bi-list-ul me-1"></i>Xem danh s√°ch
                    </button>
                    <button
                      id="restore-all-button"
                      class="btn btn-outline-warning"
                    >
                      <i class="bi bi-arrow-clockwise me-1"></i>Kh√¥i ph·ª•c t·∫•t c·∫£
                    </button>
                    <button id="search-button" class="btn btn-primary">
                      <i class="bi bi-search me-1"></i>T√¨m ki·∫øm
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map" class="map-container">
      <!-- Debug info -->
      <div
        style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          z-index: 9999;
          text-align: center;
        "
      >
        <h4>üó∫Ô∏è B·∫£n ƒë·ªì ƒëang t·∫£i...</h4>
        <p>N·∫øu b·∫°n th·∫•y th√¥ng b√°o n√†y, container ƒë√£ hi·ªÉn th·ªã</p>
        <p>ƒêang ch·ªù JavaScript kh·ªüi t·∫°o...</p>
      </div>
    </div>

    <!-- Filter Modal Bootstrap -->
    <div
      class="modal fade"
      id="filterModal"
      tabindex="-1"
      aria-labelledby="filterModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="filterModalLabel">
              <i class="bi bi-funnel me-2"></i>B·ªô l·ªçc th∆∞ vi·ªán
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-12">
                <h6 class="fw-semibold text-primary mb-3">
                  <i class="bi bi-wifi me-2"></i>Ti·ªán √≠ch
                </h6>
                <div class="row g-2">
                  <div class="col-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="filter-wifi"
                      />
                      <label class="form-check-label" for="filter-wifi"
                        >Wifi</label
                      >
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="filter-phong-doc"
                      />
                      <label class="form-check-label" for="filter-phong-doc"
                        >Ph√≤ng ƒë·ªçc</label
                      >
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="filter-canteen"
                      />
                      <label class="form-check-label" for="filter-canteen"
                        >Canteen</label
                      >
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="filter-dieu-hoa"
                      />
                      <label class="form-check-label" for="filter-dieu-hoa"
                        >ƒêi·ªÅu h√≤a</label
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Lo·∫°i th∆∞ vi·ªán</label>
                <select id="filter-phanloai" class="form-select">
                  <option value="">T·∫•t c·∫£</option>
                  <option value="Th∆∞ vi·ªán c√¥ng c·ªông">Th∆∞ vi·ªán c√¥ng c·ªông</option>
                  <option value="Th∆∞ vi·ªán t∆∞ nh√¢n">Th∆∞ vi·ªán t∆∞ nh√¢n</option>
                  <option value="Th∆∞ vi·ªán c√¥ng c·ªông(c√≥ th∆∞ vi·ªán s·ªë)">
                    Th∆∞ vi·ªán c√¥ng c·ªông(c√≥ th∆∞ vi·ªán s·ªë)
                  </option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Th·ªÉ lo·∫°i s√°ch</label>
                <input
                  type="text"
                  id="filter-genre"
                  class="form-control"
                  placeholder="Nh·∫≠p th·ªÉ lo·∫°i"
                />
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">T√™n s√°ch</label>
                <input
                  type="text"
                  id="filter-book-name"
                  class="form-control"
                  placeholder="Nh·∫≠p t√™n s√°ch"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
            <button
              type="button"
              id="reset-filter"
              class="btn btn-outline-warning me-2"
            >
              <i class="bi bi-arrow-clockwise me-1"></i>ƒê·∫∑t l·∫°i
            </button>
            <button type="button" id="apply-filter" class="btn btn-primary">
              <i class="bi bi-check-circle me-1"></i>√Åp d·ª•ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Library Sidebar Bootstrap -->
    <div id="library-sidebar" class="sidebar-offcanvas">
      <div class="sidebar-content">
        <div
          class="sidebar-header d-flex justify-content-between align-items-center mb-3"
        >
          <h5 class="mb-0 text-primary fw-bold">
            <i class="bi bi-info-circle me-2"></i>Th√¥ng tin Th∆∞ vi·ªán
          </h5>
          <button class="close-sidebar btn-close" aria-label="Close"></button>
        </div>
        <div id="sidebar-content" class="sidebar-body"></div>
      </div>
    </div>

    <!-- Books Modal Bootstrap -->
    <div
      class="modal fade"
      id="booksModal"
      tabindex="-1"
      aria-labelledby="booksModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="booksModalLabel">
              <i class="bi bi-book me-2"></i>Danh s√°ch s√°ch
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="books-content"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Results Modal -->
    <div
      class="modal fade"
      id="filterResultsModal"
      tabindex="-1"
      aria-labelledby="filterResultsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="filterResultsModalLabel">
              <i class="bi bi-check-circle me-2"></i>K·∫øt qu·∫£ b·ªô l·ªçc
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="filter-results-content"></div>
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-check me-1"></i>ƒê√£ hi·ªÉu
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Borrow Book Modal -->
    <div
      class="modal fade"
      id="borrowBookModal"
      tabindex="-1"
      aria-labelledby="borrowBookModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="borrowBookModalLabel">
              <i class="bi bi-book me-2"></i>M∆∞·ª£n s√°ch
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="borrowBookForm">
              <div class="row g-3">
                <div class="col-12">
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Th∆∞ vi·ªán:</strong>
                    <span id="borrow-library-name"></span>
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-person me-1"></i>H·ªç v√† t√™n
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    id="borrower-name"
                    class="form-control"
                    placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-envelope me-1"></i>Email
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="email"
                    id="borrower-email"
                    class="form-control"
                    placeholder="example@email.com"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-telephone me-1"></i>S·ªë ƒëi·ªán tho·∫°i
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="tel"
                    id="borrower-phone"
                    class="form-control"
                    placeholder="0123456789"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-calendar me-1"></i>Ng√†y m∆∞·ª£n
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    id="borrow-date"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-calendar-check me-1"></i>Ng√†y tr·∫£ d·ª± ki·∫øn
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    id="return-date"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-book me-1"></i>Lo·∫°i s√°ch mu·ªën m∆∞·ª£n
                  </label>
                  <select id="book-category" class="form-select">
                    <option value="">Ch·ªçn lo·∫°i s√°ch</option>
                    <option value="S√°ch gi√°o khoa">S√°ch gi√°o khoa</option>
                    <option value="VƒÉn h·ªçc">VƒÉn h·ªçc</option>
                    <option value="Khoa h·ªçc">Khoa h·ªçc</option>
                    <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option>
                    <option value="Ngh·ªá thu·∫≠t">Ngh·ªá thu·∫≠t</option>
                    <option value="Kinh t·∫ø">Kinh t·∫ø</option>
                    <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option>
                    <option value="Kh√°c">Kh√°c</option>
                  </select>
                </div>

                <div class="col-12">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-chat-text me-1"></i>Ghi ch√∫
                  </label>
                  <textarea
                    id="borrow-notes"
                    class="form-control"
                    rows="3"
                    placeholder="Ghi ch√∫ th√™m v·ªÅ s√°ch mu·ªën m∆∞·ª£n ho·∫∑c y√™u c·∫ßu ƒë·∫∑c bi·ªát..."
                  ></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>H·ªßy
            </button>
            <button type="button" id="submit-borrow" class="btn btn-success">
              <i class="bi bi-check-circle me-1"></i>G·ª≠i y√™u c·∫ßu
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Libraries List Modal -->
    <div
      class="modal fade"
      id="librariesListModal"
      tabindex="-1"
      aria-labelledby="librariesListModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="librariesListModalLabel">
              <i class="bi bi-building me-2"></i>Danh s√°ch t·∫•t c·∫£ th∆∞ vi·ªán
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <input
                  type="text"
                  id="library-search"
                  class="form-control"
                  placeholder="T√¨m ki·∫øm th∆∞ vi·ªán..."
                />
              </div>
              <div class="col-md-3">
                <select id="library-type-filter" class="form-select">
                  <option value="">T·∫•t c·∫£ lo·∫°i</option>
                  <option value="Th∆∞ vi·ªán c√¥ng c·ªông">Th∆∞ vi·ªán c√¥ng c·ªông</option>
                  <option value="Th∆∞ vi·ªán t∆∞ nh√¢n">Th∆∞ vi·ªán t∆∞ nh√¢n</option>
                  <option value="Th∆∞ vi·ªán tr∆∞·ªùng h·ªçc">
                    Th∆∞ vi·ªán tr∆∞·ªùng h·ªçc
                  </option>
                  <option value="Th∆∞ vi·ªán c√¥ng c·ªông(c√≥ th∆∞ vi·ªán s·ªë)">
                    Th∆∞ vi·ªán c√¥ng c·ªông(c√≥ th∆∞ vi·ªán s·ªë)
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <button
                  id="refresh-libraries"
                  class="btn btn-outline-primary w-100"
                >
                  <i class="bi bi-arrow-clockwise me-1"></i>L√†m m·ªõi
                </button>
              </div>
            </div>
            <div id="libraries-list-content">
              <div class="text-center text-muted">
                <i class="bi bi-hourglass-split" style="font-size: 2rem"></i>
                <p>ƒêang t·∫£i danh s√°ch th∆∞ vi·ªán...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rating and Comment Modal -->
    <div
      class="modal fade"
      id="ratingCommentModal"
      tabindex="-1"
      aria-labelledby="ratingCommentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-warning text-white">
            <h5 class="modal-title" id="ratingCommentModalLabel">
              <i class="bi bi-star me-2"></i>ƒê√°nh gi√° v√† B√¨nh lu·∫≠n
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="ratingCommentForm">
              <div class="row g-3">
                <div class="col-12">
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Th∆∞ vi·ªán:</strong>
                    <span id="rating-library-name"></span>
                  </div>
                </div>

                <!-- Rating Section -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-star me-1"></i>ƒê√°nh gi√° (1-5 sao)
                    <span class="text-danger">*</span>
                  </label>
                  <div class="star-rating mb-3">
                    <span class="star" data-rating="1">‚≠ê</span>
                    <span class="star" data-rating="2">‚≠ê</span>
                    <span class="star" data-rating="3">‚≠ê</span>
                    <span class="star" data-rating="4">‚≠ê</span>
                    <span class="star" data-rating="5">‚≠ê</span>
                  </div>
                  <input
                    type="hidden"
                    id="rating-value"
                    name="rating"
                    required
                  />
                </div>

                <!-- Comment Section -->
                <div class="col-12">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-chat-text me-1"></i>B√¨nh lu·∫≠n
                  </label>
                  <textarea
                    id="comment-text"
                    class="form-control"
                    rows="4"
                    placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ th∆∞ vi·ªán n√†y..."
                  ></textarea>
                </div>

                <!-- User Info -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-person me-1"></i>T√™n c·ªßa b·∫°n
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    id="rating-user-name"
                    class="form-control"
                    placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-envelope me-1"></i>Email
                  </label>
                  <input
                    type="email"
                    id="rating-user-email"
                    class="form-control"
                    placeholder="example@email.com"
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>H·ªßy
            </button>
            <button
              type="button"
              id="submit-rating-comment"
              class="btn btn-warning"
            >
              <i class="bi bi-check-circle me-1"></i>G·ª≠i ƒë√°nh gi√°
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Locate Control -->
    <div class="locate-control">
      <button id="locate-button" class="btn btn-primary btn-lg shadow-lg">
        <i class="bi bi-geo-alt-fill me-2"></i>V·ªã tr√≠ c·ªßa t√¥i
      </button>
      <span id="locate-loading" class="ms-3 text-muted" style="display: none">
        <i class="bi bi-arrow-clockwise spin"></i> ƒêang ƒë·ªãnh v·ªã...
      </span>
    </div>

    <!-- Modal ƒë√°nh gi√° th∆∞ vi·ªán -->
    <div
      class="modal fade"
      id="ratingModal"
      tabindex="-1"
      aria-labelledby="ratingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ratingModalLabel">
              <i class="bi bi-star-fill me-2"></i>ƒê√°nh gi√° th∆∞ vi·ªán
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="ratingForm">
              <input type="hidden" id="ratingLibraryId" name="libraryId" />

              <div class="mb-4">
                <label class="form-label fw-bold">
                  <i class="bi bi-building me-2"></i>Th∆∞ vi·ªán:
                </label>
                <p
                  class="form-control-plaintext fw-semibold text-primary"
                  id="ratingLibraryName"
                ></p>
              </div>

              <div class="mb-4">
                <label class="form-label fw-bold">
                  <i class="bi bi-person me-2"></i>T√™n ng∆∞·ªùi ƒë√°nh gi√°:
                </label>
                <input
                  type="text"
                  class="form-control"
                  name="userName"
                  placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n"
                  required
                />
              </div>

              <div class="mb-4">
                <label class="form-label fw-bold">
                  <i class="bi bi-star me-2"></i>ƒêi·ªÉm ƒë√°nh gi√°:
                </label>
                <div class="rating-stars">
                  <input type="radio" id="star5" name="rating" value="5" />
                  <label for="star5" title="R·∫•t t·ªët">‚≠ê</label>
                  <input type="radio" id="star4" name="rating" value="4" />
                  <label for="star4" title="T·ªët">‚≠ê</label>
                  <input type="radio" id="star3" name="rating" value="3" />
                  <label for="star3" title="B√¨nh th∆∞·ªùng">‚≠ê</label>
                  <input type="radio" id="star2" name="rating" value="2" />
                  <label for="star2" title="Kh√¥ng t·ªët">‚≠ê</label>
                  <input type="radio" id="star1" name="rating" value="1" />
                  <label for="star1" title="R·∫•t t·ªá">‚≠ê</label>
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label fw-bold">
                  <i class="bi bi-chat-text me-2"></i>Nh·∫≠n x√©t (t√πy ch·ªçn):
                </label>
                <textarea
                  class="form-control"
                  name="comment"
                  rows="3"
                  placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ th∆∞ vi·ªán n√†y..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>H·ªßy
            </button>
            <button
              type="button"
              class="btn btn-warning"
              onclick="submitRating()"
            >
              <i class="bi bi-star-fill me-1"></i>G·ª≠i ƒë√°nh gi√°
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      console.log("üì¶ Bootstrap ƒë√£ ƒë∆∞·ª£c load");
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      console.log("üåø Leaflet script tag ƒë√£ ƒë∆∞·ª£c load");
      console.log("üåø Leaflet object sau script tag:", typeof L);
      console.log(
        "üåø Leaflet version sau script tag:",
        L ? L.version : "Kh√¥ng c√≥"
      );
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

    <script>
      console.log("üõ£Ô∏è Leaflet routing ƒë√£ ƒë∆∞·ª£c load");
    </script>

    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <script>
      console.log("üì∑ Pannellum ƒë√£ ƒë∆∞·ª£c load");
    </script>

    <script>
      // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
      console.log("üöÄ B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o b·∫£n ƒë·ªì Leaflet...");

      // Test DOM
      const mapContainer = document.getElementById("map");
      console.log("üìç Map container:", mapContainer);

      // G·∫Øn c·ªù quy·ªÅn admin ƒë·ªÉ hi·ªÉn th·ªã n√∫t ch·ªânh s·ª≠a
      const IS_ADMIN = <%= user && user.role === 'admin' ? 'true' : 'false' %>;

      // Test Leaflet
      if (typeof L !== "undefined") {
        console.log("‚úÖ Leaflet s·∫µn s√†ng, ƒëang t·∫°o b·∫£n ƒë·ªì...");

        try {
          const map = L.map("map").setView(
            [21.07088380428482, 105.77995583357745],
            13
          );
          console.log("‚úÖ B·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c t·∫°o:", map);

          // Th√™m tile layer
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "¬© OpenStreetMap",
          }).addTo(map);

          console.log("‚úÖ Tile layer ƒë√£ ƒë∆∞·ª£c th√™m");

          // ·∫®n debug info
          const debugInfo = mapContainer.querySelector(
            'div[style*="position: absolute"]'
          );
          if (debugInfo) {
            debugInfo.style.display = "none";
            console.log("‚úÖ ƒê√£ ·∫©n debug info");
          }

          // Th√™m marker test
          const testMarker = L.marker([21.0285, 105.8542]).addTo(map);
          testMarker.bindPopup("Th∆∞ vi·ªán Test - H√† N·ªôi").openPopup();

          console.log("‚úÖ Marker test ƒë√£ ƒë∆∞·ª£c th√™m");

          // Th√™m marker th∆∞ vi·ªán test
          const libraryIcon = L.icon({
            iconUrl: "/images/igg.png",
            iconSize: [60, 60],
            iconAnchor: [30, 60],
            popupAnchor: [0, -50],
          });

          const libraryMarker = L.marker([21.0285, 105.8542], {
            icon: libraryIcon,
          }).addTo(map);
          libraryMarker.bindPopup("Th∆∞ vi·ªán Qu·ªëc gia - H√† N·ªôi").openPopup();

          console.log("‚úÖ Marker th∆∞ vi·ªán ƒë√£ ƒë∆∞·ª£c th√™m");

          // T·∫£i d·ªØ li·ªáu th·∫≠t t·ª´ API
          console.log("üîÑ B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu th∆∞ vi·ªán t·ª´ API...");
          fetch("/data")
            .then((response) => {
              console.log("üì° Response status:", response.status);
              return response.json();
            })
            .then((data) => {
              console.log("üìä D·ªØ li·ªáu API nh·∫≠n ƒë∆∞·ª£c:", data);
              if (data && data.features) {
                console.log("‚úÖ C√≥ d·ªØ li·ªáu features:", data.features.length);
                renderAllLibraries(data.features, map, libraryIcon);
              } else {
                console.error("‚ùå D·ªØ li·ªáu t·ª´ API kh√¥ng h·ª£p l·ªá:", data);
              }
            })
            .catch((error) => {
              console.error("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu API:", error);
            });

          // H√†m hi·ªÉn th·ªã t·∫•t c·∫£ th∆∞ vi·ªán
          function renderAllLibraries(features, map, icon) {
            console.log("üéØ B·∫Øt ƒë·∫ßu render t·∫•t c·∫£ th∆∞ vi·ªán...");

            // X√≥a markers c≈© (gi·ªØ l·∫°i marker test)
            map.eachLayer((layer) => {
              if (
                layer instanceof L.Marker &&
                layer !== libraryMarker &&
                layer !== testMarker
              ) {
                map.removeLayer(layer);
              }
            });

            let markerCount = 0;
            features.forEach((feature, index) => {
              const coords = feature.geometry.coordinates;
              const properties = feature.properties;

              if (!properties.ID || !coords || coords.length !== 2) {
                return;
              }

              try {
                const marker = L.marker([coords[1], coords[0]], {
                  icon: icon,
                }).addTo(map);

                markerCount++;

                // T·∫°o popup v·ªõi th√¥ng tin th∆∞ vi·ªán v√† h√¨nh ·∫£nh
                const popupContent = `
                  <div style="min-width: 300px;">
                    <h6 style="color: #0d6efd; margin-bottom: 10px;">
                      <i class="bi bi-building me-2"></i>${
                        properties.TenThuVien
                      }
                    </h6>
                    ${
                      properties.Anh360
                        ? `
                      <div style="margin-bottom: 10px; text-align: center;">
                        <img src="${properties.Anh360}" alt="${properties.TenThuVien}"
                             style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">
                      </div>
                    `
                        : ""
                    }
                    <p style="margin-bottom: 8px;">
                      <i class="bi bi-geo-alt text-success me-2"></i>${
                        properties.DiaChi
                      }
                    </p>
                    <p style="margin-bottom: 8px;">
                      <i class="bi bi-tag text-primary me-2"></i>${
                        properties.phanloai || "Kh√¥ng x√°c ƒë·ªãnh"
                      }
                    </p>
                    
                    <!-- Th√¥ng tin s√°ch -->
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                      <h6 style="color: #28a745; margin-bottom: 8px;">
                        <i class="bi bi-book me-2"></i>Th√¥ng tin s√°ch
                      </h6>
                      <div id="books-preview-${properties.ID}" style="font-size: 14px;">
                        <div class="text-muted" style="font-size:12px">
                          ƒêang t·∫£i s√°ch...
                        </div>
                      </div>
                    </div>
                    
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 15px;">
                      <span class="me-3">
                        <i class="bi bi-wifi ${
                          properties.Wifi ? "text-success" : "text-muted"
                        }"></i> Wifi
                      </span>
                      <span class="me-3">
                        <i class="bi bi-book ${
                          properties.PhongDoc ? "text-info" : "text-muted"
                        }"></i> Ph√≤ng ƒë·ªçc
                      </span>
                      <span class="me-3">
                        <i class="bi bi-cup-hot ${
                          properties.Canteen ? "text-warning" : "text-muted"
                        }"></i> Canteen
                      </span>
                      <span>
                        <i class="bi bi-snow ${
                          properties.DieuHoa ? "text-primary" : "text-muted"
                        }"></i> ƒêi·ªÅu h√≤a
                      </span>
                    </div>
                    
                    <div class="d-flex gap-2 flex-wrap">
                      <button class="btn btn-sm btn-outline-primary" onclick="showDirections(${coords[1]}, ${coords[0]}, '${properties.TenThuVien}')">
                        <i class="bi bi-route"></i> Ch·ªâ ƒë∆∞·ªùng
                      </button>
                      ${IS_ADMIN ? `
                      <button class="btn btn-sm btn-outline-warning" onclick="openAdminEdit(${properties.ID})">
                        <i class="bi bi-pencil-square"></i> Ch·ªânh s·ª≠a
                      </button>
                      ` : ''}
                      <button class="btn btn-sm btn-outline-warning" onclick="showRatingModal(${
                        properties.ID
                      }, '${properties.TenThuVien}')">
                        <i class="bi bi-star"></i> ƒê√°nh gi√°
                      </button>
                      <button class="btn btn-sm btn-outline-success" onclick="borrowBook('${
                        properties.TenThuVien
                      }', ${properties.ID})" 
                        style="border: 2px solid #28a745; font-weight: bold; background-color: #d4edda;">
                        <i class="bi bi-book"></i> M∆∞·ª£n s√°ch
                      </button>
                      <button class="btn btn-sm btn-outline-info" onclick="viewLibraryBooks(${
                        properties.ID
                      }, '${properties.TenThuVien}')">
                        <i class="bi bi-list-ul"></i> Xem s√°ch
                      </button>
                      ${
                        properties.Anh360
                          ? `
                        <button class="btn btn-sm btn-outline-info" onclick="view360Image('${properties.Anh360}', '${properties.TenThuVien}')">
                          <i class="bi bi-camera"></i> 360¬∞
                        </button>
                      `
                          : ""
                      }
                    </div>
                  </div>
                `;

                marker.bindPopup(popupContent);

                // Khi m·ªü popup, t·∫£i danh s√°ch s√°ch th·∫≠t t·ª´ API ƒë·ªÉ hi·ªÉn th·ªã
                marker.on('popupopen', () => {
                  const containerId = `books-preview-${properties.ID}`;
                  fetchAndRenderLibraryBooksPreview(properties.ID, containerId);
                });

                // X·ª≠ l√Ω click v√†o marker
                marker.on("click", () => {
                  console.log("üñ±Ô∏è Click v√†o th∆∞ vi·ªán:", properties.TenThuVien);
                  // C√≥ th·ªÉ th√™m sidebar hi·ªÉn th·ªã chi ti·∫øt ·ªü ƒë√¢y
                });
              } catch (error) {
                console.error("‚ùå L·ªói khi t·∫°o marker:", error);
              }
            });

            console.log(
              `üéâ Ho√†n th√†nh! ƒê√£ t·∫°o ${markerCount} markers th∆∞ vi·ªán`
            );
          }

          // Kh·ªüi t·∫°o modal danh s√°ch th∆∞ vi·ªán
          const librariesListModal = new bootstrap.Modal(
            document.getElementById("librariesListModal")
          );

          // X·ª≠ l√Ω n√∫t "Xem danh s√°ch"
          const listLibrariesButton = document.getElementById(
            "list-libraries-button"
          );
          if (listLibrariesButton) {
            listLibrariesButton.addEventListener("click", () => {
              console.log("üìã Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'Xem danh s√°ch'");
              showLibrariesList();
              librariesListModal.show();
            });
          }

          // X·ª≠ l√Ω n√∫t "Kh√¥i ph·ª•c t·∫•t c·∫£ th∆∞ vi·ªán"
          const restoreAllButton =
            document.getElementById("restore-all-button");
          if (restoreAllButton) {
            restoreAllButton.addEventListener("click", () => {
              console.log("üîÑ Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'Kh√¥i ph·ª•c t·∫•t c·∫£'");
              restoreAllLibraries();
            });
          }

          // H√†m hi·ªÉn th·ªã danh s√°ch th∆∞ vi·ªán
          function showLibrariesList() {
            console.log("üìã ƒêang hi·ªÉn th·ªã danh s√°ch th∆∞ vi·ªán...");

            fetch("/data")
              .then((response) => response.json())
              .then((data) => {
                if (data && data.features) {
                  renderLibrariesList(data.features);
                }
              })
              .catch((error) => {
                console.error("‚ùå L·ªói khi t·∫£i danh s√°ch th∆∞ vi·ªán:", error);
              });
          }

          // H√†m render danh s√°ch th∆∞ vi·ªán
          function renderLibrariesList(features) {
            const content = document.getElementById("libraries-list-content");

            if (!features || features.length === 0) {
              content.innerHTML =
                '<div class="alert alert-info">Kh√¥ng c√≥ th∆∞ vi·ªán n√†o.</div>';
              return;
            }

            let html = `
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>STT</th>
                      <th>T√™n th∆∞ vi·ªán</th>
                      <th>ƒê·ªãa ch·ªâ</th>
                      <th>Lo·∫°i</th>
                      <th>Ti·ªán √≠ch</th>
                      <th>H√†nh ƒë·ªông</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            features.forEach((feature, index) => {
              const properties = feature.properties;
              const coords = feature.geometry.coordinates;

              html += `
                <tr>
                  <td>${index + 1}</td>
                  <td><strong>${
                    properties.TenThuVien || "Kh√¥ng x√°c ƒë·ªãnh"
                  }</strong></td>
                  <td>${properties.DiaChi || "Kh√¥ng x√°c ƒë·ªãnh"}</td>
                  <td><span class="badge bg-primary">${
                    properties.phanloai || "Kh√¥ng x√°c ƒë·ªãnh"
                  }</span></td>
                  <td>
                    <div class="d-flex gap-2">
                      <span class="badge ${
                        properties.Wifi ? "bg-success" : "bg-secondary"
                      }">Wifi</span>
                      <span class="badge ${
                        properties.PhongDoc ? "bg-info" : "bg-secondary"
                      }">Ph√≤ng ƒë·ªçc</span>
                      <span class="badge ${
                        properties.Canteen ? "bg-warning" : "bg-secondary"
                      }">Canteen</span>
                      <span class="badge ${
                        properties.DieuHoa ? "bg-primary" : "bg-secondary"
                      }">ƒêi·ªÅu h√≤a</span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showOnMap(${
                      coords[1]
                    }, ${coords[0]}, '${properties.TenThuVien}')">
                      <i class="bi bi-map"></i> Xem tr√™n b·∫£n ƒë·ªì
                    </button>
                  </td>
                </tr>
              `;
            });

            html += `
                  </tbody>
                </table>
              </div>
              <div class="text-muted text-center mt-3">
                T·ªïng c·ªông: <strong>${features.length}</strong> th∆∞ vi·ªán
              </div>
            `;

            content.innerHTML = html;
          }

          // H√†m hi·ªÉn th·ªã th∆∞ vi·ªán tr√™n b·∫£n ƒë·ªì
          window.showOnMap = function (lat, lng, libraryName) {
            console.log("üó∫Ô∏è Hi·ªÉn th·ªã th∆∞ vi·ªán tr√™n b·∫£n ƒë·ªì:", {
              lat,
              lng,
              libraryName,
            });

            // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn v·ªã tr√≠ th∆∞ vi·ªán
            map.setView([lat, lng], 16);

            // T√¨m marker t∆∞∆°ng ·ª©ng v·ªõi t·ªça ƒë·ªô n√†y
            let targetMarker = null;
            map.eachLayer((layer) => {
              if (layer instanceof L.Marker) {
                const markerLatLng = layer.getLatLng();
                // So s√°nh t·ªça ƒë·ªô v·ªõi ƒë·ªô ch√≠nh x√°c 0.0001 (kho·∫£ng 10m)
                if (
                  Math.abs(markerLatLng.lat - lat) < 0.0001 &&
                  Math.abs(markerLatLng.lng - lng) < 0.0001
                ) {
                  targetMarker = layer;
                }
              }
            });

            // M·ªü popup n·∫øu t√¨m th·∫•y marker
            if (targetMarker) {
              console.log("‚úÖ T√¨m th·∫•y marker, ƒëang m·ªü popup...");
              // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ b·∫£n ƒë·ªì ho√†n th√†nh vi·ªác di chuy·ªÉn
              setTimeout(() => {
                targetMarker.openPopup();
              }, 500);
            } else {
              console.log("‚ùå Kh√¥ng t√¨m th·∫•y marker t∆∞∆°ng ·ª©ng");
              // N·∫øu kh√¥ng t√¨m th·∫•y marker, t·∫°o popup t·∫°m th·ªùi
              setTimeout(() => {
                const tempMarker = L.marker([lat, lng]).addTo(map);
                tempMarker
                  .bindPopup(
                    `
                  <div style="min-width: 250px;">
                    <h6 style="color: #0d6efd; margin-bottom: 10px;">
                      <i class="bi bi-building me-2"></i>${libraryName}
                    </h6>
                    <p style="margin-bottom: 8px;">
                      <i class="bi bi-geo-alt text-success me-2"></i>V·ªã tr√≠: ${lat.toFixed(
                        6
                      )}, ${lng.toFixed(6)}
                    </p>
                    <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="showDirections(${lat}, ${lng}, '${libraryName}')">
                        <i class="bi bi-route"></i> Ch·ªâ ƒë∆∞·ªùng
                      </button>
                    </div>
                  </div>
                `
                  )
                  .openPopup();

                // X√≥a marker t·∫°m th·ªùi sau 10 gi√¢y
                setTimeout(() => {
                  map.removeLayer(tempMarker);
                }, 10000);
              }, 500);
            }

            // ƒê√≥ng modal danh s√°ch
            librariesListModal.hide();
          };

          // X·ª≠ l√Ω t√¨m ki·∫øm trong danh s√°ch
          const librarySearch = document.getElementById("library-search");
          if (librarySearch) {
            librarySearch.addEventListener("input", (e) => {
              const query = e.target.value.toLowerCase();
              filterLibrariesList(query);
            });
          }

          // X·ª≠ l√Ω b·ªô l·ªçc lo·∫°i th∆∞ vi·ªán
          const libraryTypeFilter = document.getElementById(
            "library-type-filter"
          );
          if (libraryTypeFilter) {
            libraryTypeFilter.addEventListener("change", (e) => {
              const selectedType = e.target.value;
              filterLibrariesList("", selectedType);
            });
          }

          // H√†m l·ªçc danh s√°ch th∆∞ vi·ªán
          function filterLibrariesList(searchQuery = "", selectedType = "") {
            fetch("/data")
              .then((response) => response.json())
              .then((data) => {
                if (data && data.features) {
                  let filteredFeatures = data.features;

                  // L·ªçc theo t√¨m ki·∫øm
                  if (searchQuery) {
                    filteredFeatures = filteredFeatures.filter(
                      (feature) =>
                        feature.properties.TenThuVien.toLowerCase().includes(
                          searchQuery
                        ) ||
                        feature.properties.DiaChi.toLowerCase().includes(
                          searchQuery
                        )
                    );
                  }

                  // L·ªçc theo lo·∫°i
                  if (selectedType) {
                    filteredFeatures = filteredFeatures.filter(
                      (feature) => feature.properties.phanloai === selectedType
                    );
                  }

                  renderLibrariesList(filteredFeatures);
                }
              })
              .catch((error) => {
                console.error("‚ùå L·ªói khi l·ªçc th∆∞ vi·ªán:", error);
              });
          }

          // X·ª≠ l√Ω n√∫t l√†m m·ªõi
          const refreshLibraries = document.getElementById("refresh-libraries");
          if (refreshLibraries) {
            refreshLibraries.addEventListener("click", () => {
              console.log("üîÑ L√†m m·ªõi danh s√°ch th∆∞ vi·ªán");
              showLibrariesList();
            });
          }

          // X·ª≠ l√Ω n√∫t t√¨m ki·∫øm
          const searchButton = document.getElementById("search-button");
          const searchInput = document.querySelector("#main-search");

          if (searchButton && searchInput) {
            searchButton.addEventListener("click", () => {
              console.log("üîç Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'T√¨m ki·∫øm'");
              performSearch();
            });

            // T√¨m ki·∫øm khi nh·∫•n Enter
            searchInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                console.log("üîç Ng∆∞·ªùi d√πng nh·∫•n Enter ƒë·ªÉ t√¨m ki·∫øm");
                performSearch();
              }
            });
          }

          // H√†m th·ª±c hi·ªán t√¨m ki·∫øm
          function performSearch() {
            const searchQuery = searchInput.value.trim();

            if (!searchQuery) {
              alert("Vui l√≤ng nh·∫≠p t√™n th∆∞ vi·ªán c·∫ßn t√¨m!");
              return;
            }

            console.log("üîç ƒêang t√¨m ki·∫øm:", searchQuery);

            // T√¨m ki·∫øm trong d·ªØ li·ªáu hi·ªán c√≥
            fetch("/data")
              .then((response) => response.json())
              .then((data) => {
                if (data && data.features) {
                  const results = searchLibraries(data.features, searchQuery);
                  if (results.length > 0) {
                    showSearchResults(results, searchQuery);
                  } else {
                    alert(
                      `Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán n√†o c√≥ t√™n ch·ª©a "${searchQuery}"`
                    );
                  }
                }
              })
              .catch((error) => {
                console.error("‚ùå L·ªói khi t√¨m ki·∫øm:", error);
                alert("C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm!");
              });
          }

          // H√†m t√¨m ki·∫øm th∆∞ vi·ªán
          function searchLibraries(libraries, query) {
            const searchTerm = query.toLowerCase();
            return libraries.filter((library) => {
              const name = library.properties.TenThuVien?.toLowerCase() || "";
              const address = library.properties.DiaChi?.toLowerCase() || "";
              const type = library.properties.phanloai?.toLowerCase() || "";

              return (
                name.includes(searchTerm) ||
                address.includes(searchTerm) ||
                type.includes(searchTerm)
              );
            });
          }

          // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
          function showSearchResults(results, query) {
            console.log(`‚úÖ T√¨m th·∫•y ${results.length} k·∫øt qu·∫£ cho "${query}"`);

            // X√≥a t·∫•t c·∫£ markers c≈©
            map.eachLayer((layer) => {
              if (
                layer instanceof L.Marker &&
                layer !== currentLocationMarker
              ) {
                map.removeLayer(layer);
              }
            });

            // Hi·ªÉn th·ªã markers cho k·∫øt qu·∫£ t√¨m ki·∫øm
            const searchIcon = L.icon({
              iconUrl: "/images/igg.png",
              iconSize: [60, 60],
              iconAnchor: [30, 60],
              popupAnchor: [0, -50],
            });

            let bounds = L.latLngBounds();

            results.forEach((library, index) => {
              const coords = library.geometry.coordinates;
              const properties = library.properties;

              const marker = L.marker([coords[1], coords[0]], {
                icon: searchIcon,
              }).addTo(map);

              // T·∫°o popup v·ªõi th√¥ng tin th∆∞ vi·ªán v√† h√¨nh ·∫£nh
              const popupContent = `
                  <div style="min-width: 250px;">
                    <h6 style="color: #0d6efd; margin-bottom: 10px;">
                      <i class="bi bi-building me-2"></i>${
                        properties.TenThuVien
                      }
                    </h6>

                    <!-- Debug info -->
                    <div style="background: #f8f9fa; padding: 5px; margin: 5px 0; border-radius: 5px; font-size: 12px; color: #6c757d;">
                      <strong>Debug:</strong> ID: ${
                        properties.ID
                      }, C√≥ n√∫t m∆∞·ª£n s√°ch
                    </div>
                  ${
                    properties.Anh360
                      ? `
                    <div style="margin-bottom: 10px; text-align: center;">
                      <img src="${properties.Anh360}" alt="${properties.TenThuVien}"
                           style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">
                    </div>
                  `
                      : ""
                  }
                  <p style="margin-bottom: 8px;">
                    <i class="bi bi-geo-alt text-success me-2"></i>${
                      properties.DiaChi
                    }
                  </p>
                  <p style="margin-bottom: 8px;">
                    <i class="bi bi-tag text-primary me-2"></i>${
                      properties.phanloai || "Kh√¥ng x√°c ƒë·ªãnh"
                    }
                  </p>
                  <div style="font-size: 12px; color: #6c757d; margin-bottom: 15px;">
                    <span class="me-3">
                      <i class="bi bi-wifi ${
                        properties.Wifi ? "text-success" : "text-muted"
                      }"></i> Wifi
                    </span>
                    <span class="me-3">
                      <i class="bi bi-book ${
                        properties.PhongDoc ? "text-info" : "text-muted"
                      }"></i> Ph√≤ng ƒë·ªçc
                    </span>
                    <span class="me-3">
                      <i class="bi bi-cup-hot ${
                        properties.Canteen ? "text-warning" : "text-muted"
                      }"></i> Canteen
                    </span>
                    <span>
                      <i class="bi bi-snow ${
                        properties.DieuHoa ? "text-primary" : "text-muted"
                      }"></i> ƒêi·ªÅu h√≤a
                    </span>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showDirections(${ 
                      coords[1]
                    }, ${coords[0]}, '${properties.TenThuVien}')">
                      <i class="bi bi-route"></i> Ch·ªâ ƒë∆∞·ªùng
                    </button>
                    ${IS_ADMIN ? `
                    <button class="btn btn-sm btn-outline-warning" onclick="openAdminEdit(${properties.ID})">
                      <i class="bi bi-pencil-square"></i> Ch·ªânh s·ª≠a
                    </button>
                    ` : ''}
                    <button class="btn btn-sm btn-outline-success" onclick="borrowBook('${
                      properties.TenThuVien
                    }', ${
                properties.ID
              })" style="border: 2px solid #28a745; font-weight: bold; background-color: #d4edda;">
                      <i class="bi bi-book"></i> M∆∞·ª£n s√°ch
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewLibraryBooks(${
                      properties.ID
                    }, '${properties.TenThuVien}')">
                      <i class="bi bi-list-ul"></i> Xem s√°ch
                    </button>
                    ${
                      properties.Anh360
                        ? `
                      <button class="btn btn-sm btn-outline-info" onclick="view360Image('${properties.Anh360}', '${properties.TenThuVien}')">
                        <i class="bi bi-camera"></i> 360¬∞
                      </button>
                    `
                        : ""
                    }
                  </div>
                  <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px;">
                    <div id="books-preview-${properties.ID}" style="font-size: 13px;">
                      <span class="text-muted" style="font-size:12px">ƒêang t·∫£i s√°ch...</span>
                    </div>
                  </div>
                </div>
              `;

              marker.bindPopup(popupContent);
              marker.on('popupopen', () => {
                const containerId = `books-preview-${properties.ID}`;
                fetchAndRenderLibraryBooksPreview(properties.ID, containerId);
              });
              bounds.extend([coords[1], coords[0]]);
            });

            // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£ k·∫øt qu·∫£
            if (bounds.isValid()) {
              map.fitBounds(bounds, { padding: [20, 20] });
            }

            // Hi·ªÉn th·ªã th√¥ng b√°o k·∫øt qu·∫£
            alert(
              `T√¨m th·∫•y ${results.length} th∆∞ vi·ªán cho "${query}"!\nB·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£.`
            );
          }

          // H√†m ch·ªâ ƒë∆∞·ªùng t·ª´ v·ªã tr√≠ hi·ªán t·∫°i ƒë·∫øn th∆∞ vi·ªán
                    // H√†m ch·ªâ ƒë∆∞·ªùng t·ª´ v·ªã tr√≠ hi·ªán t·∫°i ƒë·∫øn th∆∞ vi·ªán
                    function showDirections(lat, lng, libraryName) {
            if (!currentLocationMarker) {
              alert(
                "Vui l√≤ng s·ª≠ d·ª•ng 'V·ªã tr√≠ c·ªßa t√¥i' tr∆∞·ªõc ƒë·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ hi·ªán t·∫°i!"
              );
              return;
            }

            const currentLat = currentLocationMarker.getLatLng().lat;
            const currentLng = currentLocationMarker.getLatLng().lng;

            console.log("üó∫Ô∏è Ch·ªâ ƒë∆∞·ªùng t·ª´", { currentLat, currentLng }, "ƒë·∫øn", {
              lat,
              lng,
            });

            // T√≠nh kho·∫£ng c√°ch v√† th·ªùi gian
            const distance = calculateDistance(currentLat, currentLng, lat, lng);
            const timeEstimates = estimateTravelTime(distance);
            
                        // X√≥a route c≈© n·∫øu c√≥
                        if (window.currentRoute) {
              window.currentRoute.remove();
            }

            // ·∫®n Leaflet Routing Machine m·∫∑c ƒë·ªãnh
            const routingContainers = document.querySelectorAll('.leaflet-routing-container');
            routingContainers.forEach(container => {
              container.style.display = 'none';
            });

            // T·∫°o ƒë∆∞·ªùng th·∫≥ng ƒë∆°n gi·∫£n thay v√¨ s·ª≠ d·ª•ng routing service
            const routeLine = L.polyline([
              [currentLat, currentLng],
              [lat, lng]
            ], {
              color: '#4CAF50',
              weight: 6,
              opacity: 0.8,
              dashArray: '10, 10'
            }).addTo(map);

            // Th√™m marker ƒëi·ªÉm b·∫Øt ƒë·∫ßu
            const startMarker = L.marker([currentLat, currentLng], {
              icon: L.icon({
                iconUrl: "/images/diem.jpg",
                iconSize: [25, 25],
                iconAnchor: [12, 12]
              })
            }).addTo(map).bindPopup("V·ªã tr√≠ c·ªßa b·∫°n");

            // Th√™m marker ƒëi·ªÉm ƒë·∫øn
            const endMarker = L.marker([lat, lng], {
              icon: L.icon({
                iconUrl: "/images/thuvien.jpg",
                iconSize: [30, 30],
                iconAnchor: [15, 15]
              })
            }).addTo(map).bindPopup(libraryName);

            // L∆∞u route hi·ªán t·∫°i ƒë·ªÉ c√≥ th·ªÉ x√≥a sau
            window.currentRoute = {
              line: routeLine,
              startMarker: startMarker,
              endMarker: endMarker,
              remove: function() {
                map.removeLayer(this.line);
                map.removeLayer(this.startMarker);
                map.removeLayer(this.endMarker);
              }
            };

            // Fit map ƒë·ªÉ hi·ªÉn th·ªã c·∫£ hai ƒëi·ªÉm
            map.fitBounds([
              [currentLat, currentLng],
              [lat, lng]
            ], { padding: [20, 20] });
            //X√≥a ruote c≈© n·∫øu c√≥ 
            if(window.currentRoute){
              window.currentRoute.remove();
            }
            //√Çnr ho√†n to√†n leaflet routing machine m·∫∑c ƒë·ªãnh 
            

            // T·∫°o route control m·ªõi
            window.currentRoute = L.Routing.control({
              waypoints: [
                L.latLng(currentLat, currentLng),
                L.latLng(lat, lng)
              ],
              routeWhileDragging: false,
              addWaypoints: false,
              createMarker: function(i, waypoint, n) {
                if (i === 0) {
                  // Marker ƒëi·ªÉm b·∫Øt ƒë·∫ßu (v·ªã tr√≠ hi·ªán t·∫°i)
                  return L.marker(waypoint.latLng, {
                    icon: L.icon({
                      iconUrl: "/images/diem.jpg",
                      iconSize: [25, 25],
                      iconAnchor: [12.5, 12.5],
                    })
                  }).bindPopup("V·ªã tr√≠ c·ªßa b·∫°n");
                } else {
                  // Marker ƒëi·ªÉm ƒë·∫øn (th∆∞ vi·ªán)
                  return L.marker(waypoint.latLng, {
                    icon: L.icon({
                      iconUrl: "/images/igg.png",
                      iconSize: [60, 60],
                      iconAnchor: [30, 60],
                      popupAnchor: [0, -50],
                    })
                  }).bindPopup(`ƒê√≠ch ƒë·∫øn: ${libraryName}`);
                }
              },
              lineOptions: {
                styles: [
                  {
                    color: '#3388ff',
                    weight: 6,
                    opacity: 0.8
                  }
                ]
              }
            }).addTo(map);

            // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt v·ªõi design m·ªõi
            const routeInfo = `
              <div class="route-info">
                <h6><i class="bi bi-route"></i>Ch·ªâ ƒë∆∞·ªùng ƒë·∫øn ${libraryName}</h6>
                
                <div class="info-item">
                  <div class="label">
                    <i class="bi bi-rulers"></i>Kho·∫£ng c√°ch
                  </div>
                  <div class="value">${distance.toFixed(2)} km</div>
                </div>

                <div class="info-item">
                  <div class="label">
                    <i class="bi bi-geo-alt"></i>ƒêi·ªÉm b·∫Øt ƒë·∫ßu
                  </div>
                  <div class="value">V·ªã tr√≠ c·ªßa b·∫°n</div>
                </div>

                <div class="info-item">
                  <div class="label">
                    <i class="bi bi-building"></i>ƒêi·ªÉm ƒë·∫øn
                  </div>
                  <div class="value">${libraryName}</div>
                </div>

                <div class="time-estimates">
                  <h7><i class="bi bi-clock"></i>Th·ªùi gian ∆∞·ªõc t√≠nh</h7>
                  <div class="time-item">
                    <div class="transport-text">
                      <i class="bi bi-person-walking"></i> ƒêi b·ªô
                    </div>
                    <div class="time-value">${Math.round(timeEstimates.walking)} ph√∫t</div>
                  </div>
                  <div class="time-item">
                    <div class="transport-text">
                      <i class="bi bi-bicycle"></i> Xe m√°y
                    </div>
                    <div class="time-value">${Math.round(timeEstimates.motorbike)} ph√∫t</div>
                  </div>
                </div>

                <div class="action-buttons">
                  <button onclick="clearRoute()" class="btn btn-outline-danger">
                    <i class="bi bi-x-circle"></i> X√≥a ch·ªâ ƒë∆∞·ªùng
                  </button>
                  <button onclick="centerOnRoute()" class="btn btn-outline-primary">
                    <i class="bi bi-arrows-move"></i> T·∫≠p trung
                  </button>
                </div>
              </div>
            `;

            // X√≥a th√¥ng tin route c≈©
            const oldRouteInfo = document.querySelector('.route-info');
            if (oldRouteInfo) {
              oldRouteInfo.remove();
            }

            // Th√™m th√¥ng tin route m·ªõi
            document.body.insertAdjacentHTML('beforeend', routeInfo);

            // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô route
            const group = new L.featureGroup([
              L.latLng(currentLat, currentLng),
              L.latLng(lat, lng)
            ]);
            map.fitBounds(group.getBounds().pad(0.1));

            // Hi·ªÉn th·ªã th√¥ng b√°o
            alert(
              `üó∫Ô∏è ƒê√£ t·∫°o ch·ªâ ƒë∆∞·ªùng ƒë·∫øn ${libraryName}!\nKho·∫£ng c√°ch: ${distance.toFixed(2)} km\nTh·ªùi gian: ${Math.round(timeEstimates.motorbike)} ph√∫t (xe m√°y)\nB·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi ƒë∆∞·ªùng ƒëi.`
            );
          }

                   // H√†m x√≥a ch·ªâ ƒë∆∞·ªùng
                   window.clearRoute = function() {
            if (window.currentRoute) {
              map.removeControl(window.currentRoute);
              window.currentRoute = null;
            }
            
            // X√≥a th√¥ng tin route v·ªõi hi·ªáu ·ª©ng
            const routeInfo = document.querySelector('.route-info');
            if (routeInfo) {
              routeInfo.style.animation = 'slideOutLeft 0.3s ease-in forwards';
              setTimeout(() => {
                if (routeInfo.parentNode) {
                  routeInfo.parentNode.removeChild(routeInfo);
                }
              }, 300);
            }
            
            console.log("üóëÔ∏è ƒê√£ x√≥a ch·ªâ ƒë∆∞·ªùng");
          }

          // H√†m xem ·∫£nh 360¬∞
          function view360Image(imageUrl, libraryName) {
            if (!imageUrl || imageUrl === "null") {
              alert(`${libraryName} ch∆∞a c√≥ ·∫£nh 360¬∞!`);
              return;
            }

            console.log("üì∏ Xem ·∫£nh 360¬∞:", imageUrl);

            // T·∫°o modal ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh 360¬∞
            const modal = document.createElement("div");
            modal.className = "modal fade";
            modal.id = "image360Modal";
            modal.innerHTML = `
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">·∫¢nh 360¬∞ - ${libraryName}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body text-center">
                    <img src="${imageUrl}" alt="${libraryName}" style="width: 100%; height: auto; border-radius: 8px;">
                  </div>
                </div>
              </div>
            `;

            document.body.appendChild(modal);

            // Hi·ªÉn th·ªã modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // X√≥a modal khi ƒë√≥ng
            modal.addEventListener("hidden.bs.modal", () => {
              document.body.removeChild(modal);
            });
          }

          // H√†m kh√¥i ph·ª•c hi·ªÉn th·ªã t·∫•t c·∫£ th∆∞ vi·ªán
          function restoreAllLibraries() {
            console.log(" Kh√¥i ph·ª•c hi·ªÉn th·ªã t·∫•t c·∫£ th∆∞ vi·ªán");

            // X√≥a t·∫•t c·∫£ markers c≈©
            map.eachLayer((layer) => {
              if (
                layer instanceof L.Marker &&
                layer !== currentLocationMarker
              ) {
                map.removeLayer(layer);
              }
            });

            // T·∫£i l·∫°i t·∫•t c·∫£ th∆∞ vi·ªán
            fetch("/data")
              .then((response) => response.json())
              .then((data) => {
                if (data && data.features) {
                  renderAllLibraries(data.features, map, libraryIcon);
                  map.setView([21.0285, 105.8542], 10); // Reset v·ªÅ view m·∫∑c ƒë·ªãnh
                  alert("ƒê√£ kh√¥i ph·ª•c hi·ªÉn th·ªã t·∫•t c·∫£ th∆∞ vi·ªán!");
                }
              })
              .catch((error) => {
                console.error("‚ùå L·ªói khi kh√¥i ph·ª•c th∆∞ vi·ªán:", error);
              });
          }

          // Th√™m ch·ª©c nƒÉng "V·ªã tr√≠ c·ªßa t√¥i"
          const locateButton = document.getElementById("locate-button");
          const locateLoading = document.getElementById("locate-loading");
          let currentLocationMarker = null;

          if (locateButton) {
            locateButton.addEventListener("click", () => {
              console.log("üìç Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'V·ªã tr√≠ c·ªßa t√¥i'");

              if (!navigator.geolocation) {
                alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
                return;
              }

              // Hi·ªÉn th·ªã loading
              locateLoading.style.display = "inline";
              locateButton.disabled = true;

              navigator.geolocation.getCurrentPosition(
                (position) => {
                  console.log("‚úÖ ƒê√£ l·∫•y ƒë∆∞·ª£c v·ªã tr√≠:", position.coords);

                  const { latitude, longitude, accuracy } = position.coords;

                  // X√≥a marker c≈© n·∫øu c√≥
                  if (currentLocationMarker) {
                    map.removeLayer(currentLocationMarker);
                  }

                  // T·∫°o icon v·ªã tr√≠
                  const locationIcon = L.icon({
                    iconUrl: "/images/diem.jpg",
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5],
                  });

                  // Th√™m marker v·ªã tr√≠ hi·ªán t·∫°i
                  currentLocationMarker = L.marker([latitude, longitude], {
                    icon: locationIcon,
                  }).addTo(map);

                  currentLocationMarker
                    .bindPopup(
                      `V·ªã tr√≠ c·ªßa b·∫°n hi·ªán t·∫°i<br>ƒê·ªô ch√≠nh x√°c: ${accuracy.toFixed(
                        0
                      )}m`
                    )
                    .openPopup();

                  // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn v·ªã tr√≠ hi·ªán t·∫°i
                  map.setView([latitude, longitude], 16);

                  console.log("‚úÖ ƒê√£ hi·ªÉn th·ªã v·ªã tr√≠ hi·ªán t·∫°i");

                  // ·∫®n loading
                  locateLoading.style.display = "none";
                  locateButton.disabled = false;
                },
                (error) => {
                  console.error("‚ùå L·ªói khi l·∫•y v·ªã tr√≠:", error);

                  let errorMessage = "L·ªói kh√¥ng x√°c ƒë·ªãnh";
                  switch (error.code) {
                    case error.PERMISSION_DENIED:
                      errorMessage =
                        "Quy·ªÅn truy c·∫≠p v·ªã tr√≠ b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong tr√¨nh duy·ªát.";
                      break;
                    case error.POSITION_UNAVAILABLE:
                      errorMessage =
                        "Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. Vui l√≤ng ki·ªÉm tra GPS/Wi-Fi.";
                      break;
                    case error.TIMEOUT:
                      errorMessage =
                        "H·∫øt th·ªùi gian l·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i.";
                      break;
                  }

                  alert(`L·ªói ƒë·ªãnh v·ªã: ${errorMessage}`);

                  // ·∫®n loading
                  locateLoading.style.display = "none";
                  locateButton.disabled = false;
                },
                {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 60000,
                }
              );
            });

            console.log("‚úÖ ƒê√£ th√™m event listener cho n√∫t 'V·ªã tr√≠ c·ªßa t√¥i'");
          }
          // H√†m t√≠nh kho·∫£ng c√°ch (c·∫£i thi·ªán)
          function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // B√°n k√≠nh Tr√°i ƒê·∫•t (km)
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLon = ((lon2 - lon1) * Math.PI) / 180;
            const a =
              Math.sin(dLat / 2) ** 2 +
              Math.cos((lat1 * Math.PI) / 180) *
                Math.cos((lat2 * Math.PI) / 180) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            console.log(`üìè Kho·∫£ng c√°ch t√≠nh to√°n: ${distance.toFixed(2)} km`);
            return distance;
          }
          // Th√™m ch·ª©c nƒÉng "Th∆∞ vi·ªán g·∫ßn nh·∫•t"
          const nearestButton = document.getElementById(
            "nearest-library-button"
          );
          if (nearestButton) {
            nearestButton.addEventListener("click", () => {
              console.log("üéØ Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'Th∆∞ vi·ªán g·∫ßn nh·∫•t'");

              if (!navigator.geolocation) {
                alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!");
                return;
              }

              navigator.geolocation.getCurrentPosition(
                (position) => {
                  const { latitude, longitude } = position.coords;
                  console.log(" V·ªã tr√≠ hi·ªán t·∫°i:", { latitude, longitude });

                  // T√¨m th∆∞ vi·ªán g·∫ßn nh·∫•t (s·ª≠ d·ª•ng d·ªØ li·ªáu test)
                  const testLibraries = [
                    { name: "Th∆∞ vi·ªán Qu·ªëc gia", lat: 21.0285, lng: 105.8542 },
                    {
                      name: "Th∆∞ vi·ªán Test",
                      lat: 21.07088380428482,
                      lng: 105.77995583357745,
                    },
                  ];

                  let nearestLibrary = null;
                  let minDistance = Infinity;

                  testLibraries.forEach((library) => {
                    const distance = calculateDistance(
                      latitude,
                      longitude,
                      library.lat,
                      library.lng
                    );
                    if (distance < minDistance) {
                      minDistance = distance;
                      nearestLibrary = library;
                    }
                  });

                  if (nearestLibrary) {
                    // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn th∆∞ vi·ªán g·∫ßn nh·∫•t
                    map.setView([nearestLibrary.lat, nearestLibrary.lng], 16);

                    // Hi·ªÉn th·ªã th√¥ng b√°o
                    alert(
                      `Th∆∞ vi·ªán g·∫ßn nh·∫•t: ${
                        nearestLibrary.name
                      }\nKho·∫£ng c√°ch: ${minDistance.toFixed(2)} km`
                    );

                    console.log(
                      "‚úÖ ƒê√£ t√¨m th·∫•y th∆∞ vi·ªán g·∫ßn nh·∫•t:",
                      nearestLibrary
                    );
                  } else {
                    alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán n√†o g·∫ßn b·∫°n!");
                  }
                },
                (error) => {
                  console.error(
                    "‚ùå L·ªói khi l·∫•y v·ªã tr√≠ cho th∆∞ vi·ªán g·∫ßn nh·∫•t:",
                    error
                  );
                  alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i.");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
              );
            });

            console.log(
              "‚úÖ ƒê√£ th√™m event listener cho n√∫t 'Th∆∞ vi·ªán g·∫ßn nh·∫•t'"
            );
          }

          // H√†m t√≠nh kho·∫£ng c√°ch
          function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // B√°n k√≠nh Tr√°i ƒê·∫•t (km)
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLon = ((lon2 - lon1) * Math.PI) / 180;
            const a =
              Math.sin(dLat / 2) ** 2 +
              Math.cos((lat1 * Math.PI) / 180) *
                Math.cos((lat2 * Math.PI) / 180) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
          }
                     

          // H√†m ∆∞·ªõc t√≠nh th·ªùi gian di chuy·ªÉn
          function estimateTravelTime(distance) {
            // T·ªëc ƒë·ªô trung b√¨nh: ƒëi b·ªô 5 km/h, xe m√°y 30 km/h
            const walkingSpeed = 5; // km/h
            const motorbikeSpeed = 30; // km/h
            
            const walkingTime = (distance / walkingSpeed) * 60; // ph√∫t
            const motorbikeTime = (distance / motorbikeSpeed) * 60; // ph√∫t
            
            console.log(`‚è±Ô∏è Th·ªùi gian ∆∞·ªõc t√≠nh: ƒêi b·ªô ${Math.round(walkingTime)} ph√∫t, Xe m√°y ${Math.round(motorbikeTime)} ph√∫t`);
            
            return {
              walking: walkingTime,
              motorbike: motorbikeTime
            };
          }

          // Th√™m ch·ª©c nƒÉng "Th∆∞ vi·ªán g·∫ßn nh·∫•t"

          // X·ª≠ l√Ω n√∫t "B·ªô l·ªçc"
          const filterButton = document.getElementById("filter-button");
          if (filterButton) {
            filterButton.addEventListener("click", () => {
              console.log("üîç Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'B·ªô l·ªçc'");
              // M·ªü modal b·ªô l·ªçc
              const filterModal = new bootstrap.Modal(
                document.getElementById("filterModal")
              );
              filterModal.show();
            });
          }

          // X·ª≠ l√Ω n√∫t "√Åp d·ª•ng b·ªô l·ªçc"
          const applyFilterButton = document.getElementById("apply-filter");
          if (applyFilterButton) {
            applyFilterButton.addEventListener("click", () => {
              console.log("‚úÖ Ng∆∞·ªùi d√πng nh·∫•n n√∫t '√Åp d·ª•ng b·ªô l·ªçc'");
              applyFilters();
            });
          }

          // X·ª≠ l√Ω n√∫t "ƒê·∫∑t l·∫°i b·ªô l·ªçc"
          const resetFilterButton = document.getElementById("reset-filter");
          if (resetFilterButton) {
            resetFilterButton.addEventListener("click", () => {
              console.log("üîÑ Ng∆∞·ªùi d√πng nh·∫•n n√∫t 'ƒê·∫∑t l·∫°i b·ªô l·ªçc'");
              resetFilters();
            });
          }

          // X·ª≠ l√Ω n√∫t "ƒê√≥ng" modal b·ªô l·ªçc
          const closeFilterButton = document.querySelector(
            "#filterModal .btn-secondary"
          );
          if (closeFilterButton) {
            closeFilterButton.addEventListener("click", () => {
              console.log("‚ùå Ng∆∞·ªùi d√πng ƒë√≥ng modal b·ªô l·ªçc");
            });
          }

          // H√†m ƒë·∫∑t l·∫°i b·ªô l·ªçc
          function resetFilters() {
            console.log("üîÑ ƒêang ƒë·∫∑t l·∫°i b·ªô l·ªçc...");

            // Reset t·∫•t c·∫£ checkbox v·ªÅ false
            document.getElementById("filter-wifi").checked = false;
            document.getElementById("filter-phong-doc").checked = false;
            document.getElementById("filter-canteen").checked = false;
            document.getElementById("filter-dieu-hoa").checked = false;

            // Reset select v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh
            document.getElementById("filter-phanloai").value = "";

            // Reset input text v·ªÅ r·ªóng
            document.getElementById("filter-genre").value = "";
            document.getElementById("filter-book-name").value = "";

            console.log("‚úÖ ƒê√£ ƒë·∫∑t l·∫°i t·∫•t c·∫£ b·ªô l·ªçc");
          }

          // H√†m √°p d·ª•ng b·ªô l·ªçc
          function applyFilters() {
            console.log("üîç ƒêang √°p d·ª•ng b·ªô l·ªçc...");

            try {
              // L·∫•y gi√° tr·ªã t·ª´ c√°c input b·ªô l·ªçc
              const wifiFilter = document.getElementById("filter-wifi").checked;
              const phongDocFilter =
                document.getElementById("filter-phong-doc").checked;
              const canteenFilter =
                document.getElementById("filter-canteen").checked;
              const dieuHoaFilter =
                document.getElementById("filter-dieu-hoa").checked;
              const phanLoaiFilter =
                document.getElementById("filter-phanloai").value;
              const genreFilter = document
                .getElementById("filter-genre")
                .value.trim()
                .toLowerCase();
              const bookNameFilter = document
                .getElementById("filter-book-name")
                .value.trim()
                .toLowerCase();

              // T·∫°o t√≥m t·∫Øt b·ªô l·ªçc ƒë·ªÉ hi·ªÉn th·ªã
              let filterSummary = "üéØ B·ªò L·ªåC ƒê√É CH·ªåN:\n";
              if (wifiFilter) filterSummary += "‚úÖ Wifi\n";
              if (phongDocFilter) filterSummary += "‚úÖ Ph√≤ng ƒë·ªçc\n";
              if (canteenFilter) filterSummary += "‚úÖ Canteen\n";
              if (dieuHoaFilter) filterSummary += "‚úÖ ƒêi·ªÅu h√≤a\n";
              if (phanLoaiFilter)
                filterSummary += `‚úÖ Lo·∫°i: ${phanLoaiFilter}\n`;
              if (genreFilter) filterSummary += `‚úÖ Th·ªÉ lo·∫°i: ${genreFilter}\n`;
              if (bookNameFilter)
                filterSummary += `‚úÖ T√™n s√°ch: ${bookNameFilter}\n`;

              console.log(filterSummary);
              console.log(" Gi√° tr·ªã b·ªô l·ªçc chi ti·∫øt:", {
                wifi: wifiFilter,
                phongDoc: phongDocFilter,
                canteen: canteenFilter,
                dieuHoa: dieuHoaFilter,
                phanLoai: phanLoaiFilter,
                genre: genreFilter,
                bookName: bookNameFilter,
              });

              // Ki·ªÉm tra xem c√≥ b·ªô l·ªçc n√†o ƒë∆∞·ª£c ch·ªçn kh√¥ng
              const hasFilters =
                wifiFilter ||
                phongDocFilter ||
                canteenFilter ||
                dieuHoaFilter ||
                phanLoaiFilter ||
                genreFilter ||
                bookNameFilter;

              if (!hasFilters) {
                alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ti√™u ch√≠ l·ªçc!");
                return;
              }

              // Hi·ªÉn th·ªã loading
              const applyButton = document.getElementById("apply-filter");
              const originalText = applyButton.innerHTML;
              applyButton.innerHTML =
                '<i class="bi bi-hourglass-split spin"></i> ƒêang l·ªçc...';
              applyButton.disabled = true;

              // T·∫£i d·ªØ li·ªáu v√† √°p d·ª•ng b·ªô l·ªçc
              fetch("/data")
                .then((response) => {
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
                })
                .then((data) => {
                  console.log("üìä D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);

                  if (data && data.features && Array.isArray(data.features)) {
                    const filteredLibraries = filterLibraries(data.features, {
                      wifi: wifiFilter,
                      phongDoc: phongDocFilter,
                      canteen: canteenFilter,
                      dieuHoa: dieuHoaFilter,
                      phanLoai: phanLoaiFilter,
                      genre: genreFilter,
                      bookName: bookNameFilter,
                    });

                    console.log(
                      `üîç K·∫øt qu·∫£ l·ªçc: ${filteredLibraries.length} th∆∞ vi·ªán`
                    );

                    if (filteredLibraries.length > 0) {
                      showFilteredResults(filteredLibraries);
                      // ƒê√≥ng modal b·ªô l·ªçc
                      const filterModal = bootstrap.Modal.getInstance(
                        document.getElementById("filterModal")
                      );
                      if (filterModal) {
                        filterModal.hide();
                      }
                    } else {
                      alert(
                        "Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc ƒë√£ ch·ªçn!"
                      );
                    }
                  } else {
                    console.error("‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá:", data);
                    alert("D·ªØ li·ªáu th∆∞ vi·ªán kh√¥ng h·ª£p l·ªá!");
                  }
                })
                .catch((error) => {
                  console.error("‚ùå L·ªói khi √°p d·ª•ng b·ªô l·ªçc:", error);
                  alert(`C√≥ l·ªói x·∫£y ra khi √°p d·ª•ng b·ªô l·ªçc: ${error.message}`);
                })
                .finally(() => {
                  // Kh√¥i ph·ª•c n√∫t
                  applyButton.innerHTML = originalText;
                  applyButton.disabled = false;
                });
            } catch (error) {
              console.error("‚ùå L·ªói trong h√†m applyFilters:", error);
              alert(`L·ªói: ${error.message}`);
            }
          }

          // H√†m l·ªçc th∆∞ vi·ªán theo ti√™u ch√≠
          function filterLibraries(libraries, filters) {
            console.log(" B·∫Øt ƒë·∫ßu l·ªçc th∆∞ vi·ªán v·ªõi ti√™u ch√≠:", filters);
            console.log(" T·ªïng s·ªë th∆∞ vi·ªán c·∫ßn l·ªçc:", libraries.length);

            const filtered = libraries.filter((library) => {
              const properties = library.properties;

              // Debug: Log th√¥ng tin th∆∞ vi·ªán ƒëang l·ªçc
              console.log(` ƒêang l·ªçc th∆∞ vi·ªán: ${properties.TenThuVien}`, {
                Wifi: properties.Wifi,
                PhongDoc: properties.PhongDoc,
                Canteen: properties.Canteen,
                DieuHoa: properties.DieuHoa,
                phanloai: properties.phanloai,
                TheLoaiSach: properties.TheLoaiSach,
                TenSach: properties.TenSach,
              });

              // L·ªçc theo ti·ªán √≠ch
              if (filters.wifi && !properties.Wifi) {
                console.log(
                  `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: Kh√¥ng c√≥ Wifi`
                );
                return false;
              }
              if (filters.phongDoc && !properties.PhongDoc) {
                console.log(
                  `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: Kh√¥ng c√≥ Ph√≤ng ƒë·ªçc`
                );
                return false;
              }
              if (filters.canteen && !properties.Canteen) {
                console.log(
                  `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: Kh√¥ng c√≥ Canteen`
                );
                return false;
              }
              if (filters.dieuHoa && !properties.DieuHoa) {
                console.log(
                  `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: Kh√¥ng c√≥ ƒêi·ªÅu h√≤a`
                );
                return false;
              }

              // L·ªçc theo lo·∫°i th∆∞ vi·ªán
              if (
                filters.phanLoai &&
                properties.phanloai !== filters.phanLoai
              ) {
                console.log(
                  `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: Lo·∫°i kh√¥ng kh·ªõp (${properties.phanloai} !== ${filters.phanLoai})`
                );
                return false;
              }

              // L·ªçc theo th·ªÉ lo·∫°i s√°ch (n·∫øu c√≥ d·ªØ li·ªáu)
              if (filters.genre && properties.TheLoaiSach) {
                const theLoai = properties.TheLoaiSach.toLowerCase();
                if (!theLoai.includes(filters.genre)) {
                  console.log(
                    `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: Th·ªÉ lo·∫°i kh√¥ng kh·ªõp (${theLoai} kh√¥ng ch·ª©a ${filters.genre})`
                  );
                  return false;
                }
              }

              // L·ªçc theo t√™n s√°ch (n·∫øu c√≥ d·ªØ li·ªáu)
              if (filters.bookName && properties.TenSach) {
                const tenSach = properties.TenSach.toLowerCase();
                if (!tenSach.includes(filters.bookName)) {
                  console.log(
                    `‚ùå ${properties.TenThuVien} b·ªã lo·∫°i: T√™n s√°ch kh√¥ng kh·ªõp (${tenSach} kh√¥ng ch·ª©a ${filters.bookName})`
                  );
                  return false;
                }
              }

              console.log(
                `‚úÖ ${properties.TenThuVien} ph√π h·ª£p v·ªõi t·∫•t c·∫£ ti√™u ch√≠`
              );
              return true;
            });

            console.log(
              `üéØ K·∫øt qu·∫£ l·ªçc: ${filtered.length}/${libraries.length} th∆∞ vi·ªán ph√π h·ª£p`
            );
            return filtered;
          }

          // H√†m hi·ªÉn th·ªã modal k·∫øt qu·∫£ b·ªô l·ªçc
          function showFilterResultsModal(message, filteredLibraries) {
            const modal = new bootstrap.Modal(
              document.getElementById("filterResultsModal")
            );
            const content = document.getElementById("filter-results-content");

            // T·∫°o HTML cho n·ªôi dung modal
            let html = `
              <div class="text-center mb-4">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h4 class="text-success mt-2">T√¨m ki·∫øm th√†nh c√¥ng!</h4>
              </div>

              <div class="alert alert-success">
                <strong> T·ªïng s·ªë th∆∞ vi·ªán t√¨m th·∫•y:</strong> ${filteredLibraries.length}
              </div>
            `;

            // Th·ªëng k√™ theo lo·∫°i th∆∞ vi·ªán
            const typeStats = {};
            filteredLibraries.forEach((lib) => {
              const type = lib.properties.phanloai || "Kh√¥ng x√°c ƒë·ªãnh";
              typeStats[type] = (typeStats[type] || 0) + 1;
            });

            if (Object.keys(typeStats).length > 0) {
              html += `
                <div class="card mb-3">
                  <div class="card-header bg-primary text-white">
                    <i class="bi bi-building me-2"></i>Ph√¢n lo·∫°i th∆∞ vi·ªán
                  </div>
                  <div class="card-body">
                    <div class="row">
              `;

              Object.entries(typeStats).forEach(([type, count]) => {
                html += `
                  <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                      <span><i class="bi bi-tag me-2"></i>${type}</span>
                      <span class="badge bg-primary">${count}</span>
                    </div>
                  </div>
                `;
              });

              html += `
                    </div>
                  </div>
                </div>
              `;
            }

            // Th·ªëng k√™ theo ti·ªán √≠ch
            const utilityStats = {
              Wifi: 0,
              "Ph√≤ng ƒë·ªçc": 0,
              Canteen: 0,
              "ƒêi·ªÅu h√≤a": 0,
            };

            filteredLibraries.forEach((lib) => {
              if (lib.properties.Wifi) utilityStats["Wifi"]++;
              if (lib.properties.PhongDoc) utilityStats["Ph√≤ng ƒë·ªçc"]++;
              if (lib.properties.Canteen) utilityStats["Canteen"]++;
              if (lib.properties.DieuHoa) utilityStats["ƒêi·ªÅu h√≤a"]++;
            });

            html += `
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <i class="bi bi-tools me-2"></i>Ti·ªán √≠ch c√≥ s·∫µn
                </div>
                <div class="card-body">
                  <div class="row">
            `;

            Object.entries(utilityStats).forEach(([utility, count]) => {
              if (count > 0) {
                const iconClass =
                  utility === "Wifi"
                    ? "bi-wifi"
                    : utility === "Ph√≤ng ƒë·ªçc"
                    ? "bi-book"
                    : utility === "Canteen"
                    ? "bi-cup-hot"
                    : "bi-snow";
                html += `
                  <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                      <span><i class="bi ${iconClass} me-2"></i>${utility}</span>
                      <span class="badge bg-info">${count}</span>
                    </div>
                  </div>
                `;
              }
            });

            html += `
                  </div>
                </div>
              </div>

              <div class="alert alert-info">
                <i class="bi bi-map me-2"></i>
                <strong>B·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ hi·ªÉn th·ªã ${filteredLibraries.length} th∆∞ vi·ªán ph√π h·ª£p!</strong>
              </div>
            `;

            content.innerHTML = html;
            modal.show();
          }

          // H√†m m∆∞·ª£n s√°ch
          window.borrowBook = function (libraryName, libraryId) {
            console.log(
              " M·ªü modal m∆∞·ª£n s√°ch cho th∆∞ vi·ªán:",
              libraryName,
              "ID:",
              libraryId
            );

            // Test alert ƒë·ªÉ ki·ªÉm tra h√†m c√≥ ƒë∆∞·ª£c g·ªçi kh√¥ng
            alert(
              `üîç Test: H√†m borrowBook ƒë∆∞·ª£c g·ªçi!\nTh∆∞ vi·ªán: ${libraryName}\nID: ${libraryId}`
            );

            // Ki·ªÉm tra quy·ªÅn ng∆∞·ªùi d√πng (ch·ªâ ƒë·ªÉ debug)
            console.log("üîê Th√¥ng tin ng∆∞·ªùi d√πng:", {
              username: '<%= user ? user.username : "Kh√¥ng c√≥" %>',
              role: '<%= user ? user.role : "Kh√¥ng c√≥" %>',
            });

            // Debug: ki·ªÉm tra xem modal c√≥ t·ªìn t·∫°i kh√¥ng
            const modal = document.getElementById("borrowBookModal");
            if (!modal) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y modal m∆∞·ª£n s√°ch!");
              alert("L·ªói: Modal m∆∞·ª£n s√°ch kh√¥ng t·ªìn t·∫°i!");
              return;
            }
            console.log("‚úÖ Modal m∆∞·ª£n s√°ch ƒë√£ t√¨m th·∫•y:", modal);

            // C·∫≠p nh·∫≠t t√™n th∆∞ vi·ªán trong modal
            document.getElementById("borrow-library-name").textContent =
              libraryName;

            // ƒê·∫∑t ng√†y m∆∞·ª£n l√† h√¥m nay
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("borrow-date").value = today;

            // ƒê·∫∑t ng√†y tr·∫£ d·ª± ki·∫øn l√† 14 ng√†y sau
            const returnDate = new Date();
            returnDate.setDate(returnDate.getDate() + 14);
            document.getElementById("return-date").value = returnDate
              .toISOString()
              .split("T")[0];

            // Hi·ªÉn th·ªã modal
            const borrowModal = new bootstrap.Modal(
              document.getElementById("borrowBookModal")
            );
            borrowModal.show();
          };

          // X·ª≠ l√Ω n√∫t g·ª≠i y√™u c·∫ßu m∆∞·ª£n s√°ch
          const submitBorrowButton = document.getElementById("submit-borrow");
          if (submitBorrowButton) {
            submitBorrowButton.addEventListener("click", function () {
              submitBorrowRequest();
            });
          }

          // H√†m g·ª≠i y√™u c·∫ßu m∆∞·ª£n s√°ch
          function submitBorrowRequest() {
            console.log(" ƒêang g·ª≠i y√™u c·∫ßu m∆∞·ª£n s√°ch...");

            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const formData = {
              libraryName: document.getElementById("borrow-library-name")
                .textContent,
              borrowerName: document
                .getElementById("borrower-name")
                .value.trim(),
              borrowerEmail: document
                .getElementById("borrower-email")
                .value.trim(),
              borrowerPhone: document
                .getElementById("borrower-phone")
                .value.trim(),
              borrowDate: document.getElementById("borrow-date").value,
              returnDate: document.getElementById("return-date").value,
              bookCategory: document.getElementById("book-category").value,
              notes: document.getElementById("borrow-notes").value.trim(),
              status: "Ch·ªù x·ª≠ l√Ω",
              createdAt: new Date().toISOString(),
            };

            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
            if (
              !formData.borrowerName ||
              !formData.borrowerEmail ||
              !formData.borrowerPhone ||
              !formData.borrowDate ||
              !formData.returnDate
            ) {
              alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
              return;
            }

            // Hi·ªÉn th·ªã loading
            const submitButton = document.getElementById("submit-borrow");
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML =
              '<i class="bi bi-hourglass-split spin"></i> ƒêang g·ª≠i...';
            submitButton.disabled = true;

            // G·ª≠i d·ªØ li·ªáu ƒë·∫øn server
            fetch("/api/borrow-book", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  console.log("‚úÖ G·ª≠i y√™u c·∫ßu m∆∞·ª£n s√°ch th√†nh c√¥ng:", data);

                  // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                  alert(
                    "‚úÖ Y√™u c·∫ßu m∆∞·ª£n s√°ch ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!\n\n" +
                      " Th√¥ng tin ƒë√£ l∆∞u:\n" +
                      `‚Ä¢ ID y√™u c·∫ßu: ${data.muonSachId}\n` +
                      `‚Ä¢ Th∆∞ vi·ªán: ${formData.libraryName}\n` +
                      `‚Ä¢ H·ªç t√™n: ${formData.borrowerName}\n` +
                      `‚Ä¢ S√°ch: ${data.bookInfo.name}\n` +
                      `‚Ä¢ Ng√†y m∆∞·ª£n: ${formData.borrowDate}\n` +
                      `‚Ä¢ Ng√†y tr·∫£: ${formData.returnDate}\n\n` +
                      "üîÑ ƒêang chuy·ªÉn ƒë·∫øn trang qu·∫£n l√Ω admin..."
                  );

                  // ƒê√≥ng modal
                  const borrowModal = bootstrap.Modal.getInstance(
                    document.getElementById("borrowBookModal")
                  );
                  borrowModal.hide();

                  // Reset form
                  document.getElementById("borrowBookForm").reset();

                  // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang admin qu·∫£n l√Ω m∆∞·ª£n s√°ch
                  setTimeout(() => {
                    window.location.href =
                      data.redirectUrl || "/admin/muon_sach";
                  }, 2000);
                } else {
                  console.error("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu:", data.message);
                  alert("‚ùå C√≥ l·ªói x·∫£y ra: " + data.message);
                }
              })
              .catch((error) => {
                console.error("‚ùå L·ªói network:", error);
                alert("‚ùå C√≥ l·ªói k·∫øt n·ªëi: " + error.message);
              })
              .finally(() => {
                // Kh√¥i ph·ª•c n√∫t
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
              });
          }

          // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ ƒë√£ l·ªçc
          function showFilteredResults(filteredLibraries) {
            console.log(
              `‚úÖ T√¨m th·∫•y ${filteredLibraries.length} th∆∞ vi·ªán ph√π h·ª£p v·ªõi b·ªô l·ªçc`
            );

            // X√≥a t·∫•t c·∫£ markers c≈© (gi·ªØ l·∫°i v·ªã tr√≠ hi·ªán t·∫°i n·∫øu c√≥)
            map.eachLayer((layer) => {
              if (
                layer instanceof L.Marker &&
                layer !== currentLocationMarker
              ) {
                map.removeLayer(layer);
              }
            });

            // Hi·ªÉn th·ªã th√¥ng b√°o k·∫øt qu·∫£ chi ti·∫øt
            const resultMessage = `ƒê√£ t√¨m th·∫•y ${filteredLibraries.length} th∆∞ vi·ªán ph√π h·ª£p v·ªõi b·ªô l·ªçc!`;
            console.log("üì¢ " + resultMessage);

            // T·∫°o th√¥ng b√°o chi ti·∫øt v·ªÅ k·∫øt qu·∫£ l·ªçc
            let detailMessage = `üéØ K·∫æT QU·∫¢ B·ªò L·ªåC:\n\n`;
            detailMessage += ` T·ªïng s·ªë th∆∞ vi·ªán t√¨m th·∫•y: ${filteredLibraries.length}\n\n`;

            // Th·ªëng k√™ theo lo·∫°i th∆∞ vi·ªán
            const typeStats = {};
            filteredLibraries.forEach((lib) => {
              const type = lib.properties.phanloai || "Kh√¥ng x√°c ƒë·ªãnh";
              typeStats[type] = (typeStats[type] || 0) + 1;
            });

            if (Object.keys(typeStats).length > 0) {
              detailMessage += ` Ph√¢n lo·∫°i th∆∞ vi·ªán:\n`;
              Object.entries(typeStats).forEach(([type, count]) => {
                detailMessage += `   ‚Ä¢ ${type}: ${count} th∆∞ vi·ªán\n`;
              });
              detailMessage += `\n`;
            }

            // Th·ªëng k√™ theo ti·ªán √≠ch
            const utilityStats = {
              Wifi: 0,
              "Ph√≤ng ƒë·ªçc": 0,
              Canteen: 0,
              "ƒêi·ªÅu h√≤a": 0,
            };

            filteredLibraries.forEach((lib) => {
              if (lib.properties.Wifi) utilityStats["Wifi"]++;
              if (lib.properties.PhongDoc) utilityStats["Ph√≤ng ƒë·ªçc"]++;
              if (lib.properties.Canteen) utilityStats["Canteen"]++;
              if (lib.properties.DieuHoa) utilityStats["ƒêi·ªÅu h√≤a"]++;
            });

            detailMessage += ` Ti·ªán √≠ch c√≥ s·∫µn:\n`;
            Object.entries(utilityStats).forEach(([utility, count]) => {
              if (count > 0) {
                detailMessage += `   ‚Ä¢ ${utility}: ${count} th∆∞ vi·ªán\n`;
              }
            });

            detailMessage += `\n B·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£!`;

            // Hi·ªÉn th·ªã markers cho k·∫øt qu·∫£ ƒë√£ l·ªçc
            const filterIcon = L.icon({
              iconUrl: "/images/igg.png",
              iconSize: [60, 60],
              iconAnchor: [30, 60],
              popupAnchor: [0, -50],
            });

            let bounds = L.latLngBounds();

            filteredLibraries.forEach((library) => {
              const coords = library.geometry.coordinates;
              const properties = library.properties;

              const marker = L.marker([coords[1], coords[0]], {
                icon: filterIcon,
              }).addTo(map);

              // T·∫°o popup v·ªõi th√¥ng tin th∆∞ vi·ªán
              const popupContent = `
                <div style="min-width: 250px;">
                  <h6 style="color: #0d6efd; margin-bottom: 10px;">
                    <i class="bi bi-building me-2"></i>${properties.TenThuVien}
                  </h6>
                  ${
                    properties.Anh360
                      ? `
                    <div style="margin-bottom: 10px; text-align: center;">
                      <img src="${properties.Anh360}" alt="${properties.TenThuVien}"
                           style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">
                    </div>
                  `
                      : ""
                  }
                  <p style="margin-bottom: 8px;">
                    <i class="bi bi-geo-alt text-success me-2"></i>${
                      properties.DiaChi
                    }
                  </p>
                  <p style="margin-bottom: 8px;">
                    <i class="bi bi-tag text-primary me-2"></i>${
                      properties.phanloai || "Kh√¥ng x√°c ƒë·ªãnh"
                    }
                  </p>
                  <div style="font-size: 12px; color: #6c757d; margin-bottom: 15px;">
                    <span class="me-3">
                      <i class="bi bi-wifi ${
                        properties.Wifi ? "text-success" : "text-muted"
                      }"></i> Wifi
                    </span>
                    <span class="me-3">
                      <i class="bi bi-book ${
                        properties.PhongDoc ? "text-info" : "text-muted"
                      }"></i> Ph√≤ng ƒë·ªçc
                    </span>
                    <span class="me-3">
                      <i class="bi bi-cup-hot ${
                        properties.Canteen ? "text-warning" : "text-muted"
                      }"></i> Canteen
                    </span>
                    <span>
                      <i class="bi bi-snow ${
                        properties.DieuHoa ? "text-primary" : "text-muted"
                      }"></i> ƒêi·ªÅu h√≤a
                    </span>
                  </div>
                  <div class="d-flex gap-2">
                                          <button class="btn btn-sm btn-outline-primary" onclick="showDirections(${
                        coords[1]
                      }, ${coords[0]}, '${properties.TenThuVien}')">
                        <i class="bi bi-route"></i> Ch·ªâ ƒë∆∞·ªùng
                      </button>
                    <button class="btn btn-sm btn-outline-success" onclick="borrowBook('${
                      properties.TenThuVien
                    }', ${
                properties.ID
              })" style="border: 2px solid #28a745; font-weight: bold; background-color: #d4edda;">
                      <i class="bi bi-book"></i> M∆∞·ª£n s√°ch
                    </button>
                    ${
                      properties.Anh360
                        ? `
                      <button class="btn btn-sm btn-outline-info" onclick="view360Image('${properties.Anh360}', '${properties.TenThuVien}')">
                        <i class="bi bi-camera"></i> 360¬∞
                      </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              `;

              marker.bindPopup(popupContent);
              bounds.extend([coords[1], coords[0]]);
            });

            // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£ k·∫øt qu·∫£
            if (bounds.isValid()) {
              map.fitBounds(bounds, { padding: [20, 20] });
            }

            // Hi·ªÉn th·ªã modal k·∫øt qu·∫£ chi ti·∫øt
            setTimeout(() => {
              showFilterResultsModal(detailMessage, filteredLibraries);
            }, 500);
          }

          // H√†m hi·ªÉn th·ªã modal ƒë√°nh gi√°
          function showRatingModal(libraryId, libraryName) {
            console.log("‚≠ê M·ªü modal ƒë√°nh gi√°:", { libraryId, libraryName });

            const modal = document.getElementById("ratingModal");
            const libraryNameElement =
              document.getElementById("ratingLibraryName");
            const libraryIdInput = document.getElementById("ratingLibraryId");

            if (!modal || !libraryNameElement || !libraryIdInput) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y c√°c element modal ƒë√°nh gi√°");
              alert("L·ªói: Modal ƒë√°nh gi√° kh√¥ng t·ªìn t·∫°i!");
              return;
            }

            libraryNameElement.textContent = libraryName;
            libraryIdInput.value = libraryId;

            // Reset form
            const form = document.getElementById("ratingForm");
            if (form) {
              form.reset();
              libraryIdInput.value = libraryId; // ƒê·∫∑t l·∫°i ID sau khi reset
            }

            // Reset stars
            const stars = document.querySelectorAll(
              '.rating-stars input[type="radio"]'
            );
            stars.forEach((star) => (star.checked = false));

            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            console.log("‚úÖ Modal ƒë√°nh gi√° ƒë√£ m·ªü");
          }

          // S·ª≠a h√†m submitRating (d√≤ng 2571-2657) - th√™m window.
          window.submitRating = async function () {
            console.log("‚≠ê B·∫Øt ƒë·∫ßu g·ª≠i ƒë√°nh gi√°...");

            const form = document.getElementById("ratingForm");
            if (!form) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y form ƒë√°nh gi√°");
              alert("L·ªói: Form ƒë√°nh gi√° kh√¥ng t·ªìn t·∫°i!");
              return;
            }

            const formData = new FormData(form);
            const ratingData = {
              libraryId: formData.get("libraryId"),
              rating: formData.get("rating"),
              userName: formData.get("userName"),
              comment: formData.get("comment"),
            };

            console.log("‚≠ê D·ªØ li·ªáu ƒë√°nh gi√°:", ratingData);

            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
            if (
              !ratingData.libraryId ||
              !ratingData.rating ||
              !ratingData.userName
            ) {
              alert("‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
              return;
            }

            // Validate rating
            const rating = parseInt(ratingData.rating);
            if (rating < 1 || rating > 5) {
              alert("‚ùå ƒêi·ªÉm ƒë√°nh gi√° ph·∫£i t·ª´ 1 ƒë·∫øn 5 sao!");
              return;
            }

            // T√¨m n√∫t submit v√† hi·ªÉn th·ªã loading
            const submitButton = document.querySelector(
              "#ratingModal .btn-warning"
            );
            let originalText = "";

            if (submitButton) {
              originalText = submitButton.innerHTML;
              submitButton.innerHTML =
                '<i class="bi bi-hourglass-split spin"></i> ƒêang g·ª≠i...';
              submitButton.disabled = true;
            }

            try {
              const response = await fetch("/api/rate-library", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(ratingData),
              });

              const result = await response.json();
              console.log("üì° K·∫øt qu·∫£ API:", result);

              if (result.success) {
                alert(
                  "‚úÖ ƒê√°nh gi√° th√†nh c√¥ng!\nC·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√° th∆∞ vi·ªán!"
                );

                // ƒê√≥ng modal
                const modal = bootstrap.Modal.getInstance(
                  document.getElementById("ratingModal")
                );
                if (modal) {
                  modal.hide();
                }

                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë√°nh gi√° tr√™n b·∫£n ƒë·ªì
                updateLibraryRating(ratingData.libraryId, ratingData.rating);
              } else {
                alert("‚ùå C√≥ l·ªói x·∫£y ra: " + result.message);
              }
            } catch (error) {
              console.error("‚ùå L·ªói khi g·ª≠i ƒë√°nh gi√°:", error);
              alert("‚ùå C√≥ l·ªói k·∫øt n·ªëi: " + error.message);
            } finally {
              // Kh√¥i ph·ª•c n√∫t
              if (submitButton && originalText) {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
              }
            }
          };

          // H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë√°nh gi√° tr√™n b·∫£n ƒë·ªì
          function updateLibraryRating(libraryId, newRating) {
            // T√¨m marker t∆∞∆°ng ·ª©ng v√† c·∫≠p nh·∫≠t popup
            map.eachLayer((layer) => {
              if (layer instanceof L.Marker && layer.libraryId === libraryId) {
                const popup = layer.getPopup();
                if (popup) {
                  // C·∫≠p nh·∫≠t n·ªôi dung popup v·ªõi ƒë√°nh gi√° m·ªõi
                  const popupContent = popup.getContent();
                  // C√≥ th·ªÉ c·∫≠p nh·∫≠t popup content ·ªü ƒë√¢y n·∫øu c·∫ßn
                }
              }
            });
          }

          // C·∫≠p nh·∫≠t h√†m t·∫°o popup ƒë·ªÉ th√™m n√∫t ƒë√°nh gi√°
          function createLibraryPopup(library) {
            const ratingStars = "‚≠ê".repeat(library.rating || 0);
            const ratingText = library.rating
              ? `${ratingStars} (${library.rating}/5)`
              : "Ch∆∞a c√≥ ƒë√°nh gi√°";

            return `
                <div class="library-popup">
                    <h5 class="fw-bold text-primary">${library.ten_thuvien}</h5>
                    <p class="mb-2"><i class="bi bi-geo-alt"></i> ${library.dia_chi}</p>
                    <p class="mb-2"><i class="bi bi-telephone"></i> ${library.so_dien_thoai}</p>
                    <p class="mb-2"><i class="bi bi-envelope"></i> ${library.email}</p>
                    <p class="mb-2"><i class="bi bi-star"></i> ${ratingText}</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" onclick="showLibraryDetails('${library.id_thuvien}')">
                            <i class="bi bi-info-circle"></i> Xem chi ti·∫øt
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showRatingModal('${library.id_thuvien}', '${library.ten_thuvien}')">
                            <i class="bi bi-star"></i> ƒê√°nh gi√°
                        </button>
                        <button class="btn btn-success btn-sm" onclick="showBorrowModal('${library.id_thuvien}', '${library.ten_thuvien}')">
                            <i class="bi bi-book"></i> M∆∞·ª£n s√°ch
                        </button>
                    </div>
                </div>
            `;
          }

          // Th√™m h√†m openRatingModal ƒë·ªÉ t∆∞∆°ng th√≠ch (sau d√≤ng 2535)
          window.openRatingModal = function (libraryId, libraryName) {
            showRatingModal(libraryId, libraryName);
          };

          // Th√™m h√†m xem s√°ch th∆∞ vi·ªán (d√πng modal s·∫µn c√≥ #booksModal)
          window.viewLibraryBooks = function (libraryId, libraryName) {
            console.log("üìö Xem s√°ch th∆∞ vi·ªán:", libraryId, libraryName);
            const booksModalEl = document.getElementById("booksModal");
            const booksContent = document.getElementById("books-content");
            if (!booksModalEl || !booksContent) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y modal #booksModal ho·∫∑c #books-content");
              return;
            }
            booksContent.innerHTML = `
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </div>
            `;
            const bsModal = new bootstrap.Modal(booksModalEl);
            bsModal.show();
            loadLibraryBooksForMap(libraryId);
          };

          // H√†m t·∫£i s√°ch cho b·∫£n ƒë·ªì
          async function loadLibraryBooksForMap(libraryId) {
            const content = document.getElementById("books-content");

            try {
              const response = await fetch(`/admin/thu_vien/books/${libraryId}`);
              const data = await response.json();

              if (data.success) {
                let html = `
                  <div class="row mb-3">
                    <div class="col-12">
                      <h6><i class="bi bi-building me-2"></i>Th∆∞ vi·ªán: ${data.library.ten_thuvien}</h6>
                      <p class="text-muted"><i class="bi bi-geo-alt me-2"></i>${data.library.dia_chi}</p>
                    </div>
                  </div>
                `;

                if (data.books.length === 0) {
                  html += `
                    <div class="alert alert-info text-center">
                      <i class="bi bi-info-circle me-2"></i>
                      Th∆∞ vi·ªán n√†y ch∆∞a c√≥ s√°ch n√†o
                    </div>
                  `;
                } else {
                  html += `
                    <div class="table-responsive">
                      <table class="table table-hover table-sm">
                        <thead class="table-light">
                          <tr>
                            <th>T√™n s√°ch</th>
                            <th>T√°c gi·∫£</th>
                            <th>Th·ªÉ lo·∫°i</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>File s·ªë</th>
                          </tr>
                        </thead>
                        <tbody>
                  `;

                  data.books.forEach((book) => {
                    html += `
                      <tr>
                        <td><strong>${book.ten_sach}</strong></td>
                        <td>${book.tac_gia || "Kh√¥ng c√≥"}</td>
                        <td>${book.ten_theloai || "Kh√¥ng c√≥"}</td>
                        <td>
                          <span class="badge bg-primary">${
                            book.so_luong_trong_thu_vien || 0
                          }</span>
                        </td>
                        <td>
                          ${
                            book.digital_file
                              ? `<a href="${book.digital_file}" target="_blank" class="btn btn-sm btn-outline-secondary">
                              <i class="bi bi-file-earmark-pdf"></i>
                            </a>`
                              : '<span class="text-muted">Kh√¥ng c√≥</span>'
                          }
                        </td>
                      </tr>
                    `;
                  });

                  html += `
                        </tbody>
                      </table>
                    </div>
                  `;
                }

                content.innerHTML = html;
              } else {
                content.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    L·ªói: ${data.error}
                  </div>
                `;
              }
            } catch (error) {
              console.error("‚ùå L·ªói khi t·∫£i s√°ch:", error);
              content.innerHTML = `
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  L·ªói k·∫øt n·ªëi: ${error.message}
                </div>
              `;
            }
          }

          // M·ªü trang ch·ªânh s·ª≠a th∆∞ vi·ªán (d√†nh cho admin)
          window.openAdminEdit = function (libraryId) {
            try {
              if (!libraryId) return;
              window.location.href = `/admin/thu_vien/update/${libraryId}`;
            } catch (e) {
              console.error('Kh√¥ng th·ªÉ m·ªü trang ch·ªânh s·ª≠a:', e);
            }
          }

          // H√†m t·∫£i nhanh danh s√°ch s√°ch ƒë·ªÉ hi·ªÉn th·ªã trong popup
          async function fetchAndRenderLibraryBooksPreview(libraryId, containerId) {
            try {
              const container = document.getElementById(containerId);
              if (!container) return;
              const res = await fetch(`/admin/thu_vien/books/${libraryId}`);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const data = await res.json();
              if (!data.success) {
                container.innerHTML = `<span class="text-danger">L·ªói t·∫£i s√°ch</span>`;
                return;
              }
              const books = Array.isArray(data.books) ? data.books : [];
              if (books.length === 0) {
                container.innerHTML = `<span class="text-muted">Ch∆∞a c√≥ s√°ch</span>`;
                return;
              }
              const top = books.slice(0, 5);
              const list = top
                .map(
                  (b) => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <div style="max-width: 70%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <strong>${escapeHTML(b.ten_sach || '')}</strong>
                        <small class="text-muted">${escapeHTML(b.tac_gia || '')}</small>
                      </div>
                      <span class="badge bg-primary">${b.so_luong || b.so_luong_trong_thu_vien || 0}</span>
                    </div>`
                )
                .join("");
              container.innerHTML = `
                <div style="margin-bottom:6px">
                  <strong>T·ªïng s√°ch:</strong> <span class="badge bg-success">${books.length}</span>
                </div>
                ${list}
                ${books.length > 5 ? `<div class="text-muted" style="font-size:12px">...v√† c√≤n ${books.length - 5} s√°ch kh√°c</div>` : ''}
              `;
            } catch (e) {
              const container = document.getElementById(containerId);
              if (container) container.innerHTML = `<span class="text-danger">L·ªói k·∫øt n·ªëi</span>`;
              console.error('L·ªói preview s√°ch:', e);
            }
          }

          // Utility escape HTML ƒë·ªÉ tr√°nh ch√®n k√Ω t·ª± ƒë·∫∑c bi·ªát v√†o popup
          function escapeHTML(value) {
            const str = String(value ?? "");
            return str
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#39;");
          }

          // Th√™m h√†m hi·ªÉn th·ªã s√°ch c·ªßa th∆∞ vi·ªán
          async function showLibraryBooks(libraryId, libraryName) {
            try {
              console.log("üìö Hi·ªÉn th·ªã s√°ch th∆∞ vi·ªán:", {
                libraryId,
                libraryName,
              });

              const response = await fetch(
                `/admin/thu_vien/books/${libraryId}`
              );
              const data = await response.json();

              if (data.success) {
                displayBooksModal(data.library, data.books);
              } else {
                alert("L·ªói: " + data.message);
              }
            } catch (error) {
              console.error("‚ùå L·ªói khi l·∫•y s√°ch th∆∞ vi·ªán:", error);
              alert("C√≥ l·ªói x·∫£y ra khi l·∫•y s√°ch th∆∞ vi·ªán");
            }
          }

          // H√†m hi·ªÉn th·ªã modal s√°ch
          function displayBooksModal(library, books) {
            const modal = document.getElementById("booksModal");
            if (!modal) {
              // T·∫°o modal n·∫øu ch∆∞a c√≥
              createBooksModal();
            }

            const modalTitle = document.getElementById("booksModalTitle");
            const booksList = document.getElementById("booksList");

            modalTitle.textContent = `S√°ch c·ªßa ${library.ten_thuvien}`;

            if (books.length === 0) {
              booksList.innerHTML =
                '<p class="text-muted">Th∆∞ vi·ªán ch∆∞a c√≥ s√°ch n√†o</p>';
            } else {
              booksList.innerHTML = books
                .map(
                  (book) => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">${book.ten_sach}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    T√°c gi·∫£: ${book.tac_gia} | 
                                    NƒÉm: ${book.nam_xuat_ban} | 
                                    Th·ªÉ lo·∫°i: ${book.ten_theloai}
                                </small>
                            </p>
                            <div class="row">
                                <div class="col-6">
                                    <span class="badge bg-primary">S·ªë l∆∞·ª£ng: ${book.so_luong}</span>
                                </div>
                                <div class="col-6">
                                    <span class="badge bg-success">T·ªïng: ${book.tongsl}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
                )
                .join("");
            }

            // Hi·ªÉn th·ªã modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
          }

          // T·∫°o modal s√°ch
          function createBooksModal() {
            const modalHTML = `
                <div class="modal fade" id="booksModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="booksModalTitle">S√°ch c·ªßa th∆∞ vi·ªán</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="booksList"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML("beforeend", modalHTML);
          }
        } catch (error) {
          console.error("‚ùå L·ªói khi kh·ªüi t·∫°o b·∫£n ƒë·ªì:", error);
          alert("C√≥ l·ªói x·∫£y ra khi kh·ªüi t·∫°o b·∫£n ƒë·ªì!");
        }
      } else {
        console.error("‚ùå Leaflet ch∆∞a ƒë∆∞·ª£c load");
        alert("L·ªói: Leaflet ch∆∞a ƒë∆∞·ª£c load!");
      }
    </script>
  </body>
</html>
