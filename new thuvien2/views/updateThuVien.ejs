<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sửa Thư Viện</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/thuvien.css" />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
          <a class="navbar-brand" href="/admin">Sửa Thư Viện</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navMain"
            aria-controls="navMain"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/admin">Trang chủ</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/thu_vien">Thư viện</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/the_loai">Thể loại</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/sach">Sách</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/muon_sach">Mượn Sách</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-warning fw-bold" href="/">
                  <i class="bi bi-geo-alt-fill"></i> Xem Bản đồ
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-pencil-square"></i> Sửa Thư Viện</h2>
        <a href="/admin/thu_vien" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Quay lại
        </a>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">Thông tin thư viện</h5>
        </div>
        <div class="card-body">
          <form
            id="editLibraryForm"
            method="POST"
            action="/admin/thu_vien/update/<%= thu_vien.id_thuvien %>"
            enctype="multipart/form-data"
          >
            <input
              type="hidden"
              name="ID_thuvien"
              value="<%= thu_vien.id_thuvien %>"
            />
            <input
              type="hidden"
              name="currentAnh360"
              value="<%= thu_vien.anh_360 || '' %>"
            />

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">ID Thư viện</label>
                <input
                  type="text"
                  name="ID_thuvien_display"
                  class="form-control"
                  value="<%= thu_vien.id_thuvien %>"
                  disabled
                />
                <small class="form-text text-muted"
                  >ID thư viện không thể thay đổi</small
                >
              </div>
              <div class="col-md-8">
                <label class="form-label">Tên thư viện *</label>
                <input
                  type="text"
                  name="Ten_thuvien"
                  class="form-control"
                  placeholder="Tên thư viện"
                  value="<%= thu_vien.ten_thuvien || '' %>"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label">Địa chỉ</label>
                <input
                  type="text"
                  name="Dia_chi"
                  class="form-control"
                  placeholder="Địa chỉ"
                  value="<%= thu_vien.dia_chi || '' %>"
                />
              </div>
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Wifi"
                        id="wifi"
                        <%= thu_vien.wifi ? 'checked' : '' %>
                      />
                      <label class="form-check-label" for="wifi">Wifi</label>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Phongdoc"
                        id="phongdoc"
                        <%= thu_vien.phongdoc ? 'checked' : '' %>
                      />
                      <label class="form-check-label" for="phongdoc"
                        >Phòng đọc</label
                      >
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Canteen"
                        id="canteen"
                        <%= thu_vien.canteen ? 'checked' : '' %>
                      />
                      <label class="form-check-label" for="canteen"
                        >Canteen</label
                      >
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Dieuhoa"
                        id="dieuhoa"
                        <%= thu_vien.dieuhoa ? 'checked' : '' %>
                      />
                      <label class="form-check-label" for="dieuhoa"
                        >Điều hòa</label
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Latitude</label>
                <input
                  type="number"
                  name="Latitude"
                  placeholder="Latitude"
                  step="any"
                  class="form-control"
                  value="<%= thu_vien.latitude || '' %>"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Longitude</label>
                <input
                  type="number"
                  name="Longitude"
                  placeholder="Longitude"
                  step="any"
                  class="form-control"
                  value="<%= thu_vien.longitude || '' %>"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Loại thư viện *</label>
                <select name="phanloai" class="form-select" required>
                  <option value="" disabled>Chọn loại thư viện</option>
                  <option
                    value="Thư viện công cộng"
                    <%= thu_vien.phanloai === 'Thư viện công cộng' ? 'selected' : '' %>
                  >
                    Thư viện công cộng
                  </option>
                  <option
                    value="Thư viện tư nhân"
                    <%= thu_vien.phanloai === 'Thư viện tư nhân' ? 'selected' : '' %>
                  >
                    Thư viện tư nhân
                  </option>
                  <option
                    value="Thư viện trường học"
                    <%= thu_vien.phanloai === 'Thư viện trường học' ? 'selected' : '' %>
                  >
                    Thư viện trường học
                  </option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Ảnh 360</label>
                <div class="input-group">
                  <input
                    type="text"
                    name="Anh360Path"
                    id="Anh360Path"
                    class="form-control"
                    placeholder="Đường dẫn ảnh hoặc chọn file"
                    readonly
                    value="<%= thu_vien.anh_360 || '' %>"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    onclick="selectImage()"
                  >
                    <i class="bi bi-folder-open"></i> Chọn
                  </button>
                </div>
                <input
                  type="file"
                  name="Anh360"
                  id="Anh360"
                  accept="image/*"
                  class="form-control mt-2"
                  onchange="handleImageSelection(this)"
                  style="display: none"
                />
                <small class="form-text text-muted">
                  Hoặc nhập đường dẫn trực tiếp (VD: C:\\Images\\thuvien.jpg)
                </small>
                <% if (thu_vien.anh_360) { %>
                <div class="mt-2">
                  <p class="mb-1">
                    <small>Ảnh hiện tại:</small>
                  </p>
                  <a
                    href="<%= thu_vien.anh_360 %>"
                    target="_blank"
                    class="btn btn-sm btn-outline-info"
                  >
                    <i class="bi bi-image"></i> Xem ảnh hiện tại
                  </a>
                </div>
                <% } %>
                <div id="imagePreview" class="mt-2" style="display: none">
                  <img
                    id="previewImg"
                    class="img-thumbnail"
                    style="max-width: 200px; max-height: 200px"
                  />
                </div>
              </div>
              <div class="col-12">
                <div id="errorMessage" class="alert alert-danger" style="display: none"></div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check-circle"></i> Cập nhật Thư viện
                </button>
                <a href="/admin/thu_vien" class="btn btn-secondary ms-2">
                  <i class="bi bi-x-circle"></i> Hủy
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      function previewImage(input) {
        const preview = document.getElementById("imagePreview");
        const previewImg = document.getElementById("previewImg");

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImg.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          preview.style.display = "none";
        }
      }

      function selectImage() {
        document.getElementById("Anh360").click();
      }

      function handleImageSelection(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const pathInput = document.getElementById("Anh360Path");
          pathInput.value = file.name;
          previewImage(input);
        }
      }

      // Xử lý form submission
      document
        .getElementById("editLibraryForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const errorDiv = document.getElementById("errorMessage");
          const submitBtn = event.target.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.innerHTML;

          errorDiv.style.display = "none";
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...';

          const formData = new FormData(event.target);

          try {
            const response = await fetch(event.target.action, {
              method: "POST",
              body: formData,
            });

            if (response.ok) {
              // Nếu redirect thành công, chuyển hướng
              if (response.redirected) {
                window.location.href = response.url;
              } else {
                // Nếu trả về JSON
                const data = await response.json();
                if (data.success) {
                  alert("✅ Cập nhật thư viện thành công!");
                  window.location.href = "/admin/thu_vien";
                } else {
                  throw new Error(data.error || "Có lỗi xảy ra");
                }
              }
            } else {
              const errorText = await response.text();
              throw new Error(errorText || `HTTP error! status: ${response.status}`);
            }
          } catch (error) {
            console.error("Lỗi khi cập nhật:", error);
            errorDiv.textContent = `Lỗi: ${error.message}`;
            errorDiv.style.display = "block";
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
          }
        });
    </script>
  </body>
</html>
