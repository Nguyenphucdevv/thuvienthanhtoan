<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Th∆∞ Vi·ªán</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    <!-- Favicon - File JPG -->
    <!-- ƒê·∫£m b·∫£o file thuvienavt.jpg n·∫±m trong th∆∞ m·ª•c public/images/ -->
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/thuvien.css" />

    <!-- Script ƒë·ªãnh nghƒ©a c√°c h√†m global TR∆Ø·ªöC KHI body render -->
    <script>
      // ===== H√ÄM X·ª¨ L√ù X√ìA TH∆Ø VI·ªÜN - ƒê·ªäNH NGHƒ®A S·ªöM =====
      window.handleDeleteLibraryClick = async function (id, name) {
        console.log("üóëÔ∏è ===== handleDeleteLibraryClick CALLED =====");
        console.log("üóëÔ∏è ID:", id);
        console.log("üóëÔ∏è Name:", name);

        if (!id) {
          alert("‚ùå Kh√¥ng t√¨m th·∫•y ID th∆∞ vi·ªán");
          console.error("‚ùå ID is empty or undefined");
          return;
        }

        const libraryName = name || "th∆∞ vi·ªán n√†y";
        console.log("üóëÔ∏è Library name:", libraryName);

        const confirmMessage = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th∆∞ vi·ªán "${libraryName}"?\n\nL∆∞u √Ω: T·∫•t c·∫£ s√°ch trong th∆∞ vi·ªán n√†y c≈©ng s·∫Ω b·ªã x√≥a kh·ªèi danh s√°ch.`;
        console.log("üóëÔ∏è Confirm message:", confirmMessage);

        const confirmed = confirm(confirmMessage);
        console.log("üóëÔ∏è User confirmed:", confirmed);

        if (confirmed) {
          try {
            console.log("üóëÔ∏è ƒêang g·ª≠i y√™u c·∫ßu x√≥a th∆∞ vi·ªán ID:", id);
            const url = `/admin/thu_vien/delete/${id}`;
            console.log("üóëÔ∏è URL:", url);

            const response = await fetch(url, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            });

            console.log("üì• Response status:", response.status);
            console.log("üì• Response ok:", response.ok);

            let result;
            try {
              result = await response.json();
              console.log("üì• Response JSON:", result);
            } catch (jsonError) {
              const text = await response.text();
              console.error("‚ùå Kh√¥ng parse ƒë∆∞·ª£c JSON:", text);
              console.error("‚ùå JSON Error:", jsonError);
              throw new Error(`Server tr·∫£ v·ªÅ l·ªói: ${text}`);
            }

            if (response.ok && result.success) {
              alert("‚úÖ " + (result.message || "X√≥a th∆∞ vi·ªán th√†nh c√¥ng!"));
              console.log("‚úÖ X√≥a th√†nh c√¥ng, ƒëang reload trang...");
              window.location.reload();
            } else {
              alert("‚ùå L·ªói: " + (result.error || "Kh√¥ng th·ªÉ x√≥a th∆∞ vi·ªán"));
              console.error("‚ùå L·ªói x√≥a th∆∞ vi·ªán:", result);
            }
          } catch (error) {
            console.error("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a:", error);
            console.error("‚ùå Error stack:", error.stack);
            alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
          }
        } else {
          console.log("üóëÔ∏è User cancelled deletion");
        }
      };

      // H√†m x·ª≠ l√Ω xem s√°ch
      window.handleViewBooksClick = async function (id, name) {
        console.log("üìö handleViewBooksClick - ID:", id, "Name:", name);

        const labelEl = document.getElementById("booksModalLabel");
        if (labelEl) {
          labelEl.textContent = "";
          const icon = document.createElement("i");
          icon.className = "bi bi-book me-2";
          labelEl.appendChild(icon);
          labelEl.appendChild(
            document.createTextNode("Qu·∫£n l√Ω s√°ch - " + (name || ""))
          );
        }

        const booksModalEl = document.getElementById("booksModal");
        if (!booksModalEl) {
          console.error("‚ùå Kh√¥ng t√¨m th·∫•y booksModal element");
          alert("‚ùå Kh√¥ng t√¨m th·∫•y modal s√°ch. Vui l√≤ng t·∫£i l·∫°i trang.");
          return;
        }

        const booksModal = new bootstrap.Modal(booksModalEl);

        // ƒê·ª£i modal hi·ªÉn th·ªã ho√†n to√†n tr∆∞·ªõc khi load d·ªØ li·ªáu
        booksModalEl.addEventListener(
          "shown.bs.modal",
          async function onModalShown() {
            booksModalEl.removeEventListener("shown.bs.modal", onModalShown);

            console.log("‚úÖ Modal ƒë√£ hi·ªÉn th·ªã, b·∫Øt ƒë·∫ßu load s√°ch...");

            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c script ƒë√£ ƒë∆∞·ª£c load
            await new Promise((resolve) => setTimeout(resolve, 50));

            // Ki·ªÉm tra v√† ƒë·ª£i h√†m loadLibraryBooks ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë·∫ßy ƒë·ªß (t·ªëi ƒëa 1 gi√¢y)
            let attempts = 0;
            const maxAttempts = 20; // 20 l·∫ßn * 50ms = 1 gi√¢y
            while (typeof window.loadLibraryBooks !== "function") {
              if (attempts >= maxAttempts) {
                console.error(
                  "‚ùå loadLibraryBooks ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a sau khi ƒë·ª£i"
                );
                const content = document.getElementById("booksContent");
                if (content) {
                  content.innerHTML = `
                    <div class="alert alert-danger">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>L·ªói:</strong> H√†m loadLibraryBooks ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a. Vui l√≤ng t·∫£i l·∫°i trang.
                    </div>
                  `;
                }
                return;
              }
              await new Promise((resolve) => setTimeout(resolve, 50));
              attempts++;
            }

            // Ki·ªÉm tra xem h√†m ƒë√£ ƒë∆∞·ª£c override (kh√¥ng c√≤n l√† stub)
            attempts = 0;
            let fnStr = window.loadLibraryBooks.toString();
            while (
              fnStr.includes("stub") &&
              !fnStr.includes("booksContent") &&
              attempts < maxAttempts
            ) {
              console.log(
                "‚è≥ H√†m loadLibraryBooks v·∫´n l√† stub, ƒëang ƒë·ª£i h√†m ƒë·∫ßy ƒë·ªß..."
              );
              await new Promise((resolve) => setTimeout(resolve, 50));
              attempts++;
              fnStr = window.loadLibraryBooks.toString();
            }

            if (fnStr.includes("stub") && !fnStr.includes("booksContent")) {
              console.error("‚ùå loadLibraryBooks v·∫´n l√† stub sau khi ƒë·ª£i");
              const content = document.getElementById("booksContent");
              if (content) {
                content.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>L·ªói:</strong> H√†m loadLibraryBooks ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë·∫ßy ƒë·ªß. Vui l√≤ng t·∫£i l·∫°i trang.
                  </div>
                `;
              }
              return;
            }

            console.log(
              "‚úÖ H√†m loadLibraryBooks ƒë√£ s·∫µn s√†ng, b·∫Øt ƒë·∫ßu load d·ªØ li·ªáu..."
            );

            try {
              await window.loadLibraryBooks(id);
            } catch (error) {
              console.error("‚ùå L·ªói khi load s√°ch:", error);
              const content = document.getElementById("booksContent");
              if (content) {
                content.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>L·ªói:</strong> ${error.message}
                  </div>
                `;
              }
            }
          },
          { once: true }
        );

        booksModal.show();
      };

      // H√†m load s√°ch th∆∞ vi·ªán - Stub function ƒë·ªÉ tr√°nh l·ªói khi onclick ƒë∆∞·ª£c parse
      // H√†m ƒë·∫ßy ƒë·ªß s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag sau modal
      window.loadLibraryBooks = async function (libraryId) {
        console.log(
          "üìö loadLibraryBooks stub ƒë∆∞·ª£c g·ªçi - ƒëang ƒë·ª£i h√†m ƒë·∫ßy ƒë·ªß..."
        );
        const content = document.getElementById("booksContent");
        if (content) {
          content.innerHTML = `
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
              </div>
              <p class="mt-3 text-muted">ƒêang t·∫£i s√°ch th∆∞ vi·ªán...</p>
            </div>
          `;
        }
        // H√†m ƒë·∫ßy ƒë·ªß s·∫Ω override h√†m n√†y trong script tag sau modal
      };

      // H√†m m·ªü modal s·ª≠a th∆∞ vi·ªán
      window.openEditLibraryModal = async function (libraryId) {
        console.log("üìù openEditLibraryModal - ID:", libraryId);
        // H√†m n√†y s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë·∫ßy ƒë·ªß trong script tag sau
        // T·∫°m th·ªùi redirect ƒë·∫øn trang update
        window.location.href = `/admin/thu_vien/update/${libraryId}`;
      };

      // H√†m th√™m s√°ch v√†o th∆∞ vi·ªán s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ƒë·∫ßy ƒë·ªß trong script tag sau modal
      // Stub function ƒë∆°n gi·∫£n ƒë·ªÉ tr√°nh l·ªói khi onclick ƒë∆∞·ª£c parse
      window.addBookToLibrary = async function () {
        console.log(
          "üìö addBookToLibrary stub ƒë∆∞·ª£c g·ªçi - h√†m ƒë·∫ßy ƒë·ªß s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a sau"
        );
        // H√†m ƒë·∫ßy ƒë·ªß s·∫Ω override h√†m n√†y trong script tag sau modal
      };

      // H√†m ch·ªçn ·∫£nh - Stub function ƒë·ªÉ tr√°nh l·ªói khi onclick ƒë∆∞·ª£c parse
      window.selectImage = function () {
        // Ki·ªÉm tra xem h√†m ƒë·∫ßy ƒë·ªß ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ch∆∞a
        const fullFn = window.selectImage;
        const fnStr = fullFn.toString();
        // N·∫øu h√†m ƒë√£ ƒë∆∞·ª£c override (c√≥ "getElementById" v√† kh√¥ng c√≥ "stub")
        if (fnStr.includes("getElementById") && !fnStr.includes("stub")) {
          // G·ªçi h√†m ƒë·∫ßy ƒë·ªß
          return fullFn();
        }
        // N·∫øu ch∆∞a c√≥ h√†m ƒë·∫ßy ƒë·ªß, ƒë·ª£i m·ªôt ch√∫t v√† th·ª≠ l·∫°i
        setTimeout(() => {
          const checkFn = window.selectImage;
          const checkStr = checkFn.toString();
          if (
            checkStr.includes("getElementById") &&
            !checkStr.includes("stub")
          ) {
            checkFn();
          } else {
            console.error(
              "‚ùå H√†m selectImage ch∆∞a ƒë∆∞·ª£c load. Vui l√≤ng refresh trang."
            );
          }
        }, 100);
      };

      // H√†m ch·ªçn ·∫£nh cho form s·ª≠a - Stub function
      window.selectEditImage = function () {
        // Ki·ªÉm tra xem h√†m ƒë·∫ßy ƒë·ªß ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ch∆∞a
        const fullFn = window.selectEditImage;
        const fnStr = fullFn.toString();
        // N·∫øu h√†m ƒë√£ ƒë∆∞·ª£c override (c√≥ "getElementById" v√† kh√¥ng c√≥ "stub")
        if (fnStr.includes("getElementById") && !fnStr.includes("stub")) {
          // G·ªçi h√†m ƒë·∫ßy ƒë·ªß
          return fullFn();
        }
        // N·∫øu ch∆∞a c√≥ h√†m ƒë·∫ßy ƒë·ªß, ƒë·ª£i m·ªôt ch√∫t v√† th·ª≠ l·∫°i
        setTimeout(() => {
          const checkFn = window.selectEditImage;
          const checkStr = checkFn.toString();
          if (
            checkStr.includes("getElementById") &&
            !checkStr.includes("stub")
          ) {
            checkFn();
          } else {
            console.error(
              "‚ùå H√†m selectEditImage ch∆∞a ƒë∆∞·ª£c load. Vui l√≤ng refresh trang."
            );
          }
        }, 100);
      };

      // H√†m x·ª≠ l√Ω ch·ªçn ·∫£nh - Stub function ƒë·ªÉ tr√°nh l·ªói khi onchange ƒë∆∞·ª£c parse
      window.handleImageSelection = function (input) {
        // Ki·ªÉm tra xem h√†m ƒë·∫ßy ƒë·ªß ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ch∆∞a
        const fullFn = window.handleImageSelection;
        const fnStr = fullFn.toString();
        // N·∫øu h√†m ƒë√£ ƒë∆∞·ª£c override (c√≥ "getElementById" v√† kh√¥ng c√≥ "stub")
        if (fnStr.includes("getElementById") && !fnStr.includes("stub")) {
          // G·ªçi h√†m ƒë·∫ßy ƒë·ªß
          return fullFn(input);
        }
        // N·∫øu ch∆∞a c√≥ h√†m ƒë·∫ßy ƒë·ªß, ƒë·ª£i m·ªôt ch√∫t v√† th·ª≠ l·∫°i
        setTimeout(() => {
          const checkFn = window.handleImageSelection;
          const checkStr = checkFn.toString();
          if (
            checkStr.includes("getElementById") &&
            !checkStr.includes("stub")
          ) {
            checkFn(input);
          } else {
            console.error(
              "‚ùå H√†m handleImageSelection ch∆∞a ƒë∆∞·ª£c load. Vui l√≤ng refresh trang."
            );
          }
        }, 100);
      };

      // H√†m x·ª≠ l√Ω ch·ªçn ·∫£nh cho form s·ª≠a - Stub function
      window.handleEditImageSelection = function (input) {
        // Ki·ªÉm tra xem h√†m ƒë·∫ßy ƒë·ªß ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ch∆∞a
        const fullFn = window.handleEditImageSelection;
        const fnStr = fullFn.toString();
        // N·∫øu h√†m ƒë√£ ƒë∆∞·ª£c override (c√≥ "getElementById" v√† kh√¥ng c√≥ "stub")
        if (fnStr.includes("getElementById") && !fnStr.includes("stub")) {
          // G·ªçi h√†m ƒë·∫ßy ƒë·ªß
          return fullFn(input);
        }
        // N·∫øu ch∆∞a c√≥ h√†m ƒë·∫ßy ƒë·ªß, ƒë·ª£i m·ªôt ch√∫t v√† th·ª≠ l·∫°i
        setTimeout(() => {
          const checkFn = window.handleEditImageSelection;
          const checkStr = checkFn.toString();
          if (
            checkStr.includes("getElementById") &&
            !checkStr.includes("stub")
          ) {
            checkFn(input);
          } else {
            console.error(
              "‚ùå H√†m handleEditImageSelection ch∆∞a ƒë∆∞·ª£c load. Vui l√≤ng refresh trang."
            );
          }
        }, 100);
      };

      console.log("‚úÖ C√°c h√†m global ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong head");
      console.log(
        "‚úÖ handleDeleteLibraryClick:",
        typeof window.handleDeleteLibraryClick
      );
      console.log(
        "‚úÖ handleViewBooksClick:",
        typeof window.handleViewBooksClick
      );
      console.log(
        "‚úÖ openEditLibraryModal:",
        typeof window.openEditLibraryModal
      );
    </script>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
          <a class="navbar-brand" href="/admin">
            <i class="bi bi-building me-2"></i>Qu·∫£n l√Ω Th∆∞ Vi·ªán
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navMain"
            aria-controls="navMain"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/admin">
                  <i class="bi bi-house-door me-1"></i>Trang ch·ªß
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/admin/thu_vien">
                  <i class="bi bi-building me-1"></i>Th∆∞ vi·ªán
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/the_loai">
                  <i class="bi bi-tags me-1"></i>Th·ªÉ lo·∫°i
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/sach">
                  <i class="bi bi-book me-1"></i>S√°ch
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/muon_sach">
                  <i class="bi bi-journal-text me-1"></i>M∆∞·ª£n s√°ch
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/don_hang">
                  <i class="bi bi-cart-check me-1"></i>ƒê∆°n h√†ng
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/shop">
                  <i class="bi bi-shop me-1"></i>C·ª≠a h√†ng
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/">
                  <i class="bi bi-geo-alt-fill me-1"></i>Xem b·∫£n ƒë·ªì
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-building"></i> Qu·∫£n l√Ω Th∆∞ vi·ªán</h2>
        <div>
          <button
            class="btn btn-success me-2"
            data-bs-toggle="modal"
            data-bs-target="#addBookToLibraryModal"
          >
            <i class="bi bi-book-plus"></i> Th√™m s√°ch v√†o th∆∞ vi·ªán
          </button>
          <a class="btn btn-primary" href="#addLibraryForm">
            <i class="bi bi-plus-circle"></i> Th√™m th∆∞ vi·ªán
          </a>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">Th√™m Th∆∞ vi·ªán</h5>
        </div>
        <div class="card-body">
          <form
            id="addLibraryForm"
            method="POST"
            action="/admin/thu_vien/add"
            enctype="multipart/form-data"
          >
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">ID Th∆∞ vi·ªán</label>
                <input
                  type="text"
                  name="ID_thuvien"
                  class="form-control"
                  placeholder="ID Th∆∞ vi·ªán"
                  required
                />
              </div>
              <div class="col-md-8">
                <label class="form-label">T√™n th∆∞ vi·ªán</label>
                <input
                  type="text"
                  name="Ten_thuvien"
                  class="form-control"
                  placeholder="T√™n th∆∞ vi·ªán"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                <input
                  type="text"
                  name="Dia_chi"
                  class="form-control"
                  placeholder="ƒê·ªãa ch·ªâ"
                />
              </div>
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Wifi"
                        id="wifi"
                      />
                      <label class="form-check-label" for="wifi">Wifi</label>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Phongdoc"
                        id="phongdoc"
                      />
                      <label class="form-check-label" for="phongdoc"
                        >Ph√≤ng ƒë·ªçc</label
                      >
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Canteen"
                        id="canteen"
                      />
                      <label class="form-check-label" for="canteen"
                        >Canteen</label
                      >
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="Dieuhoa"
                        id="dieuhoa"
                      />
                      <label class="form-check-label" for="dieuhoa"
                        >ƒêi·ªÅu h√≤a</label
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Latitude</label>
                <input
                  type="number"
                  name="Latitude"
                  placeholder="Latitude"
                  step="any"
                  class="form-control"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Longitude</label>
                <input
                  type="number"
                  name="Longitude"
                  placeholder="Longitude"
                  step="any"
                  class="form-control"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Lo·∫°i th∆∞ vi·ªán</label>
                <select name="phanloai" class="form-select" required>
                  <option value="" disabled selected>Ch·ªçn lo·∫°i th∆∞ vi·ªán</option>
                  <option value="Th∆∞ vi·ªán c√¥ng c·ªông">Th∆∞ vi·ªán c√¥ng c·ªông</option>
                  <option value="Th∆∞ vi·ªán t∆∞ nh√¢n">Th∆∞ vi·ªán t∆∞ nh√¢n</option>
                  <option value="Th∆∞ vi·ªán tr∆∞·ªùng h·ªçc">
                    Th∆∞ vi·ªán tr∆∞·ªùng h·ªçc
                  </option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">·∫¢nh 360</label>
                <div class="input-group">
                  <input
                    type="text"
                    name="Anh360Path"
                    id="Anh360Path"
                    class="form-control"
                    placeholder="ƒê∆∞·ªùng d·∫´n ·∫£nh ho·∫∑c ch·ªçn file"
                    readonly
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    onclick="selectImage()"
                  >
                    <i class="bi bi-folder-open"></i> Ch·ªçn
                  </button>
                </div>
                <input
                  type="file"
                  name="Anh360"
                  id="Anh360"
                  accept="image/*"
                  class="form-control mt-2"
                  onchange="handleImageSelection(this)"
                  style="display: none"
                />
                <small class="form-text text-muted">
                  <i class="bi bi-info-circle"></i> Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh ƒë·ªÉ
                  upload tr·ª±c ti·∫øp. ·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông v√†o h·ªá th·ªëng.
                </small>
                <div id="imagePreview" class="mt-2" style="display: none">
                  <img
                    id="previewImg"
                    class="img-thumbnail"
                    style="max-width: 200px; max-height: 200px"
                  />
                </div>
              </div>
              <div class="col-12">
                <button
                  type="submit"
                  class="btn btn-primary"
                  id="submitLibraryBtn"
                  style="
                    position: relative;
                    z-index: 1000;
                    pointer-events: auto;
                  "
                >
                  <i class="bi bi-plus-circle me-2"></i>Th√™m Th∆∞ vi·ªán
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div
        id="errorMessage"
        class="alert alert-danger"
        style="display: none"
      ></div>

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">Danh s√°ch c√°c Th∆∞ vi·ªán</h5>
        </div>
        <div class="card-body">
          <% if (!thuVien || thuVien.length === 0) { %>
          <div class="alert alert-info text-center">
            <h6 class="mb-2">Kh√¥ng c√≥ th∆∞ vi·ªán n√†o trong danh s√°ch</h6>
            <p class="mb-3">B·∫£ng c√≥ th·ªÉ tr·ªëng ho·∫∑c c√≥ l·ªói k·∫øt n·ªëi database</p>
            <button onclick="testDatabase()" class="btn btn-outline-primary">
              Ki·ªÉm tra Database
            </button>
          </div>
          <% } else { %>
          <div class="table-responsive">
            <table
              id="libraryTable"
              class="table table-hover table-striped align-middle mb-0"
            >
              <thead class="table-light">
                <tr>
                  <th>ID Th∆∞ vi·ªán</th>
                  <th>T√™n Th∆∞ vi·ªán</th>
                  <th>ƒê·ªãa ch·ªâ</th>
                  <th>Wifi</th>
                  <th>Ph√≤ng ƒë·ªçc</th>
                  <th>Canteen</th>
                  <th>ƒêi·ªÅu h√≤a</th>
                  <th>Latitude</th>
                  <th>Longitude</th>
                  <th>Lo·∫°i th∆∞ vi·ªán</th>
                  <th>·∫¢nh 360</th>
                  <th>S√°ch</th>
                  <th class="text-end">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                <% thuVien.forEach(function(tv) { %>
                <tr data-id="<%= tv.id_thuvien %>">
                  <td><%= tv.id_thuvien %></td>
                  <td><%= tv.ten_thuvien %></td>
                  <td><%= tv.dia_chi %></td>
                  <td><%= tv.wifi ? 'C√≥' : 'Kh√¥ng' %></td>
                  <td><%= tv.phongdoc ? 'C√≥' : 'Kh√¥ng' %></td>
                  <td><%= tv.canteen ? 'C√≥' : 'Kh√¥ng' %></td>
                  <td><%= tv.dieuhoa ? 'C√≥' : 'Kh√¥ng' %></td>
                  <td><%= tv.latitude %></td>
                  <td><%= tv.longitude %></td>
                  <td><%= tv.phanloai || 'Kh√¥ng x√°c ƒë·ªãnh' %></td>
                  <td>
                    <% if (tv.anh_360) { %>
                    <a
                      href="<%= tv.anh_360 %>"
                      target="_blank"
                      class="btn btn-sm btn-outline-secondary"
                      >Xem ·∫£nh</a
                    >
                    <% } else { %> Kh√¥ng c√≥ <% } %>
                  </td>
                  <td>
                    <button
                      type="button"
                      class="btn-action btn-view"
                      data-id="<%= tv.id_thuvien %>"
                      data-name="<%= tv.ten_thuvien %>"
                      onclick="event.stopPropagation(); handleViewBooksClick('<%= tv.id_thuvien %>', '<%= tv.ten_thuvien %>');"
                      title="Xem s√°ch trong th∆∞ vi·ªán"
                      style="
                        position: relative;
                        z-index: 100;
                        pointer-events: auto;
                        cursor: pointer;
                      "
                    >
                      <i class="bi bi-book"></i>
                      <span>Xem s√°ch</span>
                    </button>
                  </td>
                  <td class="text-end">
                    <div class="action-buttons">
                      <button
                        type="button"
                        class="btn-action btn-edit"
                        data-id="<%= tv.id_thuvien %>"
                        title="S·ª≠a th∆∞ vi·ªán"
                        onclick="event.stopPropagation(); if(typeof openEditLibraryModal === 'function') { openEditLibraryModal('<%= tv.id_thuvien %>'); } else { window.location.href='/admin/thu_vien/update/<%= tv.id_thuvien %>'; }"
                        style="
                          position: relative;
                          z-index: 100;
                          pointer-events: auto;
                          cursor: pointer;
                        "
                      >
                        <i class="bi bi-pencil-square"></i>
                        <span>S·ª≠a</span>
                      </button>
                      <button
                        type="button"
                        class="btn-action btn-delete"
                        data-id="<%= tv.id_thuvien %>"
                        data-name="<%= tv.ten_thuvien %>"
                        title="X√≥a th∆∞ vi·ªán"
                        onclick="console.log('üñ±Ô∏è Delete button clicked!'); event.preventDefault(); event.stopPropagation(); if(typeof window.handleDeleteLibraryClick === 'function') { window.handleDeleteLibraryClick('<%= tv.id_thuvien %>', '<%= tv.ten_thuvien %>'); } else { console.error('‚ùå handleDeleteLibraryClick not found!'); alert('L·ªói: H√†m x√≥a ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a. Vui l√≤ng refresh trang.'); }"
                        style="
                          position: relative;
                          z-index: 100;
                          pointer-events: auto !important;
                          cursor: pointer !important;
                        "
                      >
                        <i class="bi bi-trash"></i>
                        <span>X√≥a</span>
                      </button>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <% } %>
        </div>
      </div>
    </main>

    <div
      class="modal fade"
      id="booksModal"
      tabindex="-1"
      aria-labelledby="booksModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="booksModalLabel">
              <i class="bi bi-book me-2"></i>Qu·∫£n l√Ω s√°ch th∆∞ vi·ªán
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="booksContent">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addBookToLibraryModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Th√™m s√°ch v√†o th∆∞ vi·ªán</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addBookToLibraryForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="selectLibrary" class="form-label"
                      >Ch·ªçn th∆∞ vi·ªán *</label
                    >
                    <select
                      class="form-select"
                      id="selectLibrary"
                      name="library_id"
                      required
                    >
                      <option value="">-- Ch·ªçn th∆∞ vi·ªán --</option>
                      <% thuVien.forEach(function(tv) { %>
                      <option value="<%= tv.id_thuvien %>">
                        <%= tv.ten_thuvien %>
                      </option>
                      <% }); %>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="selectBook" class="form-label"
                      >Ch·ªçn s√°ch *</label
                    >
                    <select
                      class="form-select"
                      id="selectBook"
                      name="book_id"
                      required
                    >
                      <option value="">-- Ch·ªçn s√°ch --</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="bookQuantity" class="form-label"
                      >S·ªë l∆∞·ª£ng *</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="bookQuantity"
                      name="quantity"
                      min="1"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="bookReason" class="form-label"
                      >L√Ω do th√™m</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="bookReason"
                      name="reason"
                      placeholder="V√≠ d·ª•: Mua m·ªõi, t·∫∑ng, chuy·ªÉn t·ª´ th∆∞ vi·ªán kh√°c..."
                    />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="bookNote" class="form-label">Ghi ch√∫</label>
                <textarea
                  class="form-control"
                  id="bookNote"
                  name="note"
                  rows="3"
                  placeholder="Ghi ch√∫ th√™m v·ªÅ s√°ch..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              H·ªßy
            </button>
            <button
              type="button"
              class="btn btn-success"
              onclick="addBookToLibrary()"
            >
              <i class="bi bi-plus-circle"></i> Th√™m s√°ch
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Script ƒë·ªãnh nghƒ©a h√†m loadAllBooks NGAY SAU MODAL - ƒê·∫£m b·∫£o ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a s·ªõm -->
    <script>
      // H√†m test API (c√≥ th·ªÉ g·ªçi t·ª´ console)
      window.testLoadBooksAPI = async function () {
        try {
          console.log("üß™ Test API: /admin/thu_vien/all-books");
          const response = await fetch("/admin/thu_vien/all-books");
          const data = await response.json();
          console.log("‚úÖ Test th√†nh c√¥ng:", data);
          return data;
        } catch (error) {
          console.error("‚ùå Test th·∫•t b·∫°i:", error);
          return null;
        }
      };

      // H√†m load T·∫§T C·∫¢ s√°ch t·ª´ b·∫£ng sach - ƒê·ªãnh nghƒ©a S·ªöM ƒë·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng ngay
      window.loadAllBooks = async function () {
        try {
          console.log("üìö ===== B·∫ÆT ƒê·∫¶U LOAD T·∫§T C·∫¢ S√ÅCH =====");

          const bookSelect = document.getElementById("selectBook");
          if (!bookSelect) {
            console.error("‚ùå Kh√¥ng t√¨m th·∫•y selectBook element");
            console.error("‚ùå ƒêang t√¨m l·∫°i sau 200ms...");
            setTimeout(() => {
              const retrySelect = document.getElementById("selectBook");
              if (retrySelect) {
                console.log("‚úÖ T√¨m th·∫•y selectBook sau retry");
                window.loadAllBooks();
              } else {
                console.error("‚ùå V·∫´n kh√¥ng t√¨m th·∫•y selectBook");
              }
            }, 200);
            return;
          }

          console.log("‚úÖ T√¨m th·∫•y selectBook element");

          bookSelect.innerHTML =
            '<option value="">-- ƒêang t·∫£i s√°ch... --</option>';
          bookSelect.disabled = true;

          const apiUrl = "/admin/thu_vien/all-books";
          console.log("üì° G·ªçi API:", apiUrl);

          const response = await fetch(apiUrl);
          console.log("üì• Response status:", response.status);
          console.log("üì• Response ok:", response.ok);

          // ƒê·ªçc response body m·ªôt l·∫ßn duy nh·∫•t
          let responseData;
          const contentType = response.headers.get("content-type") || "";

          if (contentType.includes("application/json")) {
            responseData = await response.json();
          } else {
            const textData = await response.text();
            try {
              responseData = JSON.parse(textData);
            } catch (e) {
              responseData = { error: textData };
            }
          }

          // Ki·ªÉm tra response sau khi ƒë√£ ƒë·ªçc
          if (!response.ok) {
            const errorText =
              responseData.error ||
              responseData.message ||
              `HTTP ${response.status}`;
            console.error("‚ùå Response error:", errorText);
            throw new Error(
              `HTTP error! status: ${response.status}, message: ${errorText}`
            );
          }

          const data = responseData;
          console.log("üì• D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);
          console.log("üì• Success:", data.success);
          console.log("üì• S·ªë s√°ch:", data.books ? data.books.length : 0);

          bookSelect.innerHTML = '<option value="">-- Ch·ªçn s√°ch --</option>';
          bookSelect.disabled = false;

          if (data.success && data.books && data.books.length > 0) {
            console.log(
              `‚úÖ T√¨m th·∫•y ${data.books.length} s√°ch, ƒëang th√™m v√†o dropdown...`
            );

            let addedCount = 0;
            data.books.forEach((book) => {
              const option = document.createElement("option");
              option.value = book.id_sach;

              // Hi·ªÉn th·ªã th√¥ng tin s√°ch: T√™n - T√°c gi·∫£ (Th·ªÉ lo·∫°i) - S·ªë l∆∞·ª£ng t·ªìn
              const tacGia = book.tac_gia || "Kh√¥ng c√≥";
              const theLoai = book.ten_theloai || "Kh√¥ng c√≥";
              const slTon = book.slton || 0;

              option.textContent = `${book.ten_sach} - ${tacGia} (${theLoai}) - T·ªìn: ${slTon}`;
              option.dataset.available = slTon;
              option.dataset.tongsl = book.tongsl || 0;

              bookSelect.appendChild(option);
              addedCount++;
            });

            console.log(`‚úÖ ƒê√£ th√™m ${addedCount} s√°ch v√†o dropdown`);
            console.log(
              "‚úÖ Dropdown hi·ªán c√≥",
              bookSelect.options.length,
              "options"
            );
          } else {
            console.warn("‚ö†Ô∏è Kh√¥ng c√≥ s√°ch n√†o trong response");
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "-- Kh√¥ng c√≥ s√°ch n√†o trong h·ªá th·ªëng --";
            option.disabled = true;
            bookSelect.appendChild(option);
          }

          console.log("üìö ===== HO√ÄN TH√ÄNH LOAD S√ÅCH =====");
        } catch (error) {
          console.error("‚ùå L·ªói khi load s√°ch:", error);
          console.error("‚ùå Error stack:", error.stack);
          const bookSelect = document.getElementById("selectBook");
          if (bookSelect) {
            bookSelect.innerHTML = `<option value="">-- L·ªói: ${error.message} --</option>`;
            bookSelect.disabled = false;
          }
          alert("C√≥ l·ªói x·∫£y ra khi load danh s√°ch s√°ch: " + error.message);
        }
      };

      console.log(
        "‚úÖ H√†m loadAllBooks ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a:",
        typeof window.loadAllBooks
      );

      // G·∫Øn event listener ngay khi h√†m ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
      (function () {
        function setupModalListener() {
          const modal = document.getElementById("addBookToLibraryModal");
          if (!modal) {
            console.warn("‚ö†Ô∏è Modal ch∆∞a t·ªìn t·∫°i, s·∫Ω th·ª≠ l·∫°i sau 200ms");
            setTimeout(setupModalListener, 200);
            return;
          }

          // Ki·ªÉm tra xem ƒë√£ c√≥ listener ch∆∞a ƒë·ªÉ tr√°nh duplicate
          if (modal.hasAttribute("data-modal-listener-attached")) {
            console.log("‚úÖ Event listener ƒë√£ ƒë∆∞·ª£c g·∫Øn r·ªìi");
            return;
          }

          modal.setAttribute("data-modal-listener-attached", "true");

          modal.addEventListener("show.bs.modal", function () {
            console.log("üìö Modal event triggered - show.bs.modal");

            // Reset dropdown s√°ch v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
            const bookSelect = document.getElementById("selectBook");
            if (bookSelect) {
              bookSelect.innerHTML =
                '<option value="">-- Ch·ªçn s√°ch --</option>';
              bookSelect.disabled = false;
            }

            // Reset dropdown th∆∞ vi·ªán
            const librarySelect = document.getElementById("selectLibrary");
            if (librarySelect) {
              librarySelect.value = "";
            }

            // Load t·∫•t c·∫£ s√°ch khi modal m·ªü (sau khi modal ƒë√£ hi·ªÉn th·ªã)
            if (typeof window.loadAllBooks === "function") {
              console.log("‚úÖ G·ªçi window.loadAllBooks");
              setTimeout(() => {
                window.loadAllBooks();
              }, 200);
            } else {
              console.error("‚ùå window.loadAllBooks kh√¥ng t·ªìn t·∫°i!");
            }
          });

          console.log("‚úÖ ƒê√£ g·∫Øn event listener v√†o modal (inline script)");
        }

        // Ch·∫°y ngay n·∫øu DOM ƒë√£ s·∫µn s√†ng, n·∫øu kh√¥ng th√¨ ƒë·ª£i DOM ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setupModalListener);
        } else {
          setupModalListener();
        }
      })();

      // H√†m th√™m s√°ch v√†o th∆∞ vi·ªán - ƒê·ªãnh nghƒ©a S·ªöM ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ onclick
      window.addBookToLibrary = async function () {
        const form = document.getElementById("addBookToLibraryForm");
        if (!form) {
          alert("L·ªói: Kh√¥ng t√¨m th·∫•y form th√™m s√°ch");
          return;
        }

        const formData = new FormData(form);
        const library_id = formData.get("library_id")?.trim();
        const book_id = formData.get("book_id")?.trim();
        const quantity = parseInt(formData.get("quantity"));
        const reason = formData.get("reason")?.trim();
        const note = formData.get("note")?.trim();

        console.log("üìö Th√™m s√°ch v√†o th∆∞ vi·ªán:", {
          library_id,
          book_id,
          quantity,
          reason,
          note,
        });

        // Validation
        if (!library_id || !book_id || !quantity) {
          alert(
            "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc: Th∆∞ vi·ªán, S√°ch v√† S·ªë l∆∞·ª£ng"
          );
          return;
        }

        if (quantity <= 0) {
          alert("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0");
          return;
        }

        // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn t·ª´ option ƒë√£ ch·ªçn
        const selected =
          document.getElementById("selectBook").selectedOptions[0];
        const available = parseInt(selected?.dataset.available || "0");
        const tongsl = parseInt(selected?.dataset.tongsl || "0");

        console.log("üìä Th√¥ng tin s√°ch:", {
          available,
          tongsl,
          requested: quantity,
        });

        if (quantity > available) {
          alert(
            `S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${available} quy·ªÉn c√≤n l·∫°i trong kho`
          );
          return;
        }

        const data = {
          library_id,
          book_id,
          quantity,
          reason: reason || "",
          note: note || "",
        };

        try {
          const submitBtn = document.querySelector(
            "#addBookToLibraryModal .btn-success"
          );
          const originalText = submitBtn?.innerHTML;
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang th√™m...';
          }

          const response = await fetch("/admin/thu_vien/add-book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          // ƒê·ªçc response body m·ªôt l·∫ßn duy nh·∫•t
          let responseData;
          const contentType = response.headers.get("content-type") || "";

          if (contentType.includes("application/json")) {
            responseData = await response.json();
          } else {
            const textData = await response.text();
            try {
              responseData = JSON.parse(textData);
            } catch (e) {
              responseData = { error: textData };
            }
          }

          console.log("üì• K·∫øt qu·∫£:", responseData);

          if (response.ok && responseData.success) {
            alert("‚úÖ Th√™m s√°ch v√†o th∆∞ vi·ªán th√†nh c√¥ng!");
            form.reset();
            bootstrap.Modal.getInstance(
              document.getElementById("addBookToLibraryModal")
            )?.hide();
            location.reload();
          } else {
            alert(
              "‚ùå L·ªói: " +
                (responseData.message || responseData.error || "Kh√¥ng x√°c ƒë·ªãnh")
            );
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
            }
          }
        } catch (error) {
          console.error("‚ùå L·ªói khi th√™m s√°ch:", error);
          alert("‚ùå C√≥ l·ªói x·∫£y ra khi th√™m s√°ch: " + error.message);
          const submitBtn = document.querySelector(
            "#addBookToLibraryModal .btn-success"
          );
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Th√™m s√°ch';
          }
        }
      };

      console.log(
        "‚úÖ H√†m addBookToLibrary ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a:",
        typeof window.addBookToLibrary
      );

      // H√†m ch·ªçn ·∫£nh - ƒê·ªãnh nghƒ©a S·ªöM ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ onclick
      window.selectImage = function () {
        const fileInput = document.getElementById("Anh360");
        if (fileInput) {
          fileInput.click();
        } else {
          console.error("‚ùå Kh√¥ng t√¨m th·∫•y input file Anh360");
        }
      };

      // H√†m ch·ªçn ·∫£nh cho form s·ª≠a - ƒê·ªãnh nghƒ©a S·ªöM
      window.selectEditImage = function () {
        const fileInput = document.getElementById("editAnh360");
        if (fileInput) {
          fileInput.click();
        } else {
          console.error("‚ùå Kh√¥ng t√¨m th·∫•y input file editAnh360");
        }
      };

      console.log(
        "‚úÖ H√†m selectImage ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a:",
        typeof window.selectImage
      );
      console.log(
        "‚úÖ H√†m selectEditImage ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a:",
        typeof window.selectEditImage
      );

      // H√†m x·ª≠ l√Ω ch·ªçn ·∫£nh - ƒê·ªãnh nghƒ©a S·ªöM ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ onchange
      window.handleImageSelection = function (input) {
        if (input && input.files && input.files[0]) {
          const file = input.files[0];
          const pathInput = document.getElementById("Anh360Path");
          if (pathInput) {
            pathInput.value = file.name;
          }
          previewImage(input);
        }
      };

      // H√†m x·ª≠ l√Ω ch·ªçn ·∫£nh cho form s·ª≠a - ƒê·ªãnh nghƒ©a S·ªöM
      window.handleEditImageSelection = function (input) {
        if (input && input.files && input.files[0]) {
          const file = input.files[0];
          const pathInput = document.getElementById("editAnh360Path");
          if (pathInput) {
            pathInput.value = file.name;
          }
          previewEditImage(input);
        }
      };

      // H√†m preview ·∫£nh - ƒê·ªãnh nghƒ©a S·ªöM
      function previewImage(input) {
        const preview = document.getElementById("imagePreview");
        const previewImg = document.getElementById("previewImg");

        if (input && input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            if (previewImg) {
              previewImg.src = e.target.result;
            }
            if (preview) {
              preview.style.display = "block";
            }
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          if (preview) {
            preview.style.display = "none";
          }
        }
      }

      // H√†m preview ·∫£nh cho form s·ª≠a - ƒê·ªãnh nghƒ©a S·ªöM
      function previewEditImage(input) {
        const preview = document.getElementById("editImagePreview");
        const previewImg = document.getElementById("editPreviewImg");

        if (input && input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            if (previewImg) {
              previewImg.src = e.target.result;
            }
            if (preview) {
              preview.style.display = "block";
            }
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          if (preview) {
            preview.style.display = "none";
          }
        }
      }

      console.log(
        "‚úÖ H√†m handleImageSelection ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a:",
        typeof window.handleImageSelection
      );
      console.log(
        "‚úÖ H√†m handleEditImageSelection ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a:",
        typeof window.handleEditImageSelection
      );
    </script>

    <script>
          // C√°c h√†m global ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong <head>
          // Ki·ªÉm tra l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o ch√∫ng c√≥ s·∫µn
          console.log("üîç Ki·ªÉm tra c√°c h√†m global sau khi DOM ready:");
          console.log("  - handleDeleteLibraryClick:", typeof window.handleDeleteLibraryClick);
          console.log("  - handleViewBooksClick:", typeof window.handleViewBooksClick);
          console.log("  - openEditLibraryModal:", typeof window.openEditLibraryModal);

          if (typeof window.handleDeleteLibraryClick !== 'function') {
            console.error("‚ùå handleDeleteLibraryClick ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a!");
          }

          async function testDatabase() {
            try {
              const response = await fetch("/admin/thu_vien/test-data");
              const data = await response.json();

              if (data.success) {
                alert(
                  `Database OK!\nB·∫£ng thu_vien: ${data.tableExists}\nT·ªïng b·∫£n ghi: ${data.totalRecords}\nC·∫•u tr√∫c: ${data.tableStructure.length} c·ªôt`
                );
                console.log("Database test result:", data);
              } else {
                alert(`Database Error: ${data.error}`);
                console.error("Database test failed:", data);
              }
            } catch (error) {
              alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
              console.error("Test failed:", error);
            }
          }

          // Th√™m th∆∞ vi·ªán m·ªõi
          function initFormSubmit() {
            console.log("üîß ƒêang setup form submit handler...");
            const addLibraryForm = document.getElementById("addLibraryForm");
            if (!addLibraryForm) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y form addLibraryForm");
              return false;
            }
            console.log("‚úÖ T√¨m th·∫•y form addLibraryForm");
            setupFormSubmit(addLibraryForm);
            return true;
          }

          // ƒê·∫£m b·∫£o ch·∫°y sau khi DOM ready
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", function() {
              if (!initFormSubmit()) {
                // Retry sau 500ms n·∫øu kh√¥ng t√¨m th·∫•y
                setTimeout(() => {
                  initFormSubmit();
                }, 500);
              }
            });
          } else {
            // DOM ƒë√£ s·∫µn s√†ng
            if (!initFormSubmit()) {
              setTimeout(() => {
                initFormSubmit();
              }, 500);
            }
          }

          function setupFormSubmit(form) {
            // Ki·ªÉm tra xem ƒë√£ c√≥ listener ch∆∞a
            if (form.hasAttribute("data-submit-handler-attached")) {
              console.log("‚ö†Ô∏è Form submit handler ƒë√£ ƒë∆∞·ª£c g·∫Øn r·ªìi");
              return;
            }

            form.setAttribute("data-submit-handler-attached", "true");

            form.addEventListener("submit", async function(event) {
              console.log("üìù Form submit event triggered!");
              // QUAN TR·ªåNG: preventDefault ph·∫£i ƒë∆∞·ª£c g·ªçi ƒë·∫ßu ti√™n
              event.preventDefault();
              event.stopPropagation();
              event.stopImmediatePropagation();

              const errorDiv = document.getElementById("errorMessage");
              const submitBtn = document.getElementById("submitLibraryBtn") || event.target.querySelector('button[type="submit"]');

              if (!errorDiv) {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y errorDiv");
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ hi·ªÉn th·ªã l·ªói");
                return;
              }

              if (!submitBtn) {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y submitBtn");
                errorDiv.className = "alert alert-danger";
                errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>L·ªói: Kh√¥ng t√¨m th·∫•y n√∫t submit';
                errorDiv.style.display = "block";
                return;
              }

              const originalBtnText = submitBtn.innerHTML;

              errorDiv.style.display = "none";
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang th√™m...';

              const formData = new FormData(event.target);

              // Validation ƒë·∫ßy ƒë·ªß
              const ID_thuvien = formData.get("ID_thuvien")?.trim();
              const Ten_thuvien = formData.get("Ten_thuvien")?.trim();
              const phanloai = formData.get("phanloai")?.trim();

              if (!ID_thuvien || !Ten_thuvien || !phanloai) {
                errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc: ID th∆∞ vi·ªán, T√™n th∆∞ vi·ªán v√† Lo·∫°i th∆∞ vi·ªán';
                errorDiv.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
              }

              console.log('üì§ G·ª≠i d·ªØ li·ªáu th∆∞ vi·ªán:', {
                ID_thuvien,
                Ten_thuvien,
                phanloai,
                Dia_chi: formData.get("Dia_chi"),
                Wifi: formData.get("Wifi"),
                Phongdoc: formData.get("Phongdoc"),
                Canteen: formData.get("Canteen"),
                Dieuhoa: formData.get("Dieuhoa"),
                Latitude: formData.get("Latitude"),
                Longitude: formData.get("Longitude"),
                hasFile: formData.get("Anh360") ? true : false
              });

              try {
                const response = await fetch("/admin/thu_vien/add", {
                  method: "POST",
                  headers: {
                    "X-Requested-With": "XMLHttpRequest"
                  },
                  body: formData,
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);
                console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));

                // Ki·ªÉm tra status code tr∆∞·ªõc
                if (!response.ok) {
                  let errorText = "";
                  try {
                    errorText = await response.text();
                  } catch (textError) {
                    errorText = `HTTP ${response.status}: ${response.statusText}`;
                  }
                  console.error("‚ùå Server error (status not ok):", errorText);
                  errorDiv.className = "alert alert-danger";
                  errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i><strong>L·ªói server (${response.status}):</strong> ${errorText.substring(0, 200)}`;
                  errorDiv.style.display = "block";
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalBtnText;
                  return;
                }

                // Th·ª≠ parse JSON - ch·ªâ parse m·ªôt l·∫ßn
                let result;
                const contentType = response.headers.get("content-type") || "";

                try {
                  // Lu√¥n th·ª≠ parse JSON tr∆∞·ªõc
                  const responseText = await response.text();
                  console.log("üì• Response text:", responseText.substring(0, 200));

                  try {
                    result = JSON.parse(responseText);
                    console.log('üì• Parsed JSON:', result);
                  } catch (parseError) {
                    // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, coi nh∆∞ l·ªói
                    console.error("‚ùå Kh√¥ng th·ªÉ parse JSON:", parseError);
                    errorDiv.className = "alert alert-danger";
                    errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i><strong>L·ªói:</strong> Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: ${responseText.substring(0, 100)}`;
                    errorDiv.style.display = "block";
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                  }
                } catch (readError) {
                  console.error("‚ùå L·ªói khi ƒë·ªçc response:", readError);
                  errorDiv.className = "alert alert-danger";
                  errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i><strong>L·ªói:</strong> Kh√¥ng th·ªÉ ƒë·ªçc response t·ª´ server`;
                  errorDiv.style.display = "block";
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalBtnText;
                  return;
                }

                // X·ª≠ l√Ω k·∫øt qu·∫£
                if (result && result.success) {
                  console.log("‚úÖ Th√™m th∆∞ vi·ªán th√†nh c√¥ng!");
                  errorDiv.className = "alert alert-success";
                  errorDiv.innerHTML = `<i class="bi bi-check-circle me-2"></i>Th√™m th∆∞ vi·ªán th√†nh c√¥ng! ƒêang t·∫£i l·∫°i trang...`;
                  errorDiv.style.display = "block";

                  // Reset form
                  event.target.reset();
                  const imagePreview = document.getElementById("imagePreview");
                  if (imagePreview) {
                    imagePreview.style.display = "none";
                  }

                  // Reload sau 1 gi√¢y
                  setTimeout(() => {
                    console.log("üîÑ Reloading page...");
                    window.location.reload();
                  }, 1000);
                } else {
                  console.error("‚ùå Th√™m th∆∞ vi·ªán th·∫•t b·∫°i:", result);
                  errorDiv.className = "alert alert-danger";
                  errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i><strong>L·ªói:</strong> ${result?.error || result?.message || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói'}`;
                  errorDiv.style.display = "block";
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalBtnText;
                }
              } catch (error) {
                console.error("‚ùå Network error:", error);
                console.error("‚ùå Error stack:", error.stack);
                errorDiv.className = "alert alert-danger";
                errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i><strong>L·ªói k·∫øt n·ªëi:</strong> ${error.message}`;
                errorDiv.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
              }
            });
            console.log("‚úÖ Form submit handler ƒë√£ ƒë∆∞·ª£c g·∫Øn th√†nh c√¥ng");
          }

          // H√†m x·ª≠ l√Ω s·ª≠a th∆∞ vi·ªán - ƒê·ªãnh nghƒ©a ·ªü global scope
          window.handleEditLibrary = async function(id) {
            console.log("‚úèÔ∏è S·ª≠a th∆∞ vi·ªán ID:", id);
            if (id) {
              window.location.href = `/admin/thu_vien/update/${id}`;
            } else {
              alert("‚ùå Kh√¥ng t√¨m th·∫•y ID th∆∞ vi·ªán");
            }
          };

          // H√†m x·ª≠ l√Ω x√≥a th∆∞ vi·ªán - ƒê·ªãnh nghƒ©a ·ªü global scope
          window.handleDeleteLibrary = async function(id) {
            console.log("üóëÔ∏è X√≥a th∆∞ vi·ªán ID:", id);

            if (!id) {
              alert("‚ùå Kh√¥ng t√¨m th·∫•y ID th∆∞ vi·ªán");
              return;
            }

            const row = document.querySelector(`[data-id="${id}"]`)?.closest("tr");
            const libraryName = row?.querySelector("td:nth-child(2)")?.textContent?.trim() || "th∆∞ vi·ªán n√†y";

            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th∆∞ vi·ªán "${libraryName}"?\n\nL∆∞u √Ω: T·∫•t c·∫£ s√°ch trong th∆∞ vi·ªán n√†y c≈©ng s·∫Ω b·ªã x√≥a kh·ªèi danh s√°ch.`)) {
              try {
                console.log("üóëÔ∏è ƒêang g·ª≠i y√™u c·∫ßu x√≥a th∆∞ vi·ªán ID:", id);
                const response = await fetch(`/admin/thu_vien/delete/${id}`, {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json"
                  }
                });

                console.log("üì• Response status:", response.status);

                let result;
                try {
                  result = await response.json();
                } catch (jsonError) {
                  const text = await response.text();
                  console.error("‚ùå Kh√¥ng parse ƒë∆∞·ª£c JSON:", text);
                  throw new Error(`Server tr·∫£ v·ªÅ l·ªói: ${text}`);
                }

                console.log("üì• Response data:", result);

                if (response.ok && result.success) {
                  alert("‚úÖ " + (result.message || "X√≥a th∆∞ vi·ªán th√†nh c√¥ng!"));
                  window.location.reload();
                } else {
                  alert("‚ùå L·ªói: " + (result.error || "Kh√¥ng th·ªÉ x√≥a th∆∞ vi·ªán"));
                  console.error("L·ªói x√≥a th∆∞ vi·ªán:", result);
                }
              } catch (error) {
                console.error("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a:", error);
                alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
              }
            }
          }

          // Event delegation ƒë∆°n gi·∫£n v√† tr·ª±c ti·∫øp cho table
          function setupTableEventDelegation() {
            const libraryTableEl = document.querySelector("#libraryTable");
            if (libraryTableEl) {
              // Ki·ªÉm tra xem ƒë√£ g·∫Øn listener ch∆∞a
              if (libraryTableEl.hasAttribute("data-events-attached")) {
                console.log("‚úÖ Event delegation ƒë√£ ƒë∆∞·ª£c g·∫Øn r·ªìi");
                return;
              }

              console.log("‚úÖ T√¨m th·∫•y #libraryTable, ƒëang g·∫Øn event delegation...");

              // Ki·ªÉm tra s·ªë l∆∞·ª£ng buttons
              const editButtons = libraryTableEl.querySelectorAll(".btn-edit");
              const deleteButtons = libraryTableEl.querySelectorAll(".btn-delete");
              const booksButtons = libraryTableEl.querySelectorAll(".btn-view");
              console.log(`üìä T√¨m th·∫•y ${editButtons.length} n√∫t S·ª≠a, ${deleteButtons.length} n√∫t X√≥a, ${booksButtons.length} n√∫t Xem s√°ch`);

              libraryTableEl.setAttribute("data-events-attached", "true");

              libraryTableEl.addEventListener("click", async function(event) {
              console.log("üñ±Ô∏è Click detected on table, target:", event.target);

              // T√¨m button ƒë∆∞·ª£c click
              const editBtn = event.target.closest(".btn-edit");
              const deleteBtn = event.target.closest(".btn-delete");
              const booksBtn = event.target.closest(".btn-view");

              console.log("üîç Button check:", { editBtn: !!editBtn, deleteBtn: !!deleteBtn, booksBtn: !!booksBtn });

              if (editBtn) {
                event.preventDefault();
                event.stopPropagation();
                const id = editBtn.dataset.id;
                console.log("‚úèÔ∏è Click S·ª≠a - ID:", id);
                if (id) {
                  // M·ªü modal v√† load d·ªØ li·ªáu
                  openEditLibraryModal(id);
                } else {
                  alert("‚ùå Kh√¥ng t√¨m th·∫•y ID th∆∞ vi·ªán");
                }
                return;
              }

              if (deleteBtn) {
                event.preventDefault();
                event.stopPropagation();
                const id = deleteBtn.dataset.id;
                console.log("üóëÔ∏è Click X√≥a - ID:", id);

                if (!id) {
                  alert("‚ùå Kh√¥ng t√¨m th·∫•y ID th∆∞ vi·ªán");
                  return;
                }

                const row = deleteBtn.closest("tr");
                const libraryName = row?.querySelector("td:nth-child(2)")?.textContent?.trim() || "th∆∞ vi·ªán n√†y";

                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th∆∞ vi·ªán "${libraryName}"?\n\nL∆∞u √Ω: T·∫•t c·∫£ s√°ch trong th∆∞ vi·ªán n√†y c≈©ng s·∫Ω b·ªã x√≥a kh·ªèi danh s√°ch.`)) {
                  try {
                    console.log("üóëÔ∏è ƒêang g·ª≠i y√™u c·∫ßu x√≥a th∆∞ vi·ªán ID:", id);
                    const response = await fetch(`/admin/thu_vien/delete/${id}`, {
                      method: "DELETE",
                      headers: {
                        "Content-Type": "application/json"
                      }
                    });

                    console.log("üì• Response status:", response.status);

                    let result;
                    try {
                      result = await response.json();
                    } catch (jsonError) {
                      const text = await response.text();
                      console.error("‚ùå Kh√¥ng parse ƒë∆∞·ª£c JSON:", text);
                      throw new Error(`Server tr·∫£ v·ªÅ l·ªói: ${text}`);
                    }

                    console.log("üì• Response data:", result);

                    if (response.ok && result.success) {
                      alert("‚úÖ " + (result.message || "X√≥a th∆∞ vi·ªán th√†nh c√¥ng!"));
                      window.location.reload();
                    } else {
                      alert("‚ùå L·ªói: " + (result.error || "Kh√¥ng th·ªÉ x√≥a th∆∞ vi·ªán"));
                      console.error("L·ªói x√≥a th∆∞ vi·ªán:", result);
                    }
                  } catch (error) {
                    console.error("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a:", error);
                    alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
                  }
                }
                return;
              }

              if (booksBtn) {
                event.preventDefault();
                event.stopPropagation();
                const id = booksBtn.dataset.id;
                const name = booksBtn.dataset.name || "";
                console.log("üìö Click Xem s√°ch - ID:", id, "Name:", name);

                const labelEl = document.getElementById("booksModalLabel");
                if (labelEl) {
                  labelEl.textContent = "";
                  const icon = document.createElement("i");
                  icon.className = "bi bi-book me-2";
                  labelEl.appendChild(icon);
                  labelEl.appendChild(document.createTextNode("Qu·∫£n l√Ω s√°ch - " + name));
                }

                const booksModal = new bootstrap.Modal(
                  document.getElementById("booksModal")
                );
                booksModal.show();

                await loadLibraryBooks(id);
                return;
              }
              });

              console.log("‚úÖ ƒê√£ g·∫Øn event delegation v√†o table th√†nh c√¥ng");
            } else {
              console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y #libraryTable, s·∫Ω th·ª≠ l·∫°i sau 200ms");
              setTimeout(setupTableEventDelegation, 200);
            }
          }

          // Ch·∫°y sau khi DOM ready
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", function() {
              console.log("üìÑ DOM Content Loaded - Setup table events");
              setTimeout(setupTableEventDelegation, 100);
            });
          } else {
            console.log("üìÑ DOM ƒë√£ s·∫µn s√†ng - Setup table events");
            setTimeout(setupTableEventDelegation, 100);
          }

          console.log("‚úÖ Page script loaded successfully");

          // C√°c h√†m handleDeleteLibraryClick, handleViewBooksClick, openEditLibraryModal
          // ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong <head> ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ s·∫µn khi onclick ƒë∆∞·ª£c parse
          // Kh√¥ng c·∫ßn ƒë·ªãnh nghƒ©a l·∫°i ·ªü ƒë√¢y

          // ===== C√ÅC H√ÄM X·ª¨ L√ù MODAL S·ª¨A TH∆Ø VI·ªÜN =====

          // H√†m m·ªü modal s·ª≠a v√† load d·ªØ li·ªáu - Override ƒë·ªãnh nghƒ©a stub trong head
          window.openEditLibraryModal = async function(libraryId) {
            try {
              console.log("üìù ƒêang load d·ªØ li·ªáu th∆∞ vi·ªán ID:", libraryId);

              // Hi·ªÉn th·ªã loading
              const modal = new bootstrap.Modal(document.getElementById("editLibraryModal"));
              modal.show();

              // Disable form trong khi load
              const form = document.getElementById("editLibraryFormModal");
              form.querySelectorAll("input, select, button").forEach(el => el.disabled = true);

              // Fetch d·ªØ li·ªáu th∆∞ vi·ªán t·ª´ API JSON thay v√¨ parse HTML
              const response = await fetch(`/admin/thu_vien/api/${libraryId}`);

              if (!response.ok) {
                // Fallback: fetch t·ª´ route update v√† parse HTML
                const htmlResponse = await fetch(`/admin/thu_vien/update/${libraryId}`);
                if (!htmlResponse.ok) {
                  throw new Error(`HTTP error! status: ${htmlResponse.status}`);
                }
                const html = await htmlResponse.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const formData = doc.querySelector("form");
                if (!formData) {
                  throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu th∆∞ vi·ªán");
                }

                // ƒêi·ªÅn d·ªØ li·ªáu t·ª´ HTML form
                document.getElementById("editLibraryId").value = libraryId;
                document.getElementById("editLibraryIdDisplay").value = libraryId;
                document.getElementById("editTenThuvien").value = formData.querySelector('input[name="Ten_thuvien"]')?.value || "";
                document.getElementById("editDiaChi").value = formData.querySelector('input[name="Dia_chi"]')?.value || "";
                document.getElementById("editLatitude").value = formData.querySelector('input[name="Latitude"]')?.value || "";
                document.getElementById("editLongitude").value = formData.querySelector('input[name="Longitude"]')?.value || "";

                document.getElementById("editWifi").checked = formData.querySelector('input[name="Wifi"]')?.checked || false;
                document.getElementById("editPhongdoc").checked = formData.querySelector('input[name="Phongdoc"]')?.checked || false;
                document.getElementById("editCanteen").checked = formData.querySelector('input[name="Canteen"]')?.checked || false;
                document.getElementById("editDieuhoa").checked = formData.querySelector('input[name="Dieuhoa"]')?.checked || false;

                const phanloaiValue = formData.querySelector('select[name="phanloai"]')?.value || "";
                document.getElementById("editPhanloai").value = phanloaiValue;

                const currentAnh360 = formData.querySelector('input[name="currentAnh360"]')?.value || "";
                document.getElementById("editCurrentAnh360").value = currentAnh360;
                document.getElementById("editAnh360Path").value = currentAnh360;

                const currentImageDiv = document.getElementById("editCurrentImage");
                if (currentAnh360) {
                  currentImageDiv.innerHTML = `
                    <p class="mb-1"><small>·∫¢nh hi·ªán t·∫°i:</small></p>
                    <a href="${currentAnh360}" target="_blank" class="btn btn-sm btn-outline-info">
                      <i class="bi bi-image"></i> Xem ·∫£nh hi·ªán t·∫°i
                    </a>
                  `;
                } else {
                  currentImageDiv.innerHTML = "";
                }
              } else {
                // N·∫øu c√≥ API JSON, s·ª≠ d·ª•ng n√≥
                const data = await response.json();
                if (data.success && data.library) {
                  const lib = data.library;
                  document.getElementById("editLibraryId").value = lib.id_thuvien;
                  document.getElementById("editLibraryIdDisplay").value = lib.id_thuvien;
                  document.getElementById("editTenThuvien").value = lib.ten_thuvien || "";
                  document.getElementById("editDiaChi").value = lib.dia_chi || "";
                  document.getElementById("editLatitude").value = lib.latitude || "";
                  document.getElementById("editLongitude").value = lib.longitude || "";

                  document.getElementById("editWifi").checked = lib.wifi || false;
                  document.getElementById("editPhongdoc").checked = lib.phongdoc || false;
                  document.getElementById("editCanteen").checked = lib.canteen || false;
                  document.getElementById("editDieuhoa").checked = lib.dieuhoa || false;

                  document.getElementById("editPhanloai").value = lib.phanloai || "";

                  const currentAnh360 = lib.anh_360 || "";
                  document.getElementById("editCurrentAnh360").value = currentAnh360;
                  document.getElementById("editAnh360Path").value = currentAnh360;

                  const currentImageDiv = document.getElementById("editCurrentImage");
                  if (currentAnh360) {
                    currentImageDiv.innerHTML = `
                      <p class="mb-1"><small>·∫¢nh hi·ªán t·∫°i:</small></p>
                      <a href="${currentAnh360}" target="_blank" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-image"></i> Xem ·∫£nh hi·ªán t·∫°i
                      </a>
                    `;
                  } else {
                    currentImageDiv.innerHTML = "";
                  }
                }
              }

              // Setup n√∫t "S·ª≠a chi ti·∫øt"
              document.getElementById("btnEditInPage").onclick = function() {
                modal.hide();
                window.location.href = `/admin/thu_vien/update/${libraryId}`;
              };

              // Enable form
              form.querySelectorAll("input, select, button").forEach(el => el.disabled = false);

              console.log("‚úÖ ƒê√£ load d·ªØ li·ªáu th∆∞ vi·ªán th√†nh c√¥ng");
            } catch (error) {
              console.error("‚ùå L·ªói khi load d·ªØ li·ªáu th∆∞ vi·ªán:", error);
              alert("‚ùå L·ªói khi load d·ªØ li·ªáu th∆∞ vi·ªán: " + error.message);
              bootstrap.Modal.getInstance(document.getElementById("editLibraryModal"))?.hide();
            }
          }

          // H√†m submit form s·ª≠a th∆∞ vi·ªán
          async function submitEditLibrary(event) {
            // NgƒÉn form submit m·∫∑c ƒë·ªãnh n·∫øu c√≥ event
            if (event) {
              event.preventDefault();
            }

            const form = document.getElementById("editLibraryFormModal");
            const errorDiv = document.getElementById("editErrorMessage");

            // Ki·ªÉm tra form t·ªìn t·∫°i
            if (!form) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y form editLibraryFormModal");
              if (errorDiv) {
                errorDiv.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y form";
                errorDiv.style.display = "block";
              }
              return;
            }

            // T√¨m submit button trong form
            const submitBtn = form.querySelector('button[type="submit"]') ||
                             (event && event.target) ||
                             document.querySelector('#editLibraryModal button[type="submit"]');

            if (!submitBtn) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y submit button");
              if (errorDiv) {
                errorDiv.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y n√∫t submit";
                errorDiv.style.display = "block";
              }
              return;
            }

            const originalBtnText = submitBtn.innerHTML;

            errorDiv.style.display = "none";
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang c·∫≠p nh·∫≠t...';

            const formData = new FormData(form);
            const libraryId = formData.get("ID_thuvien");

            try {
              const response = await fetch(`/admin/thu_vien/update/${libraryId}`, {
                method: "POST",
                body: formData,
              });

              if (response.ok) {
                if (response.redirected) {
                  window.location.href = response.url;
                } else {
                  const data = await response.json();
                  if (data.success) {
                    alert("‚úÖ C·∫≠p nh·∫≠t th∆∞ vi·ªán th√†nh c√¥ng!");
                    bootstrap.Modal.getInstance(document.getElementById("editLibraryModal"))?.hide();
                    window.location.reload();
                  } else {
                    throw new Error(data.error || "C√≥ l·ªói x·∫£y ra");
                  }
                }
              } else {
                const errorText = await response.text();
                throw new Error(errorText || `HTTP error! status: ${response.status}`);
              }
            } catch (error) {
              console.error("L·ªói khi c·∫≠p nh·∫≠t:", error);
              errorDiv.textContent = `L·ªói: ${error.message}`;
              errorDiv.style.display = "block";
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalBtnText;
            }
          }

          // H√†m selectEditImage ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag ƒë·∫ßu ti√™n sau modal
          // Kh√¥ng c·∫ßn ƒë·ªãnh nghƒ©a l·∫°i ·ªü ƒë√¢y

          // H√†m handleEditImageSelection, previewEditImage v√† previewImage ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag ƒë·∫ßu ti√™n sau modal
          // Kh√¥ng c·∫ßn ƒë·ªãnh nghƒ©a l·∫°i ·ªü ƒë√¢y

          // H√†m selectImage v√† handleImageSelection ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag ƒë·∫ßu ti√™n sau modal
          // Kh√¥ng c·∫ßn ƒë·ªãnh nghƒ©a l·∫°i ·ªü ƒë√¢y

          function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add("border-primary");
          }
          function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove("border-primary");
          }
          function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove("border-primary");
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              const file = files[0];
              if (file.type.startsWith("image/")) {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                const fileInput = document.getElementById("Anh360");
                fileInput.files = dataTransfer.files;
                handleImageSelection(fileInput);
              } else {
                alert("Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh!");
              }
            }
          }

          window.loadLibraryBooks = async function loadLibraryBooks(libraryId) {
            const content = document.getElementById("booksContent");
            if (!content) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y booksContent element");
              return;
            }

            // Validate libraryId tr∆∞·ªõc khi g·ªçi API
            if (!libraryId || libraryId === "" || libraryId === "undefined" || libraryId === "null") {
              console.error("‚ùå Library ID kh√¥ng h·ª£p l·ªá:", libraryId);
              content.innerHTML = `
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>L·ªói:</strong> ID th∆∞ vi·ªán kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn th∆∞ vi·ªán h·ª£p l·ªá.
                </div>
              `;
              return;
            }

            // Ki·ªÉm tra n·∫øu libraryId l√† s·ªë h·ª£p l·ªá
            const idNum = parseInt(libraryId);
            if (isNaN(idNum)) {
              console.error("‚ùå Library ID kh√¥ng ph·∫£i l√† s·ªë:", libraryId);
              content.innerHTML = `
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>L·ªói:</strong> ID th∆∞ vi·ªán kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn th∆∞ vi·ªán h·ª£p l·ªá.
                </div>
              `;
              return;
            }

            try {
              console.log("üìö B·∫Øt ƒë·∫ßu load s√°ch cho th∆∞ vi·ªán ID:", libraryId);

              content.innerHTML = `
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                  </div>
                  <p class="mt-3 text-muted">ƒêang t·∫£i s√°ch th∆∞ vi·ªán...</p>
                </div>
              `;

              const url = `/admin/thu_vien/books/${idNum}`;
              console.log("üì° G·ªçi API:", url);

              const response = await fetch(url);
              console.log("üì• Response status:", response.status);
              console.log("üì• Response ok:", response.ok);

              // ƒê·ªçc response body m·ªôt l·∫ßn duy nh·∫•t
              let responseData;
              const contentType = response.headers.get("content-type") || "";

              if (contentType.includes("application/json")) {
                responseData = await response.json();
              } else {
                const textData = await response.text();
                try {
                  responseData = JSON.parse(textData);
                } catch (e) {
                  responseData = { error: textData };
                }
              }

              // Ki·ªÉm tra status code sau khi ƒë√£ ƒë·ªçc
              if (!response.ok) {
                const errorMessage =
                  responseData.error ||
                  responseData.message ||
                  `HTTP ${response.status}`;
                throw new Error(errorMessage);
              }

              const data = responseData;
              console.log("üì• Response data:", data);

              // Ki·ªÉm tra success
              if (data.success) {
                console.log("‚úÖ Load s√°ch th√†nh c√¥ng, s·ªë l∆∞·ª£ng:", data.books?.length || 0);
                if (typeof window.renderBooksContent === "function") {
                  window.renderBooksContent(data.library, data.books || []);
                } else {
                  console.error("‚ùå renderBooksContent ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a");
                  content.innerHTML = `
                    <div class="alert alert-danger">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>L·ªói:</strong> H√†m renderBooksContent ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
                    </div>
                  `;
                }
              } else {
                console.error("‚ùå Server tr·∫£ v·ªÅ success: false", data);
                content.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>L·ªói t·ª´ server:</strong> ${data.error || data.message || "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói"}
                  </div>
                `;
              }
            } catch (error) {
              console.error("‚ùå L·ªói khi t·∫£i s√°ch:", error);
              console.error("‚ùå Error stack:", error.stack);
              content.innerHTML = `
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>L·ªói:</strong> ${error.message}
                  <br><small class="text-muted">URL: /admin/thu_vien/books/${libraryId}</small>
                  <br><button class="btn btn-sm btn-outline-danger mt-2" onclick="loadLibraryBooks(${libraryId})">
                    <i class="bi bi-arrow-clockwise me-1"></i>Th·ª≠ l·∫°i
                  </button>
                </div>
              `;
            }
          }

          window.renderBooksContent = function renderBooksContent(library, books) {
            const content = document.getElementById("booksContent");
            if (!content) {
              console.error("‚ùå Kh√¥ng t√¨m th·∫•y booksContent element trong renderBooksContent");
              return;
            }

            // ƒê·∫£m b·∫£o c√°c h√†m helper ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
            if (typeof window.escapeForTemplate !== "function" || typeof window.escapeHTML !== "function") {
              console.error("‚ùå C√°c h√†m helper escapeForTemplate ho·∫∑c escapeHTML ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a");
              content.innerHTML = `
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>L·ªói:</strong> C√°c h√†m helper ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
                </div>
              `;
              return;
            }

            const libName = window.escapeForTemplate(window.escapeHTML(library.ten_thuvien || ""));
            const libAddr = window.escapeForTemplate(window.escapeHTML(library.dia_chi || ""));
            let html = `
              <div class="row mb-3">
                <div class="col-md-8">
                  <h6><i class="bi bi-building me-2"></i>Th∆∞ vi·ªán: ${libName}</h6>
                  <p class="text-muted"><i class="bi bi-geo-alt me-2"></i>${libAddr}</p>
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-success" onclick="showAddBookModal(${library.id_thuvien})">
                    <i class="bi bi-plus-circle me-2"></i>Th√™m s√°ch
                  </button>
                </div>
              </div>
            `;

            if (books.length === 0) {
              html += `
                <div class="alert alert-info text-center">
                  <i class="bi bi-info-circle me-2"></i>
                  Th∆∞ vi·ªán n√†y ch∆∞a c√≥ s√°ch n√†o. H√£y th√™m s√°ch v√†o th∆∞ vi·ªán!
                </div>
              `;
            } else {
              html += `
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>T√™n s√°ch</th>
                        <th>T√°c gi·∫£</th>
                        <th>Th·ªÉ lo·∫°i</th>
                        <th>S·ªë l∆∞·ª£ng trong th∆∞ vi·ªán</th>
                        <th>T·ªïng s·ªë l∆∞·ª£ng</th>
                        <th>Ng√†y th√™m</th>
                        <th>File s·ªë</th>
                        <th>H√†nh ƒë·ªông</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              books.forEach((book) => {
                const tenSach = window.escapeForTemplate(window.escapeHTML(book.ten_sach || ""));
                const tacGia = window.escapeForTemplate(window.escapeHTML(book.tac_gia || "Kh√¥ng c√≥"));
                const theLoai = window.escapeForTemplate(window.escapeHTML(book.ten_theloai || "Kh√¥ng c√≥"));
                const digitalFile = window.escapeForTemplate(book.digital_file || "");
                const ngayThem = new Date(book.ngay_them).toLocaleDateString("vi-VN");
                html += `
                  <tr>
                    <td>${book.id_sach}</td>
                    <td><strong>${tenSach}</strong></td>
                    <td>${tacGia}</td>
                    <td>${theLoai}</td>
                    <td>
                      <div class="input-group input-group-sm" style="width: 120px;">
                        <input type="number" class="form-control" value="${book.so_luong_trong_thu_vien || book.so_luong || 0}"
                               min="0" max="${book.tongsl || 0}"
                               onchange="updateBookQuantity(${library.id_thuvien}, ${book.id_sach}, this.value)"
                        />
                        <span class="input-group-text">quy·ªÉn</span>
                      </div>
                    </td>
                    <td>${book.tongsl || 0}</td>
                    <td>${ngayThem}</td>
                    <td>
                      ${
                        book.digital_file
                          ? `<a href="${digitalFile}" target="_blank" class="btn btn-sm btn-outline-secondary">
                              <i class="bi bi-file-earmark-pdf"></i>
                            </a>`
                          : '<span class="text-muted">Kh√¥ng c√≥</span>'
                      }
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-danger" onclick="removeBookFromLibrary(${library.id_thuvien}, ${book.id_sach})">
                        <i class="bi bi-trash"></i> X√≥a
                      </button>
                    </td>
                  </tr>
                `;
              });
              html += `
                    </tbody>
                  </table>
                </div>
              `;
            }
            content.innerHTML = html;
          }

          async function removeBookFromLibrary(libraryId, bookId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch n√†y kh·ªèi th∆∞ vi·ªán?\n\nL∆∞u √Ω: S·ªë l∆∞·ª£ng s√°ch s·∫Ω ƒë∆∞·ª£c tr·∫£ l·∫°i v√†o kho.")) {
              return;
            }
            try {
              console.log("üóëÔ∏è ƒêang x√≥a s√°ch kh·ªèi th∆∞ vi·ªán:", { libraryId, bookId });
              const response = await fetch(
                `/admin/thu_vien/books/${libraryId}/remove/${bookId}`,
                {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json"
                  }
                }
              );

              // ƒê·ªçc response body m·ªôt l·∫ßn duy nh·∫•t
              let responseData;
              const contentType = response.headers.get("content-type") || "";

              if (contentType.includes("application/json")) {
                responseData = await response.json();
              } else {
                const textData = await response.text();
                try {
                  responseData = JSON.parse(textData);
                } catch (e) {
                  responseData = { error: textData };
                }
              }

              if (!response.ok) {
                const errorText =
                  responseData.error ||
                  responseData.message ||
                  `HTTP ${response.status}`;
                throw new Error(`HTTP ${response.status}: ${errorText}`);
              }

              const data = responseData;
              if (data.success) {
                alert("‚úÖ " + (data.message || "ƒê√£ x√≥a s√°ch kh·ªèi th∆∞ vi·ªán!"));
                await loadLibraryBooks(libraryId);
              } else {
                alert("‚ùå L·ªói: " + (data.error || "Kh√¥ng th·ªÉ x√≥a s√°ch"));
                console.error("L·ªói x√≥a s√°ch:", data);
              }
            } catch (error) {
              console.error("‚ùå L·ªói khi x√≥a s√°ch:", error);
              alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
            }
          }

          async function showAddBookModal(libraryId) {
            document.getElementById("addBookModalLabel")?.innerHTML =
      `<i class="bi bi-plus-circle me-2"></i>Th√™m s√°ch v√†o th∆∞ vi·ªán`;

            const addBookModal = new bootstrap.Modal(
              document.getElementById("addBookModal") || document.getElementById("addBookToLibraryModal")
            );
            addBookModal.show();
            await loadAvailableBooks(libraryId);
          }

          async function loadAvailableBooks(libraryId) {
            const content = document.getElementById("addBookContent");
            if (!content) return;
            try {
              content.innerHTML = `
                <div class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                  </div>
                </div>
              `;
              const response = await fetch(
                `/admin/thu_vien/books/${libraryId}/available`
              );
              const data = await response.json();
              if (data.success) {
                renderAvailableBooks(libraryId, data.books);
              } else {
                content.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>L·ªói:</strong> ${data.error || "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói"}
                  </div>
                `;
              }
            } catch (error) {
              console.error("L·ªói khi t·∫£i s√°ch c√≥ s·∫µn:", error);
              content.innerHTML = `
                <div class="alert alert-danger">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>L·ªói k·∫øt n·ªëi:</strong> ${error.message}
                  <br><small>Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt l·ªói</small>
                </div>
              `;
            }
          }

          function renderAvailableBooks(libraryId, books) {
            const content = document.getElementById("addBookContent");
            if (!content) return;
            let html = `
              <div class="row mb-3">
                <div class="col-12">
                  <h6><i class="bi bi-book me-2"></i>Ch·ªçn s√°ch ƒë·ªÉ th√™m v√†o th∆∞ vi·ªán</h6>
                  <p class="text-muted">Ch·ªçn s√°ch t·ª´ danh s√°ch d∆∞·ªõi ƒë√¢y v√† nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën th√™m</p>
                </div>
              </div>
            `;
            if (books.length === 0) {
              html += `
                <div class="alert alert-info text-center">
                  <i class="bi bi-info-circle me-2"></i>
                  T·∫•t c·∫£ s√°ch ƒë√£ ƒë∆∞·ª£c th√™m v√†o th∆∞ vi·ªán n√†y ho·∫∑c kh√¥ng c√≤n s√°ch n√†o c√≥ th·ªÉ th√™m
                </div>
              `;
            } else {
              html += `
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>Ch·ªçn</th>
                        <th>ID</th>
                        <th>T√™n s√°ch</th>
                        <th>T√°c gi·∫£</th>
                        <th>Th·ªÉ lo·∫°i</th>
                        <th>T·ªïng s·ªë l∆∞·ª£ng</th>
                        <th>ƒê√£ ph√¢n b·ªë</th>
                        <th>C√≥ th·ªÉ th√™m</th>
                        <th>S·ªë l∆∞·ª£ng th√™m</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              books.forEach((book) => {
                const tenSach = escapeForTemplate(escapeHTML(book.ten_sach || ""));
                const tacGia = escapeForTemplate(escapeHTML(book.tac_gia || "Kh√¥ng c√≥"));
                const theLoai = escapeForTemplate(escapeHTML(book.ten_theloai || "Kh√¥ng c√≥"));
                const soLuongDaPhanBo = book.so_luong_da_phan_bo || 0;
                const coTheThem = book.tongsl - soLuongDaPhanBo;
                html += `
                  <tr>
                    <td>
                      <input type="checkbox" class="form-check-input" value="${book.id_sach}"
                             onchange="toggleBookSelection(${book.id_sach}, this.checked, ${coTheThem})">
                    </td>
                    <td>${book.id_sach}</td>
                    <td><strong>${tenSach}</strong></td>
                    <td>${tacGia}</td>
                    <td>${theLoai}</td>
                    <td>${book.tongsl || 0}</td>
                    <td>
                      <span class="badge bg-warning">${soLuongDaPhanBo}</span>
                    </td>
                    <td>
                      <span class="badge bg-success">${coTheThem}</span>
                    </td>
                    <td>
                      <input type="number" class="form-control form-control-sm"
                             id="quantity_${book.id_sach}"
                             min="1" max="${coTheThem}"
                             value="1" disabled>
                    </td>
                  </tr>
                `;
              });
              html += `
                    </tbody>
                  </table>
                </div>
                <div class="text-end mt-3">
                  <button class="btn btn-success" onclick="addSelectedBooks(${libraryId})">
                    <i class="bi bi-plus-circle me-2"></i>Th√™m s√°ch ƒë√£ ch·ªçn
                  </button>
                </div>
              `;
            }
            content.innerHTML = html;
          }

          function toggleBookSelection(bookId, isChecked, maxQuantity) {
            const quantityInput = document.getElementById(`quantity_${bookId}`);
            quantityInput.disabled = !isChecked;
            if (!isChecked) {
              quantityInput.value = 1;
            } else {
              quantityInput.max = maxQuantity;
              quantityInput.value = Math.min(1, maxQuantity);
            }
          }

          async function addSelectedBooks(libraryId) {
            const selectedBooks = [];
            const checkboxes = document.querySelectorAll(
              'input[type="checkbox"]:checked'
            );
            if (checkboxes.length === 0) {
              alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s√°ch!");
              return;
            }
            for (const checkbox of checkboxes) {
              const bookId = checkbox.value;
              const quantity = document.getElementById(`quantity_${bookId}`).value;
              selectedBooks.push({ bookId, quantity: parseInt(quantity) });
            }
            try {
              for (const book of selectedBooks) {
                const response = await fetch(
                  `/admin/thu_vien/books/${libraryId}/add`,
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sach_id: book.bookId, so_luong: book.quantity }),
                  }
                );
                const data = await response.json();
                if (!data.success) {
                  throw new Error(data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
                }
              }
              alert("ƒê√£ th√™m s√°ch v√†o th∆∞ vi·ªán th√†nh c√¥ng!");
              const addBookModal = bootstrap.Modal.getInstance(
                document.getElementById("addBookModal") || document.getElementById("addBookToLibraryModal")
              );
              addBookModal?.hide();
              await loadLibraryBooks(libraryId);
            } catch (error) {
              console.error("L·ªói khi th√™m s√°ch:", error);
              alert("L·ªói: " + error.message);
            }
          }

          async function updateBookQuantity(libraryId, bookId, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (isNaN(quantity) || quantity < 0) {
              alert("‚ùå S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
              // Reload ƒë·ªÉ reset gi√° tr·ªã
              await loadLibraryBooks(libraryId);
              return;
            }

            try {
              console.log("üìù ƒêang c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", { libraryId, bookId, quantity });
              const response = await fetch(
                `/admin/thu_vien/books/${libraryId}/update/${bookId}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ so_luong: quantity }),
                }
              );

              // ƒê·ªçc response body m·ªôt l·∫ßn duy nh·∫•t
              let responseData;
              const contentType = response.headers.get("content-type") || "";

              if (contentType.includes("application/json")) {
                responseData = await response.json();
              } else {
                const textData = await response.text();
                try {
                  responseData = JSON.parse(textData);
                } catch (e) {
                  responseData = { error: textData };
                }
              }

              if (!response.ok) {
                const errorText =
                  responseData.error ||
                  responseData.message ||
                  `HTTP ${response.status}`;
                throw new Error(`HTTP ${response.status}: ${errorText}`);
              }

              const data = responseData;
              if (data.success) {
                console.log("‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh c√¥ng");
                // C√≥ th·ªÉ reload ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë·ªìng b·ªô
                await loadLibraryBooks(libraryId);
              } else {
                alert("‚ùå L·ªói: " + (data.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng"));
                console.error("L·ªói c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", data);
                // Reload ƒë·ªÉ reset gi√° tr·ªã
                await loadLibraryBooks(libraryId);
              }
            } catch (error) {
              console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", error);
              alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
              // Reload ƒë·ªÉ reset gi√° tr·ªã
              await loadLibraryBooks(libraryId);
            }
          }

          // ===== C√ÅC H√ÄM KH√ÅC =====
          // L∆∞u √Ω: window.loadAllBooks v√† window.testLoadBooksAPI ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag sau modal

          // H√†m load s√°ch c√≥ s·∫µn cho th∆∞ vi·ªán c·ª• th·ªÉ (gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch)
          async function loadBooksForLibrary(libraryId) {
            try {
              const bookSelect = document.getElementById("selectBook");
              bookSelect.innerHTML = '<option value="">-- ƒêang t·∫£i s√°ch... --</option>';
              const response = await fetch(`/admin/thu_vien/books/available/${libraryId}`);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              const data = await response.json();
              bookSelect.innerHTML = '<option value="">-- Ch·ªçn s√°ch --</option>';
              if (data.success && data.books && data.books.length > 0) {
                data.books.forEach((book) => {
                  const option = document.createElement("option");
                  option.value = book.id_sach;
                  option.textContent = `${book.ten_sach} - ${book.tac_gia} (C√≤n l·∫°i: ${book.slton})`;
                  option.dataset.available = book.slton;
                  bookSelect.appendChild(option);
                });
              } else {
                const option = document.createElement("option");
                option.value = "";
                option.textContent = "-- Kh√¥ng c√≥ s√°ch n√†o --";
                option.disabled = true;
                bookSelect.appendChild(option);
              }
            } catch (error) {
              console.error("L·ªói khi load s√°ch:", error);
              const bookSelect = document.getElementById("selectBook");
              bookSelect.innerHTML = '<option value="">-- L·ªói khi t·∫£i s√°ch --</option>';
              alert("C√≥ l·ªói x·∫£y ra khi load danh s√°ch s√°ch: " + error.message);
            }
          }

          // H√†m addBookToLibrary ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag ƒë·∫ßu ti√™n sau modal
          // Kh√¥ng c·∫ßn ƒë·ªãnh nghƒ©a l·∫°i ·ªü ƒë√¢y

          function viewLibraryBooks(libraryId) {
            window.open(`/admin/thu_vien/books/${libraryId}`, "_blank");
          }

          // Utilities: escape to keep dynamic values safe inside template literals
          window.escapeForTemplate = function escapeForTemplate(value) {
            const str = String(value ?? "");
            return str
              .replace(/`/g, "\\`")
              .replace(/\$\{/g, "\\${");
          };
          window.escapeHTML = function escapeHTML(value) {
            const str = String(value ?? "");
            return str
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#39;");
          };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- Script ƒë·∫£m b·∫£o Bootstrap modal events ho·∫°t ƒë·ªông -->
    <script>
      // H√†m loadAllBooks ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag sau modal
      // Script n√†y ch·ªâ ƒë·∫£m b·∫£o Bootstrap ƒë√£ load v√† g·∫Øn th√™m event listener n·∫øu c·∫ßn
      (function () {
        function setupModalEvents() {
          // Ki·ªÉm tra Bootstrap
          if (typeof bootstrap === "undefined") {
            console.warn("‚ö†Ô∏è Bootstrap ch∆∞a load, s·∫Ω th·ª≠ l·∫°i sau 500ms");
            setTimeout(setupModalEvents, 500);
            return;
          }

          // Ki·ªÉm tra h√†m loadAllBooks (ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a s·ªõm)
          if (typeof window.loadAllBooks !== "function") {
            console.error(
              "‚ùå H√†m loadAllBooks kh√¥ng t·ªìn t·∫°i! C√≥ th·ªÉ script ch∆∞a load."
            );
            // Kh√¥ng retry v√¨ h√†m ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong script tag tr∆∞·ªõc ƒë√≥
            return;
          }

          console.log("‚úÖ Bootstrap v√† loadAllBooks ƒë√£ s·∫µn s√†ng");

          // Event listener ƒë√£ ƒë∆∞·ª£c g·∫Øn trong script tag ƒë·∫ßu ti√™n (d√≤ng 790)
          // Kh√¥ng c·∫ßn g·∫Øn l·∫°i ·ªü ƒë√¢y ƒë·ªÉ tr√°nh duplicate
          console.log(
            "‚úÖ Bootstrap ƒë√£ s·∫µn s√†ng - Event listener ƒë√£ ƒë∆∞·ª£c g·∫Øn trong script tag ƒë·∫ßu ti√™n"
          );
        }

        // Ch·∫°y sau khi DOM ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setupModalEvents);
        } else {
          setupModalEvents();
        }
      })();

      // Event delegation ƒë√£ ƒë∆∞·ª£c setup trong script tag ƒë·∫ßu ti√™n
      // Kh√¥ng c·∫ßn setup l·∫°i ·ªü ƒë√¢y
    </script>
  </body>
</html>
