<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω S√°ch</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/sach.css" />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
          <a class="navbar-brand" href="/admin">
            <i class="bi bi-book me-2"></i>Qu·∫£n l√Ω S√°ch
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navMain"
            aria-controls="navMain"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/admin">
                  <i class="bi bi-house-door me-1"></i>Trang ch·ªß
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/thu_vien">
                  <i class="bi bi-building me-1"></i>Th∆∞ vi·ªán
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/the_loai">
                  <i class="bi bi-tags me-1"></i>Th·ªÉ lo·∫°i
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/admin/sach">
                  <i class="bi bi-book me-1"></i>S√°ch
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/muon_sach">
                  <i class="bi bi-journal-text me-1"></i>M∆∞·ª£n s√°ch
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/admin/don_hang">
                  <i class="bi bi-cart-check me-1"></i>ƒê∆°n h√†ng
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/shop">
                  <i class="bi bi-shop me-1"></i>C·ª≠a h√†ng
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/">
                  <i class="bi bi-geo-alt-fill me-1"></i>Xem b·∫£n ƒë·ªì
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container py-4">
      <!-- Error and Success Messages -->
      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <%= error %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %> <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <%= success %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %>

      <!-- Form th√™m s√°ch -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>Th√™m S√°ch M·ªõi
          </h5>
        </div>
        <div class="card-body">
          <form
            name="addSach"
            action="/admin/sach/add"
            method="POST"
            onsubmit="return validateForm()"
            enctype="multipart/form-data"
          >
            <div class="row g-3">
              <div class="col-md-4">
                <label for="ID_sach" class="form-label">ID S√°ch</label>
                <input
                  type="number"
                  name="ID_sach"
                  id="ID_sach"
                  class="form-control"
                  placeholder="Nh·∫≠p ID s√°ch"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="Ten_sach" class="form-label">T√™n S√°ch</label>
                <input
                  type="text"
                  name="Ten_sach"
                  id="Ten_sach"
                  class="form-control"
                  placeholder="Nh·∫≠p t√™n s√°ch"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="Tac_gia" class="form-label">T√°c Gi·∫£</label>
                <input
                  type="text"
                  name="Tac_gia"
                  id="Tac_gia"
                  class="form-control"
                  placeholder="Nh·∫≠p t√°c gi·∫£"
                />
              </div>
              <div class="col-md-4">
                <label for="Nam_xuat_ban" class="form-label"
                  >NƒÉm Xu·∫•t B·∫£n</label
                >
                <input
                  type="number"
                  name="Nam_xuat_ban"
                  id="Nam_xuat_ban"
                  class="form-control"
                  placeholder="Nh·∫≠p nƒÉm xu·∫•t b·∫£n"
                />
              </div>
              <div class="col-md-4">
                <label for="ID_theloai" class="form-label">Th·ªÉ Lo·∫°i</label>
                <select
                  name="ID_theloai"
                  id="ID_theloai"
                  class="form-select"
                  required
                >
                  <option value="">Ch·ªçn th·ªÉ lo·∫°i</option>
                  <% theloai.forEach(tl => { %>
                  <option value="<%= tl.id_theloai %>">
                    <%= tl.ten_theloai %>
                  </option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4">
                <label for="tongsl" class="form-label">T·ªïng S·ªë L∆∞·ª£ng</label>
                <input
                  type="number"
                  name="tongsl"
                  id="tongsl"
                  class="form-control"
                  placeholder="Nh·∫≠p t·ªïng s·ªë l∆∞·ª£ng"
                  min="0"
                />
              </div>
              <div class="col-md-4">
                <label for="slton" class="form-label">S·ªë L∆∞·ª£ng T·ªìn</label>
                <input
                  type="number"
                  name="slton"
                  id="slton"
                  class="form-control"
                  placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªìn"
                  min="0"
                />
              </div>
              <div class="col-md-4">
                <label for="digital_file" class="form-label"
                  >File S·ªë (PDF)</label
                >
                <select
                  name="digital_file"
                  id="digital_file"
                  class="form-select"
                >
                  <option value="">Kh√¥ng ch·ªçn file</option>
                  <% pdfFiles.forEach(file => { %>
                  <option value="<%= file %>">
                    <%= file.split('/').pop() %>
                  </option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4">
                <label for="gia" class="form-label">
                  <i class="bi bi-currency-dollar"></i> Gi√° B√°n (VNƒê)
                </label>
                <input
                  type="number"
                  name="gia"
                  id="gia"
                  class="form-control"
                  placeholder="Nh·∫≠p gi√° b√°n"
                  min="0"
                  step="1000"
                />
                <small class="form-text text-muted">V√≠ d·ª•: 50000</small>
              </div>
              <div class="col-md-4">
                <label for="gia_goc" class="form-label">
                  <i class="bi bi-tag"></i> Gi√° G·ªëc (VNƒê) - T√πy ch·ªçn
                </label>
                <input
                  type="number"
                  name="gia_goc"
                  id="gia_goc"
                  class="form-control"
                  placeholder="Nh·∫≠p gi√° g·ªëc (ƒë·ªÉ hi·ªÉn th·ªã gi√° ƒë√£ gi·∫£m)"
                  min="0"
                  step="1000"
                />
                <small class="form-text text-muted"
                  >ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥ khuy·∫øn m√£i</small
                >
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-plus-circle me-2"></i>Th√™m S√°ch
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Form c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s√°ch -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-arrow-up-circle me-2"></i>C·∫≠p Nh·∫≠t S·ªë L∆∞·ª£ng S√°ch
          </h5>
        </div>
        <div class="card-body">
          <form
            name="updateQuantity"
            action="/admin/sach/update-quantity"
            method="POST"
            onsubmit="return validateQuantityForm()"
          >
            <div class="row g-3">
              <div class="col-md-6">
                <label for="sach_select" class="form-label">Ch·ªçn S√°ch</label>
                <select
                  name="sach_id"
                  id="sach_select"
                  class="form-select"
                  required
                  onchange="updateBookInfo()"
                >
                  <option value="">Ch·ªçn s√°ch c·∫ßn c·∫≠p nh·∫≠t</option>
                  <% sach.forEach(s => { %>
                  <option
                    value="<%= s.id_sach %>"
                    data-ten="<%= s.ten_sach %>"
                    data-theloai="<%= s.ten_theloai %>"
                    data-tongsl="<%= s.tongsl || 0 %>"
                    data-slton="<%= s.slton || 0 %>"
                  >
                    <%= s.ten_sach %> - <%= s.ten_theloai %> (T·ªìn: <%= s.slton
                    || 0 %>)
                  </option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-6">
                <label for="quantity_type" class="form-label"
                  >Lo·∫°i C·∫≠p Nh·∫≠t</label
                >
                <select
                  name="quantity_type"
                  id="quantity_type"
                  class="form-select"
                  required
                  onchange="updateQuantityFields()"
                >
                  <option value="">Ch·ªçn lo·∫°i c·∫≠p nh·∫≠t</option>
                  <option value="add">Th√™m s√°ch m·ªõi v·ªÅ</option>
                  <option value="set">ƒê·∫∑t l·∫°i s·ªë l∆∞·ª£ng</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="new_quantity" class="form-label">S·ªë L∆∞·ª£ng</label>
                <input
                  type="number"
                  name="new_quantity"
                  id="new_quantity"
                  class="form-control"
                  placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng"
                  min="0"
                  required
                />
                <div class="form-text" id="quantity_help">
                  Ch·ªçn s√°ch v√† lo·∫°i c·∫≠p nh·∫≠t tr∆∞·ªõc
                </div>
              </div>
              <div class="col-md-6">
                <label for="reason" class="form-label">L√Ω Do</label>
                <input
                  type="text"
                  name="reason"
                  id="reason"
                  class="form-control"
                  placeholder="V√≠ d·ª•: Nh·∫≠p s√°ch m·ªõi, Ki·ªÉm k√™, M·∫•t s√°ch..."
                />
              </div>
              <div class="col-12">
                <div
                  class="alert alert-info"
                  id="book_info"
                  style="display: none"
                >
                  <strong>Th√¥ng tin s√°ch:</strong>
                  <div id="book_details"></div>
                </div>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-arrow-up-circle me-2"></i>C·∫≠p Nh·∫≠t S·ªë L∆∞·ª£ng
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Danh s√°ch s√°ch -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Danh S√°ch S√°ch</h5>
        </div>
        <div class="card-body">
          <% if (!sach || sach.length === 0) { %>
          <div class="alert alert-info text-center">
            <h6 class="mb-2">Kh√¥ng c√≥ s√°ch n√†o trong danh s√°ch</h6>
            <p class="mb-3">B·∫£ng c√≥ th·ªÉ tr·ªëng ho·∫∑c c√≥ l·ªói k·∫øt n·ªëi database</p>
            <button onclick="testDatabase()" class="btn btn-outline-primary">
              <i class="bi bi-database me-2"></i>Ki·ªÉm tra Database
            </button>
          </div>
          <% } else { %>
          <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>T√™n S√°ch</th>
                  <th>T√°c Gi·∫£</th>
                  <th>NƒÉm Xu·∫•t B·∫£n</th>
                  <th>Th·ªÉ Lo·∫°i</th>
                  <th>T·ªïng S·ªë L∆∞·ª£ng</th>
                  <th>S·ªë L∆∞·ª£ng T·ªìn</th>
                  <th>File S·ªë</th>
                  <th class="text-end">H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody>
                <% sach.forEach(s => { %>
                <tr>
                  <td><strong><%= s.id_sach %></strong></td>
                  <td><%= s.ten_sach %></td>
                  <td><%= s.tac_gia || 'Kh√¥ng c√≥' %></td>
                  <td><%= s.nam_xuat_ban || 'Kh√¥ng c√≥' %></td>
                  <td><%= s.ten_theloai %></td>
                  <td><%= s.tongsl || 0 %></td>
                  <td><%= s.slton || 0 %></td>
                  <td>
                    <% if (s.digital_file) { %>
                    <a
                      href="<%= s.digital_file %>"
                      target="_blank"
                      class="btn btn-sm btn-outline-secondary"
                    >
                      <i class="bi bi-file-earmark-pdf me-1"></i>T·∫£i xu·ªëng
                    </a>
                    <% } else { %>
                    <span class="text-muted">Kh√¥ng c√≥</span>
                    <% } %>
                  </td>
                  <td class="text-end">
                    <div class="action-buttons">
                      <a
                        href="/admin/sach/update/<%= s.id_sach %>"
                        class="btn-action btn-edit"
                        title="S·ª≠a th√¥ng tin s√°ch"
                      >
                        <i class="bi bi-pencil-square"></i>
                        <span>S·ª≠a</span>
                      </a>
                      <a
                        href="/admin/sach/delete/<%= s.id_sach %>"
                        class="btn-action btn-delete"
                        title="X√≥a s√°ch"
                        onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch n√†y?')"
                      >
                        <i class="bi bi-trash"></i>
                        <span>X√≥a</span>
                      </a>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <% } %>
        </div>
      </div>
    </main>

    <script>
      // Function ƒë·ªÉ test database
      async function testDatabase() {
        try {
          const response = await fetch("/admin/sach/test-data");
          const data = await response.json();

          if (data.success) {
            alert(
              `Database OK!\nB·∫£ng sach: ${data.tableExists}\nT·ªïng b·∫£n ghi: ${data.totalRecords}\nC·∫•u tr√∫c: ${data.tableStructure.length} c·ªôt`
            );
            console.log("Database test result:", data);
          } else {
            alert(`Database Error: ${data.error}`);
            console.error("Database test failed:", data);
          }
        } catch (error) {
          alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
          console.error("Test failed:", error);
        }
      }

      // Form validation
      function validateForm() {
        const tenSach = document.forms["addSach"]["Ten_sach"].value;
        const idTheLoai = document.forms["addSach"]["ID_theloai"].value;
        const namXuatBan = document.forms["addSach"]["Nam_xuat_ban"].value;
        const slton = document.forms["addSach"]["slton"].value;
        const tongsl = document.forms["addSach"]["tongsl"].value;

        if (!tenSach || !idTheLoai) {
          alert("T√™n s√°ch v√† th·ªÉ lo·∫°i l√† b·∫Øt bu·ªôc!");
          return false;
        }
        if (
          namXuatBan &&
          (namXuatBan < 0 || namXuatBan > new Date().getFullYear())
        ) {
          alert("NƒÉm xu·∫•t b·∫£n kh√¥ng h·ª£p l·ªá!");
          return false;
        }
        if ((slton && slton < 0) || (tongsl && tongsl < 0)) {
          alert("S·ªë l∆∞·ª£ng t·ªìn v√† t·ªïng s·ªë l∆∞·ª£ng ph·∫£i kh√¥ng √¢m!");
          return false;
        }
        return true;
      }

      // C·∫≠p nh·∫≠t th√¥ng tin s√°ch khi ch·ªçn
      function updateBookInfo() {
        const select = document.getElementById("sach_select");
        const bookInfo = document.getElementById("book_info");
        const bookDetails = document.getElementById("book_details");

        if (select.value) {
          const option = select.options[select.selectedIndex];
          const tenSach = option.getAttribute("data-ten");
          const theLoai = option.getAttribute("data-theloai");
          const tongSl = option.getAttribute("data-tongsl");
          const slTon = option.getAttribute("data-slton");

          bookDetails.innerHTML = `
            <strong>T√™n s√°ch:</strong> ${tenSach}<br>
            <strong>Th·ªÉ lo·∫°i:</strong> ${theLoai}<br>
            <strong>T·ªïng s·ªë l∆∞·ª£ng:</strong> ${tongSl}<br>
            <strong>S·ªë l∆∞·ª£ng t·ªìn:</strong> ${slTon}
          `;
          bookInfo.style.display = "block";
        } else {
          bookInfo.style.display = "none";
        }
      }

      // C·∫≠p nh·∫≠t tr∆∞·ªùng s·ªë l∆∞·ª£ng khi ch·ªçn lo·∫°i c·∫≠p nh·∫≠t
      function updateQuantityFields() {
        const quantityType = document.getElementById("quantity_type").value;
        const quantityHelp = document.getElementById("quantity_help");
        const newQuantityInput = document.getElementById("new_quantity");

        if (quantityType === "add") {
          quantityHelp.textContent =
            "Nh·∫≠p s·ªë l∆∞·ª£ng s√°ch m·ªõi v·ªÅ (s·∫Ω c·ªông v√†o s·ªë l∆∞·ª£ng hi·ªán t·∫°i)";
          newQuantityInput.placeholder = "V√≠ d·ª•: 5 (s·∫Ω th√™m 5 quy·ªÉn)";
        } else if (quantityType === "set") {
          quantityHelp.textContent =
            "Nh·∫≠p s·ªë l∆∞·ª£ng m·ªõi (s·∫Ω thay th·∫ø s·ªë l∆∞·ª£ng hi·ªán t·∫°i)";
          newQuantityInput.placeholder = "V√≠ d·ª•: 19 (s·∫Ω ƒë·∫∑t th√†nh 19 quy·ªÉn)";
        } else {
          quantityHelp.textContent = "Ch·ªçn s√°ch v√† lo·∫°i c·∫≠p nh·∫≠t tr∆∞·ªõc";
          newQuantityInput.placeholder = "Nh·∫≠p s·ªë l∆∞·ª£ng";
        }
      }

      // Validation cho form c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
      function validateQuantityForm() {
        console.log("üîç B·∫Øt ƒë·∫ßu validate form c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng...");

        const sachId = document.forms["updateQuantity"]["sach_id"].value;
        const quantityType =
          document.forms["updateQuantity"]["quantity_type"].value;
        const newQuantity =
          document.forms["updateQuantity"]["new_quantity"].value;
        const reason = document.forms["updateQuantity"]["reason"].value;

        console.log("üìä D·ªØ li·ªáu form:", {
          sachId,
          quantityType,
          newQuantity,
          reason,
        });

        if (!sachId || !quantityType || !newQuantity) {
          alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
          console.log("‚ùå Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc");
          return false;
        }

        if (parseInt(newQuantity) < 0) {
          alert("S·ªë l∆∞·ª£ng ph·∫£i kh√¥ng √¢m!");
          console.log("‚ùå S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");
          return false;
        }

        console.log("‚úÖ Form validation th√†nh c√¥ng");
        return true;
      }

      // Log debug info khi page load
      console.log("Page loaded successfully");
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
