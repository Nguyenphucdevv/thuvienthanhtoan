<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh To√°n - ƒê·∫∑t H√†ng</title>
    <link rel="icon" type="image/jpeg" href="/images/thuvienavt.jpg" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #48bb78;
        --text-dark: #2d3748;
        --text-light: #718096;
        --bg-light: #f7fafc;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-light);
        color: var(--text-dark);
      }

      .checkout-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 2rem 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .checkout-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
      }

      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.25rem;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .form-label {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
      }

      .form-control,
      .form-select {
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        padding: 0.75rem;
        transition: all 0.3s;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn-order {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border: none;
        padding: 1rem 3rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s;
      }

      .btn-order:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        color: white;
      }

      .order-summary {
        background: var(--bg-light);
        padding: 1.5rem;
        border-radius: 10px;
      }

      .order-item {
        padding: 1rem;
        background: white;
        border-radius: 10px;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
      }

      .order-total {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 1rem;
      }

      .payment-method {
        cursor: pointer;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        margin-bottom: 1rem;
        transition: all 0.3s;
      }

      .payment-method:hover {
        border-color: var(--primary-color);
        background: rgba(102, 126, 234, 0.05);
      }

      .payment-method.active {
        border-color: var(--primary-color);
        background: rgba(102, 126, 234, 0.1);
      }

      .payment-method input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .empty-cart {
        text-align: center;
        padding: 4rem 2rem;
      }

      .empty-cart i {
        font-size: 5rem;
        color: var(--text-light);
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="checkout-header">
      <div class="container">
        <h1><i class="bi bi-credit-card"></i> Thanh To√°n & ƒê·∫∑t H√†ng</h1>
        <p class="mb-0">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng</p>
      </div>
    </div>

    <div class="container mb-5">
      <div class="row">
        <!-- Form th√¥ng tin kh√°ch h√†ng -->
        <div class="col-lg-7">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-person-fill"></i> Th√¥ng Tin Ng∆∞·ªùi Nh·∫≠n
            </div>
            <div class="card-body">
              <form id="checkout-form">
                <div class="mb-3">
                  <label for="ten_khach_hang" class="form-label">
                    <i class="bi bi-person"></i> H·ªç v√† T√™n
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="ten_khach_hang"
                    name="ten_khach_hang"
                    placeholder="Nh·∫≠p h·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="so_dien_thoai" class="form-label">
                    <i class="bi bi-telephone"></i> S·ªë ƒêi·ªán Tho·∫°i
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="tel"
                    class="form-control"
                    id="so_dien_thoai"
                    name="so_dien_thoai"
                    placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                    pattern="[0-9]{10,11}"
                    required
                  />
                  <small class="text-muted">V√≠ d·ª•: 0912345678</small>
                </div>

                <div class="mb-3">
                  <label for="email" class="form-label">
                    <i class="bi bi-envelope"></i> Email
                  </label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    placeholder="Nh·∫≠p email (kh√¥ng b·∫Øt bu·ªôc)"
                  />
                </div>

                <div class="mb-3">
                  <label for="dia_chi" class="form-label">
                    <i class="bi bi-geo-alt"></i> ƒê·ªãa Ch·ªâ Nh·∫≠n H√†ng
                    <span class="text-danger">*</span>
                  </label>
                  <textarea
                    class="form-control"
                    id="dia_chi"
                    name="dia_chi"
                    rows="3"
                    placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt: S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë"
                    required
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label for="ghi_chu_khach" class="form-label">
                    <i class="bi bi-chat-left-text"></i> Ghi Ch√∫ (T√πy ch·ªçn)
                  </label>
                  <textarea
                    class="form-control"
                    id="ghi_chu_khach"
                    name="ghi_chu_khach"
                    rows="2"
                    placeholder="Ghi ch√∫ th√™m v·ªÅ ƒë∆°n h√†ng (giao gi·ªù h√†nh ch√≠nh, g·ªçi tr∆∞·ªõc khi giao...)"
                  ></textarea>
                </div>
              </form>
            </div>
          </div>

          <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
          <div class="card">
            <div class="card-header">
              <i class="bi bi-wallet2"></i> Ph∆∞∆°ng Th·ª©c Thanh To√°n
            </div>
            <div class="card-body">
              <div
                class="payment-method active"
                onclick="selectPayment(this, 'cod')"
              >
                <div class="d-flex align-items-center">
                  <input
                    type="radio"
                    name="phuong_thuc_thanh_toan"
                    value="Thanh to√°n khi nh·∫≠n h√†ng"
                    id="cod"
                    checked
                    class="me-3"
                  />
                  <div>
                    <strong
                      ><i class="bi bi-cash"></i> Thanh to√°n khi nh·∫≠n h√†ng
                      (COD)</strong
                    >
                    <p class="mb-0 text-muted small">
                      Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng
                    </p>
                  </div>
                </div>
              </div>

              <div class="payment-method" onclick="selectPayment(this, 'bank')">
                <div class="d-flex align-items-center">
                  <input
                    type="radio"
                    name="phuong_thuc_thanh_toan"
                    value="Chuy·ªÉn kho·∫£n ng√¢n h√†ng"
                    id="bank"
                    class="me-3"
                  />
                  <div>
                    <strong
                      ><i class="bi bi-bank"></i> Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong
                    >
                    <p class="mb-0 text-muted small">
                      Chuy·ªÉn kho·∫£n tr∆∞·ªõc khi nh·∫≠n h√†ng
                    </p>
                  </div>
                </div>
              </div>

              <div class="payment-method" onclick="selectPayment(this, 'momo')">
                <div class="d-flex align-items-center">
                  <input
                    type="radio"
                    name="phuong_thuc_thanh_toan"
                    value="V√≠ MoMo"
                    id="momo"
                    class="me-3"
                  />
                  <div>
                    <strong
                      ><i class="bi bi-wallet"></i> V√≠ ƒëi·ªán t·ª≠ MoMo</strong
                    >
                    <p class="mb-0 text-muted small">Thanh to√°n qua v√≠ MoMo</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
        <div class="col-lg-5">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-cart3"></i> ƒê∆°n H√†ng C·ªßa B·∫°n
            </div>
            <div class="card-body">
              <div id="order-summary">
                <div class="empty-cart">
                  <i class="bi bi-cart-x"></i>
                  <h5>Gi·ªè h√†ng tr·ªëng</h5>
                  <p class="text-muted">Vui l√≤ng th√™m s√°ch v√†o gi·ªè h√†ng</p>
                  <a href="/shop" class="btn btn-primary mt-3">
                    <i class="bi bi-arrow-left"></i> Quay l·∫°i c·ª≠a h√†ng
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // L·∫•y user ID t·ª´ cookie/session (l·∫•y t·ª´ t·∫•t c·∫£ localStorage keys)
      function getCurrentUserId() {
        // T√¨m key c√≥ d·∫°ng bookCart_user_XXX
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('bookCart_user_')) {
            const userId = key.replace('bookCart_user_', '');
            // Ki·ªÉm tra xem key n√†y c√≥ data kh√¥ng
            const data = localStorage.getItem(key);
            if (data && data !== '[]') {
              return userId;
            }
          }
        }
        return null;
      }

      // T·∫°o key localStorage ri√™ng cho m·ªói user
      function getCartKey() {
        const userId = getCurrentUserId();
        if (userId) {
          return `bookCart_user_${userId}`;
        }
        return 'bookCart_guest'; // Gi·ªè h√†ng cho kh√°ch (ch∆∞a ƒëƒÉng nh·∫≠p)
      }

      // Load gi·ªè h√†ng t·ª´ localStorage theo user
      let cart = JSON.parse(localStorage.getItem(getCartKey())) || [];

      // Hi·ªÉn th·ªã ƒë∆°n h√†ng
      function displayOrderSummary() {
        const orderSummary = document.getElementById("order-summary");

        if (cart.length === 0) {
          orderSummary.innerHTML = `
            <div class="empty-cart">
              <i class="bi bi-cart-x"></i>
              <h5>Gi·ªè h√†ng tr·ªëng</h5>
              <p class="text-muted">Vui l√≤ng th√™m s√°ch v√†o gi·ªè h√†ng</p>
              <a href="/shop" class="btn btn-primary mt-3">
                <i class="bi bi-arrow-left"></i> Quay l·∫°i c·ª≠a h√†ng
              </a>
            </div>
          `;
          return;
        }

        const totalAmount = cart.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );

        const itemsHtml = cart
          .map(
            (item) => `
          <div class="order-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${item.name}</h6>
                <p class="mb-0 text-muted small">
                  ${new Intl.NumberFormat("vi-VN", {
                    style: "currency",
                    currency: "VND",
                  }).format(item.price)} 
                  x ${item.quantity}
                </p>
              </div>
              <strong class="text-primary">
                ${new Intl.NumberFormat("vi-VN", {
                  style: "currency",
                  currency: "VND",
                }).format(item.price * item.quantity)}
              </strong>
            </div>
          </div>
        `
          )
          .join("");

        orderSummary.innerHTML = `
          <div class="order-summary">
            ${itemsHtml}
            <div class="order-total">
              <div class="d-flex justify-content-between align-items-center">
                <span>T·ªïng ti·ªÅn:</span>
                <span>${new Intl.NumberFormat("vi-VN", {
                  style: "currency",
                  currency: "VND",
                }).format(totalAmount)}</span>
              </div>
            </div>
            <button type="button" class="btn btn-order w-100 mt-3" onclick="submitOrder()">
              <i class="bi bi-check-circle"></i> X√°c Nh·∫≠n ƒê·∫∑t H√†ng
            </button>
            <a href="/shop" class="btn btn-outline-secondary w-100 mt-2">
              <i class="bi bi-arrow-left"></i> Quay l·∫°i c·ª≠a h√†ng
            </a>
          </div>
        `;
      }

      // Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
      function selectPayment(element, paymentType) {
        document
          .querySelectorAll(".payment-method")
          .forEach((pm) => pm.classList.remove("active"));
        element.classList.add("active");
        document.getElementById(paymentType).checked = true;
      }

      // Submit ƒë∆°n h√†ng
      async function submitOrder() {
        const form = document.getElementById("checkout-form");

        // Validate form
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        if (cart.length === 0) {
          alert("Gi·ªè h√†ng tr·ªëng!");
          return;
        }

        // L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n
        const paymentMethod = document.querySelector(
          'input[name="phuong_thuc_thanh_toan"]:checked'
        ).value;

        // N·∫øu l√† COD (Thanh to√°n khi nh·∫≠n h√†ng) ‚Üí x·ª≠ l√Ω ngay
        if (paymentMethod === "Thanh to√°n khi nh·∫≠n h√†ng") {
          await processCODOrder(form, paymentMethod);
        } else {
          // N·∫øu l√† chuy·ªÉn kho·∫£n ho·∫∑c MoMo ‚Üí hi·ªÉn th·ªã form QR v√† upload ·∫£nh
          showPaymentProofModal(form, paymentMethod);
        }
      }

      // X·ª≠ l√Ω ƒë∆°n h√†ng COD
      async function processCODOrder(form, paymentMethod) {
        const formData = new FormData(form);
        formData.append("phuong_thuc_thanh_toan", paymentMethod);
        formData.append("cart_data", JSON.stringify(cart));

        try {
          const response = await fetch("/shop/checkout", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams(formData),
          });

          const data = await response.json();

          if (data.success) {
            // X√≥a gi·ªè h√†ng theo user
            localStorage.removeItem(getCartKey());

            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            alert("üéâ " + data.message);

            // Chuy·ªÉn ƒë·∫øn trang ƒë∆°n h√†ng n·∫øu c√≥ redirect_url, n·∫øu kh√¥ng th√¨ v·ªÅ shop
            if (data.redirect_url) {
              window.location.href = data.redirect_url;
            } else {
              // M·∫∑c ƒë·ªãnh chuy·ªÉn v·ªÅ shop
              window.location.href = "/shop?success=ƒê·∫∑t h√†ng th√†nh c√¥ng!";
            }
          } else {
            alert("‚ùå L·ªói: " + data.message);
          }
        } catch (error) {
          console.error("L·ªói khi ƒë·∫∑t h√†ng:", error);
          alert("‚ùå C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i!");
        }
      }

      // Hi·ªÉn th·ªã modal QR code v√† form upload ·∫£nh minh ch·ª©ng
      async function showPaymentProofModal(form, paymentMethod) {
        // L·∫•y th√¥ng tin ƒë∆°n h√†ng tr∆∞·ªõc
        const formData = new FormData(form);
        formData.append("phuong_thuc_thanh_toan", paymentMethod);
        formData.append("cart_data", JSON.stringify(cart));

        try {
          // T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc (tr·∫°ng th√°i "Ch·ªù thanh to√°n")
          const response = await fetch("/shop/checkout", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams(formData),
          });

          const data = await response.json();

          if (data.success && data.order_id) {
            // L·∫•y QR code t·ª´ server
            let qrData = {
              qr_image: null,
              account_number: null,
              account_name: null,
              bank_name: null
            };

            try {
              const qrResponse = await fetch(`/shop/payment-qr?method=${encodeURIComponent(paymentMethod)}`, {
                headers: {
                  'Accept': 'application/json'
                }
              });
              
              // Ki·ªÉm tra response status
              if (!qrResponse.ok) {
                console.warn(`‚ö†Ô∏è QR response status: ${qrResponse.status}`);
                // Kh√¥ng throw error, ch·ªâ log v√† ti·∫øp t·ª•c
              }
              
              // Ki·ªÉm tra response c√≥ ph·∫£i JSON kh√¥ng
              const contentType = qrResponse.headers.get('content-type') || '';
              
              if (contentType.includes('application/json')) {
                // Response l√† JSON
                qrData = await qrResponse.json();
                console.log('‚úÖ ƒê√£ l·∫•y QR code:', qrData);
              } else {
                // Response kh√¥ng ph·∫£i JSON, th·ª≠ parse text
                const text = await qrResponse.text();
                console.warn('‚ö†Ô∏è Response kh√¥ng ph·∫£i JSON, content-type:', contentType);
                console.warn('‚ö†Ô∏è Response text (first 300 chars):', text.substring(0, 300));
                
                // Th·ª≠ parse JSON t·ª´ text n·∫øu c√≥ th·ªÉ
                try {
                  if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                    qrData = JSON.parse(text);
                    console.log('‚úÖ ƒê√£ parse QR code t·ª´ text:', qrData);
                  } else {
                    console.warn('‚ö†Ô∏è Response kh√¥ng ph·∫£i JSON format, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh');
                  }
                } catch (parseError) {
                  console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ parse response, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh');
                }
              }
            } catch (qrError) {
              console.error('‚ùå L·ªói khi l·∫•y QR code:', qrError);
              // D√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c QR code
              // Kh√¥ng throw error ƒë·ªÉ kh√¥ng l√†m gi√°n ƒëo·∫°n flow
              console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y QR code t·ª´ server, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh');
            }

            // Hi·ªÉn th·ªã modal v·ªõi QR code v√† form upload
            const modalHtml = `
              <div class="modal fade" id="paymentProofModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">
                        <i class="bi bi-qr-code"></i> Thanh To√°n ${paymentMethod}
                      </h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="cancelOrder(${data.order_id})"></button>
                    </div>
                    <div class="modal-body">
                      <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        Vui l√≤ng qu√©t m√£ QR v√† chuy·ªÉn kho·∫£n ƒë√∫ng s·ªë ti·ªÅn, sau ƒë√≥ upload ·∫£nh minh ch·ª©ng chuy·ªÉn kho·∫£n.
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6 text-center mb-4">
                          <h6 class="mb-3"><strong>M√£ QR Thanh To√°n</strong></h6>
                          ${qrData.qr_image ? 
                            `<img src="${qrData.qr_image}" alt="QR Code" class="img-fluid border rounded p-2" style="max-width: 300px;">` :
                            `<div class="alert alert-warning">QR Code ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng li√™n h·ªá admin.</div>`
                          }
                          ${qrData.account_number ? 
                            `<p class="mt-3 mb-0"><strong>S·ªë t√†i kho·∫£n:</strong> ${qrData.account_number}</p>` : ''
                          }
                          ${qrData.account_name ? 
                            `<p class="mb-0"><strong>Ch·ªß t√†i kho·∫£n:</strong> ${qrData.account_name}</p>` : ''
                          }
                        </div>
                        
                        <div class="col-md-6">
                          <h6 class="mb-3"><strong>Th√¥ng Tin ƒê∆°n H√†ng</strong></h6>
                          <div class="order-info p-3 bg-light rounded">
                            <p class="mb-2"><strong>M√£ ƒë∆°n h√†ng:</strong> #${data.order_id}</p>
                            <p class="mb-2"><strong>S·ªë ti·ªÅn:</strong> 
                              <span class="text-primary fw-bold fs-5">
                                ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(
                                  cart.reduce((sum, item) => sum + item.price * item.quantity, 0)
                                )}
                              </span>
                            </p>
                            <p class="mb-0"><strong>Ph∆∞∆°ng th·ª©c:</strong> ${paymentMethod}</p>
                          </div>
                        </div>
                      </div>

                      <hr>

                      <form id="payment-proof-form" enctype="multipart/form-data">
                        <input type="hidden" name="order_id" value="${data.order_id}">
                        <input type="hidden" name="payment_method" value="${paymentMethod}">
                        
                        <div class="mb-3">
                          <label for="proof_image" class="form-label">
                            <i class="bi bi-image"></i> Upload ·∫¢nh Minh Ch·ª©ng Chuy·ªÉn Kho·∫£n
                            <span class="text-danger">*</span>
                          </label>
                          <input 
                            type="file" 
                            class="form-control" 
                            id="proof_image" 
                            name="proof_image" 
                            accept="image/*" 
                            required
                            onchange="previewImage(this)"
                          >
                          <small class="text-muted">Ch·∫•p nh·∫≠n: JPG, PNG, GIF (t·ªëi ƒëa 5MB)</small>
                          <div id="image-preview" class="mt-2"></div>
                        </div>

                        <div class="mb-3">
                          <label for="payment_note" class="form-label">
                            <i class="bi bi-chat-left-text"></i> Ghi Ch√∫ (T√πy ch·ªçn)
                          </label>
                          <textarea 
                            class="form-control" 
                            id="payment_note" 
                            name="payment_note" 
                            rows="2"
                            placeholder="Ghi ch√∫ th√™m v·ªÅ giao d·ªãch chuy·ªÉn kho·∫£n..."
                          ></textarea>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelOrder(${data.order_id})">
                        <i class="bi bi-x-circle"></i> H·ªßy ƒê∆°n H√†ng
                      </button>
                      <button type="button" class="btn btn-primary" onclick="submitPaymentProof(${data.order_id})">
                        <i class="bi bi-check-circle"></i> G·ª≠i Minh Ch·ª©ng
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;

            // Th√™m modal v√†o body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Hi·ªÉn th·ªã modal
            const modal = new bootstrap.Modal(document.getElementById('paymentProofModal'));
            modal.show();

            // X√≥a modal khi ƒë√≥ng
            document.getElementById('paymentProofModal').addEventListener('hidden.bs.modal', function () {
              this.remove();
            });

          } else {
            alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng"));
          }
        } catch (error) {
          console.error("L·ªói khi t·∫°o ƒë∆°n h√†ng:", error);
          alert("‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!");
        }
      }

      // Preview ·∫£nh tr∆∞·ªõc khi upload
      function previewImage(input) {
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'img-thumbnail';
            img.style.maxWidth = '300px';
            img.style.maxHeight = '300px';
            preview.appendChild(img);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // G·ª≠i ·∫£nh minh ch·ª©ng
      async function submitPaymentProof(orderId) {
        const form = document.getElementById('payment-proof-form');
        const proofImage = document.getElementById('proof_image').files[0];

        if (!proofImage) {
          alert('Vui l√≤ng ch·ªçn ·∫£nh minh ch·ª©ng chuy·ªÉn kho·∫£n!');
          return;
        }

        // T·∫°o FormData t·ª´ form (ƒë√£ bao g·ªìm t·∫•t c·∫£ c√°c field)
        const formData = new FormData(form);
        // KH√îNG append th√™m proof_image v√¨ FormData t·ª´ form ƒë√£ c√≥ s·∫µn r·ªìi

        try {
          const response = await fetch('/shop/upload-payment-proof', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            // X√≥a gi·ªè h√†ng theo user
            localStorage.removeItem(getCartKey());

            // ƒê√≥ng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentProofModal'));
            modal.hide();

            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            alert('‚úÖ ƒê√£ g·ª≠i ·∫£nh minh ch·ª©ng th√†nh c√¥ng! Admin s·∫Ω x√°c nh·∫≠n ƒë∆°n h√†ng c·ªßa b·∫°n s·ªõm.');

            // Chuy·ªÉn v·ªÅ shop
            window.location.href = '/shop?success=ƒê√£ g·ª≠i ·∫£nh minh ch·ª©ng th√†nh c√¥ng!';
          } else {
            alert('‚ùå L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ upload ·∫£nh minh ch·ª©ng'));
          }
        } catch (error) {
          console.error('L·ªói khi upload ·∫£nh minh ch·ª©ng:', error);
          alert('‚ùå C√≥ l·ªói x·∫£y ra khi upload ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!');
        }
      }

      // H·ªßy ƒë∆°n h√†ng
      async function cancelOrder(orderId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) {
          try {
            const response = await fetch(`/shop/cancel-order/${orderId}`, {
              method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
              alert('ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!');
              window.location.href = '/shop';
            } else {
              alert('‚ùå L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng'));
            }
          } catch (error) {
            console.error('L·ªói khi h·ªßy ƒë∆°n h√†ng:', error);
            alert('‚ùå C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng.');
          }
        }
      }

      // Kh·ªüi t·∫°o
      document.addEventListener("DOMContentLoaded", function () {
        displayOrderSummary();
      });
    </script>
  </body>
</html>
